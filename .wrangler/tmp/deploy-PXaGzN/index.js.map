{
  "version": 3,
  "sources": ["../../../src/types.ts", "../../../shared/taxonomy.ts", "../../../src/detection.ts", "../../../src/helpers.ts", "../../../src/prompt.ts", "../../../src/rag.ts", "../../../src/governance.ts", "../../../src/routes.ts", "../../../src/index.ts"],
  "sourceRoot": "C:\\Users\\aminh\\Desktop\\Tiktak Pro\\tiktak-rag-worker\\.wrangler\\tmp\\deploy-PXaGzN",
  "sourcesContent": ["// src/types.ts \u2014 Shared types and constants for the TikTak RAG Worker\r\n\r\nexport interface Env {\r\n  AI: Ai;\r\n  TIKTAK_KB: VectorizeIndex;\r\n  TIKTAK_PLAYBOOKS: VectorizeIndex;\r\n  TIKTAK_DOCS: R2Bucket;\r\n  INTERNAL_SHARED_SECRET: string;\r\n}\r\n\r\n/* ---- Model constants ---- */\r\nexport const EMBED_MODEL = \"@cf/baai/bge-m3\";\r\nexport const CHAT_MODEL = \"@cf/meta/llama-3.1-8b-instruct-fast\";\r\n\r\n/* ---- Conversation types ---- */\r\nexport type Role = \"user\" | \"assistant\";\r\nexport type HistoryMsg = { role: Role; content: string };\r\n\r\n/* ---- Document / Playbook types ---- */\r\nexport interface DocChunk {\r\n  tenant_id: string;\r\n  doc_id: string;\r\n  chunk_id: string;\r\n  module: string;\r\n  text: string;\r\n}\r\n\r\nexport type PlaybookStep =\r\n  | { kind: \"ask\"; title?: string; question: string; field?: string; options?: string[] }\r\n  | {\r\n      kind: \"solve\";\r\n      title?: string;\r\n      response: string;\r\n      ui?: {\r\n        label: string;\r\n        route: string;\r\n        highlight?: string;\r\n      };\r\n      common_errors?: string[];\r\n      common_fixes?: string[];\r\n    }\r\n  | { kind: \"escalate\"; title?: string; reason: string };\r\n\r\nexport interface Playbook {\r\n  id: string;\r\n  title?: string;\r\n  scope?: string;\r\n  description?: string;\r\n  version?: string;\r\n  triggers?: string[];\r\n  steps: PlaybookStep[];\r\n  common_errors?: Array<{ symptom: string; cause: string; solution: string }>;\r\n  diagnostic_checklist?: any;\r\n  scanner_setup?: Record<string, string>;\r\n  best_practices?: string[];\r\n  related_playbooks?: string[];\r\n}\r\n\r\nexport interface PlaybookIngestItem {\r\n  tenant_id: string;\r\n  playbook_id: string;\r\n  module: string;\r\n  text: string;\r\n  playbook: Playbook;\r\n}\r\n\r\n/* ---- Chat state (multi-turn clarify flows) ---- */\r\nexport type ChatState = {\r\n  waiting_for?: \"domain\" | \"error_message\" | \"order_id\" | \"screenshot\" | null;\r\n  original_question?: string;\r\n  clarify_count?: number;\r\n} | null;\r\n\r\n/* ---- Retrieval types ---- */\r\nexport interface RetrievalContext {\r\n  text: string;\r\n  items: Array<{ id: string; text: string; score: number; module: string }>;\r\n  matches: any[];\r\n  avgScore: number;\r\n  topScore: number;\r\n}\r\n\r\nexport type ExtractedEntities = {\r\n  url?: string;\r\n  domain?: string;\r\n  order_id?: string;\r\n  sku_or_product?: string;\r\n  payment_method?: string;\r\n  error_message?: string;\r\n};\r\n", "// shared/taxonomy.ts\n// Canonical routing subjects used across the worker.\n// Keep this list in sync with playbook \"scope\" values and routing evaluation labels.\n//\n// IMPORTANT:\n// - Only CANONICAL modules live in SUJETS.\n// - Aliases are accepted as input via normalizeSujet(), but output is always canonical.\n\nexport const SUJETS = [\n  // fallback\n  \"general\",\n  \"unclear\",\n\n  // canonical modules\n  \"domains\",\n  \"builder\",\n  \"settings\",\n  \"apps\",\n  \"orders\",\n  \"products\",\n  \"inventory\",\n  \"shipping\",\n  \"checkout\",\n  \"payments\",\n  \"billing\",\n  \"customers\",\n  \"pos\",\n  \"auth\",\n  \"support\",\n  \"notifications\",\n  \"technical\",\n] as const;\n\nexport type Sujet = typeof SUJETS[number];\n\n// Ticket type: keep it flexible but documented\nexport const KNOWN_TICKET_TYPES = [\"l0\", \"l1\", \"bug\", \"howto\", \"request\", \"unknown\"] as const;\nexport type TicketType = string;\n\n// Aliases \u2192 canonical\nconst ALIASES: Record<string, Sujet> = {\n  // domains\n  \"domain\": \"domains\",\n  \"domains\": \"domains\",\n  \"ssl\": \"domains\",\n  \"dns\": \"domains\",\n  \"https\": \"domains\",\n  \"certificat\": \"domains\",\n  \"certificate\": \"domains\",\n  \"cloudflare\": \"domains\",\n\n  // builder\n  \"templates\": \"builder\",\n  \"template\": \"builder\",\n  \"theme\": \"builder\",\n  \"themes\": \"builder\",\n  \"design\": \"builder\",\n  \"page\": \"builder\",\n  \"pages\": \"builder\",\n  \"navigation\": \"builder\",\n  \"menu\": \"builder\",\n  \"content\": \"builder\",\n  \"contents\": \"builder\",\n  \"cms\": \"builder\",\n  \"seo\": \"builder\",\n  \"section\": \"builder\",\n  \"sections\": \"builder\",\n  \"widget\": \"builder\",\n  \"widgets\": \"builder\",\n  \"sidebar\": \"builder\",\n  \"footer\": \"builder\",\n  \"header\": \"builder\",\n  \"drag\": \"builder\",\n  \"glisser\": \"builder\",\n  \"verrouillage\": \"builder\",\n  \"verrouill\u00E9\": \"builder\",\n  \"locked\": \"builder\",\n  \"maintenance\": \"builder\",\n  \"pr\u00E9visualisation\": \"builder\",\n  \"preview\": \"builder\",\n  \"personnaliser\": \"builder\",\n  \"couleur\": \"builder\",\n  \"couleurs\": \"builder\",\n  \"typographie\": \"builder\",\n  \"favicon\": \"builder\",\n  \"custom code\": \"builder\",\n  \"code personnalis\u00E9\": \"builder\",\n  \"r\u00E9seaux sociaux\": \"builder\",\n  \"social\": \"builder\",\n\n  // apps\n  \"api\": \"apps\",\n  \"app\": \"apps\",\n  \"apps\": \"apps\",\n  \"application\": \"apps\",\n  \"applications\": \"apps\",\n  \"modules\": \"apps\",\n  \"module\": \"apps\",\n  \"integration\": \"apps\",\n  \"integrations\": \"apps\",\n  \"webhook\": \"apps\",\n  \"webhooks\": \"apps\",\n\n  // payments / checkout / billing\n  \"payment\": \"payments\",\n  \"paiement\": \"payments\",\n  \"payments\": \"payments\",\n  \"checkout\": \"checkout\",\n  \"coupon\": \"checkout\",\n  \"coupons\": \"checkout\",\n\n  \"invoice\": \"billing\",\n  \"facture\": \"billing\",\n  \"facturation\": \"billing\",\n  \"billing\": \"billing\",\n  \"subscription\": \"billing\",\n  \"abonnement\": \"billing\",\n\n  // orders\n  \"order\": \"orders\",\n  \"orders\": \"orders\",\n  \"commande\": \"orders\",\n\n  // products / inventory\n  \"product\": \"products\",\n  \"products\": \"products\",\n  \"catalog\": \"products\",\n  \"catalogue\": \"products\",\n  \"sku\": \"products\",\n  \"category\": \"products\",\n  \"categories\": \"products\",\n  \"collection\": \"products\",\n  \"collections\": \"products\",\n\n  \"stock\": \"inventory\",\n  \"inventaire\": \"inventory\",\n  \"inventory\": \"inventory\",\n\n  // shipping\n  \"shipment\": \"shipping\",\n  \"shipping\": \"shipping\",\n  \"delivery\": \"shipping\",\n  \"livraison\": \"shipping\",\n  \"expedition\": \"shipping\",\n  \"exp\u00E9dition\": \"shipping\",\n  \"douchette\": \"shipping\",\n  \"scanner\": \"shipping\",\n  \"scan\": \"shipping\",\n  \"barcode\": \"shipping\",\n\n  // customers / pos / auth / support\n  \"customer\": \"customers\",\n  \"customers\": \"customers\",\n  \"client\": \"customers\",\n  \"utilisateur\": \"customers\",\n  \"user\": \"customers\",\n  \"compte\": \"customers\",\n\n  \"pos\": \"pos\",\n  \"caisse\": \"pos\",\n\n  \"login\": \"auth\",\n  \"connexion\": \"auth\",\n  \"password\": \"auth\",\n  \"mot de passe\": \"auth\",\n  \"otp\": \"auth\",\n\n  \"ticket\": \"support\",\n  \"tickets\": \"support\",\n  \"complaint\": \"support\",\n  \"r\u00E9clamation\": \"support\",\n  \"complaints\": \"support\",\n};\n\nexport function normalizeSujet(s: string): Sujet {\n  const x = (s || \"\").toLowerCase().trim();\n\n  if (!x) return \"general\";\n  if (ALIASES[x]) return ALIASES[x];\n\n  if ((SUJETS as readonly string[]).includes(x)) return x as Sujet;\n  return \"unclear\";\n}\n", "// src/detection.ts \u2014 Module detection, entity extraction, language detection, escalation\r\nimport type { HistoryMsg, RetrievalContext } from \"./types\";\r\nimport { normalizeSujet, type Sujet } from \"../shared/taxonomy\";\r\n\r\n/* ----------------------------- Canonical module mapping ----------------------------- */\r\n\r\nexport function canonicalModule(raw: unknown): string {\r\n  const s = String(raw ?? \"\").trim().toLowerCase();\r\n  if (!s) return \"general\";\r\n  const norm = normalizeSujet(s);\r\n  return toCoarseModule(norm);\r\n}\r\n\r\n/* ----------------------------- Coarse module mapping ----------------------------- */\r\n\r\nconst COARSE_MODULES = new Set([\r\n  \"orders\", \"products\", \"builder\", \"settings\", \"apps\", \"shipping\",\r\n  \"payments\", \"customers\", \"pos\", \"billing\", \"general\",\r\n  \"technical\", \"auth\", \"inventory\", \"notifications\",\r\n]);\r\n\r\nexport function toCoarseModule(x: unknown): Sujet {\r\n  const v = String(x ?? \"\").trim().toLowerCase();\r\n  if (!v || v === \"unclear\") return \"general\";\r\n\r\n  // If already a coarse module, keep it\r\n  if (\r\n    v === \"apps\" || v === \"builder\" || v === \"general\" || v === \"orders\" ||\r\n    v === \"products\" || v === \"settings\" || v === \"shipping\" ||\r\n    v === \"payments\" || v === \"billing\" || v === \"customers\" || v === \"pos\" ||\r\n    v === \"technical\" || v === \"auth\" || v === \"inventory\" || v === \"notifications\"\r\n  ) return v as Sujet;\r\n\r\n  // Fine-grained / legacy / synonym \u2192 coarse\r\n  const map: Record<string, Sujet> = {\r\n    // builder-ish\r\n    \"templates\": \"builder\", \"template\": \"builder\", \"content\": \"builder\",\r\n    \"contents\": \"builder\", \"cms\": \"builder\", \"pages\": \"builder\",\r\n    \"page\": \"builder\", \"navigation\": \"builder\", \"theme\": \"builder\",\r\n    \"themes\": \"builder\", \"design\": \"builder\", \"seo\": \"builder\",\r\n\r\n    // settings-ish\r\n    \"domain\": \"settings\", \"domains\": \"settings\", \"dns\": \"settings\",\r\n    \"ssl\": \"settings\", \"configuration\": \"settings\", \"config\": \"settings\",\r\n\r\n    // auth\r\n    \"auth\": \"auth\", \"login\": \"auth\", \"password\": \"auth\",\r\n    \"mot de passe\": \"auth\", \"otp\": \"auth\", \"connexion\": \"auth\",\r\n    \"authentification\": \"auth\", \"2fa\": \"auth\", \"d\u00E9connexion\": \"auth\",\r\n\r\n    // notifications\r\n    \"notifications\": \"notifications\", \"notification\": \"notifications\",\r\n    \"alerte\": \"notifications\", \"alertes\": \"notifications\",\r\n    \"email notification\": \"notifications\", \"sms\": \"notifications\",\r\n\r\n    // payments\r\n    \"payment\": \"payments\", \"paiement\": \"payments\", \"carte\": \"payments\",\r\n    \"transaction\": \"payments\", \"3ds\": \"payments\", \"stripe\": \"payments\",\r\n\r\n    // billing\r\n    \"invoice\": \"billing\", \"invoices\": \"billing\", \"facturation\": \"billing\",\r\n    \"facture\": \"billing\", \"abonnement\": \"billing\", \"subscription\": \"billing\",\r\n\r\n    // orders\r\n    \"order\": \"orders\", \"commande\": \"orders\", \"orders_management\": \"orders\",\r\n    \"checkout\": \"orders\", \"cart\": \"orders\", \"panier\": \"orders\",\r\n\r\n    // products\r\n    \"product\": \"products\", \"catalog\": \"products\", \"catalogue\": \"products\",\r\n    \"sku\": \"products\", \"category\": \"products\", \"categories\": \"products\",\r\n    \"collection\": \"products\", \"collections\": \"products\",\r\n\r\n    // inventory\r\n    \"inventory\": \"inventory\", \"inventaire\": \"inventory\",\r\n    \"stock\": \"inventory\", \"rupture\": \"inventory\", \"disponibilit\u00E9\": \"inventory\",\r\n\r\n    // shipping\r\n    \"delivery\": \"shipping\", \"carrier\": \"shipping\", \"livraison\": \"shipping\",\r\n    \"expedition\": \"shipping\", \"exp\u00E9dition\": \"shipping\", \"scanner\": \"shipping\",\r\n    \"douchette\": \"shipping\", \"scan\": \"shipping\", \"barcode\": \"shipping\",\r\n    \"manifeste\": \"shipping\", \"manifest\": \"shipping\", \"colis\": \"shipping\",\r\n    \"\u00E9tiquette\": \"shipping\", \"etiquette\": \"shipping\",\r\n\r\n    // customers\r\n    \"customer\": \"customers\", \"client\": \"customers\", \"clients\": \"customers\",\r\n    \"utilisateur\": \"customers\", \"user\": \"customers\",\r\n\r\n    // apps / integrations\r\n    \"api\": \"apps\", \"integration\": \"apps\", \"integrations\": \"apps\",\r\n    \"app\": \"apps\", \"application\": \"apps\", \"applications\": \"apps\",\r\n    \"apps_store\": \"apps\", \"module\": \"apps\", \"modules\": \"apps\",\r\n    \"webhook\": \"apps\", \"webhooks\": \"apps\", \"pixel\": \"apps\",\r\n    \"facebook\": \"apps\", \"leads\": \"apps\", \"messenger\": \"apps\",\r\n    \"tracking_automatique\": \"apps\", \"shipper\": \"apps\",\r\n\r\n    // pos\r\n    \"caisse\": \"pos\", \"point de vente\": \"pos\", \"magasin\": \"pos\", \"terminal\": \"pos\",\r\n\r\n    // technical\r\n    \"technical\": \"technical\", \"bug\": \"technical\",\r\n    \"incident\": \"technical\", \"crash\": \"technical\", \"panne\": \"technical\",\r\n\r\n    // support \u2192 general\r\n    \"support\": \"general\", \"ticket\": \"general\", \"tickets\": \"general\",\r\n    \"complaint\": \"general\", \"r\u00E9clamation\": \"general\",\r\n  };\r\n\r\n  return map[v] ?? \"general\";\r\n}\r\n\r\n/* ----------------------------- Module detection ----------------------------- */\r\n\r\n/**\r\n * TikTak-optimized keyword-based module detection.\r\n */\r\nexport function detectPreferredModule(message: string, history: HistoryMsg[]): { module: string; score: number } {\r\n  const lowerMsg = message.toLowerCase();\r\n\r\n  const moduleKeywords: Record<string, { keywords: string[]; weight: number }> = {\r\n    orders: {\r\n      keywords: [\r\n        \"commande\",\"order\",\"commandes\",\"orders\",\r\n        \"annuler commande\",\"annuler\",\"annulation\",\"remboursement\",\"rembourser\",\r\n        \"suivi commande\",\"confirmer commande\",\"\u00E9tat commande\",\"num\u00E9ro de commande\",\r\n        \"panier\",\"cart\",\"checkout\",\"code promo\",\"coupon\",\"validation commande\",\r\n        \"confirmation de commande\",\"section commande\",\"section commandes\",\r\n        \"report\u00E9\",\"report\u00E9e\",\"commande report\u00E9e\",\"commandes report\u00E9es\",\r\n        \"lcommande\",\"tet3ada\",\"matet3adech\",\"mayet3adech\",\"ntab3ou\",\"ntaba3\",\r\n      ],\r\n      weight: 1.8,\r\n    },\r\n    builder: {\r\n      keywords: [\r\n        \"template\",\"templates\",\"th\u00E8me\",\"theme\",\"design\",\"menu\",\"navigation\",\r\n        \"contenu\",\"content\",\"cms\",\"seo\",\"website builder\",\r\n        \"mise en page\",\"en-t\u00EAte\",\"header\",\"footer\",\"pied de page\",\"banni\u00E8re\",\"banner\",\"banniere\",\r\n        \"slider\",\"section\",\"bloc\",\"block\",\"\u00E9diteur\",\"editeur\",\"personnaliser\",\r\n        \"page d'accueil\",\"accueil\",\"homepage\",\r\n        \"couleur\",\"color\",\"police\",\"font\",\"fond\",\"arri\u00E8re-plan\",\"background\",\r\n        \"logo\",\"favicon\",\"image de couverture\",\"galerie\",\"carousel\",\r\n        \"popup\",\"pop-up\",\"bouton\",\"button\",\"formulaire\",\"responsive\",\r\n        \"css\",\"style\",\"apparence\",\"visuel\",\"look\",\"affichage\",\r\n        \"ajouter section\",\"modifier section\",\"supprimer section\",\r\n        \"modifier la page\",\"cr\u00E9er une page\",\"cr\u00E9er page\",\"nouvelle page\",\r\n        \"ajouter une page\",\"ajouter page\",\"supprimer la page\",\r\n        \"modifier le contenu\",\"modifier contenu\",\"modifier le texte\",\"modifier texte\",\r\n        \"sous-menu\",\"sous menu\",\"lien hypertexte\",\r\n        \"ne s'affiche pas correctement\",\"mal affich\u00E9\",\"affichage cass\u00E9\",\r\n        \"largeur\",\"taille\",\"responsive\",\"mobile\",\r\n        \"upsell\",\"cross-sell\",\"landing page\",\"landing\",\r\n        \"social media\",\"r\u00E9seaux sociaux\",\"instagram\",\"lien instagram\",\r\n        \"video banniere\",\"vid\u00E9o banni\u00E8re\",\"image cliquable\",\r\n        \"site ralenti\",\"titre\",\"bande\",\"mod\u00E8le\",\r\n        \"ldesign\",\"lpage\",\r\n      ],\r\n      weight: 2.0,\r\n    },\r\n    products: {\r\n      keywords: [\r\n        \"produit\",\"product\",\"produits\",\"products\",\r\n        \"sku\",\"r\u00E9f\u00E9rence\",\"reference\",\"catalogue\",\"catalog\",\r\n        \"variant\",\"variante\",\"collection\",\"cat\u00E9gorie\",\"categorie\",\"category\",\r\n        \"import produit\",\"export produit\",\"image produit\",\"photo produit\",\r\n        \"prix produit\",\"ajouter produit\",\"modifier produit\",\"supprimer produit\",\r\n        \"fiche produit\",\"page produit\",\r\n        \"ne s'affiche pas\",\"ne s'affichent pas\",\"n'apparait pas\",\"n'apparaissent pas\",\r\n        \"lproduit\",\"tsawer\",\"ma ytla3ch\",\"maytla3ch\",\"ma ybanch\",\"maybanch\",\r\n        \"yetl3ouli\",\"metetla3\",\r\n      ],\r\n      weight: 1.7,\r\n    },\r\n    payments: {\r\n      keywords: [\r\n        \"paiement\",\"payment\",\"carte bancaire\",\"carte\",\"cb\",\"visa\",\"mastercard\",\r\n        \"refus\u00E9 paiement\",\"refuse\",\"transaction\",\"3ds\",\"stripe\",\r\n        \"gateway\",\"passerelle\",\"tpe en ligne\",\r\n        \"lpaiement\",\"5alas\",\"5alast\",\"n5ales\",\"carta\",\"flouss\",\"mat3adech\",\r\n      ],\r\n      weight: 1.7,\r\n    },\r\n    settings: {\r\n      keywords: [\r\n        \"domaine\",\"domain\",\"dns\",\"ssl\",\"https\",\"certificat\",\"certificate\",\"cloudflare\",\"nameserver\",\"ns\",\r\n        \"erreur 403\",\"erreur 404\",\"err_\",\"net::err\",\r\n        \"hors ligne\",\r\n        \"param\u00E8tres du site\",\"configurer le site\",\"r\u00E9glages du site\",\r\n        \"langue du site\",\"configuration\",\"param\u00E8tres\",\r\n        \"lsite\",\"yatla3li\",\r\n      ],\r\n      weight: 1.5,\r\n    },\r\n    shipping: {\r\n      keywords: [\r\n        \"livraison\",\"shipping\",\"livreur\",\"exp\u00E9dition\",\"expedition\",\r\n        \"colis\",\"manifeste\",\"manifest\",\"\u00E9tiquette\",\"etiquette\",\r\n        \"douchette\",\"scanner\",\"scan\",\"barcode\",\r\n        \"suivi colis\",\"transporteur\",\"carrier\",\"retour colis\",\"ramassage\",\r\n        \"bon de livraison\",\"bordereau\",\r\n        \"llivraison\",\"ma wsltch\",\"mawsltch\",\r\n      ],\r\n      weight: 1.6,\r\n    },\r\n    billing: {\r\n      keywords: [\r\n        \"facturation\",\"billing\",\"facture\",\"invoice\",\"factures\",\r\n        \"abonnement\",\"subscription\",\"plan\",\"forfait\",\r\n        \"renouvellement\",\"upgrade\",\"downgrade\",\r\n        \"lfacture\",\r\n      ],\r\n      weight: 1.5,\r\n    },\r\n    pos: {\r\n      keywords: [\r\n        \"pos\",\"caisse\",\"caiss\",\"point de vente\",\"magasin\",\"terminal\",\"vente en magasin\",\r\n        \"caisse enregistreuse\",\"session caisse\",\"session de vente\",\r\n        \"tva\",\"total tva\",\"ticket de caisse\",\"bon de caisse\",\r\n        \"vente physique\",\"vente en boutique\",\"boutique physique\",\r\n        \"personnel\",\"gestion personnel\",\"gestion des personnels\",\r\n        \"co\u00FBt marchandise\",\"cout marchandise\",\r\n        \"facture pos\",\"factures pos\",\"facture de notre pos\",\r\n        \"lcaisse\",\"lmagasin\",\r\n      ],\r\n      weight: 1.6,\r\n    },\r\n    customers: {\r\n      keywords: [\r\n        \"fiche client\",\"compte client\",\"profil client\",\"liste client\",\r\n        \"customer\",\"customers\",\"gestion client\",\"gestion des clients\",\r\n        \"utilisateur\",\"user\",\"profil\",\"compte utilisateur\",\r\n        \"donn\u00E9es client\",\"supprimer client\",\"modifier client\",\r\n      ],\r\n      weight: 1.3,\r\n    },\r\n    apps: {\r\n      keywords: [\r\n        \"api\",\"endpoint\",\"webhook\",\"integration\",\"int\u00E9gration\",\r\n        \"developpeur\",\"developer\",\"modules\",\"module\",\"application\",\"applications\",\r\n        \"facebook pixel\",\"pixel\",\"leads facebook\",\r\n        \"pixel facebook\",\"tracking automatique\",\"conversion pixel\",\r\n        \"shipper\",\"first delivery\",\r\n      ],\r\n      weight: 1.2,\r\n    },\r\n    technical: {\r\n      keywords: [\r\n        \"erreur 500\",\"error 500\",\"erreur 502\",\"error 502\",\"erreur 503\",\"erreur 504\",\r\n        \"error 504\",\"gateway timeout\",\"internal server error\",\r\n        \"site crash\",\"crash\",\"bug\",\"site down\",\"site ne fonctionne pas\",\"site ne marche pas\",\r\n        \"page blanche\",\"page vide\",\"panne\",\"plante\",\"ne charge pas\",\r\n        \"ne s'affiche pas\",\"serveur\",\"server error\",\"500 error\",\"502 error\",\"503 error\",\"504 error\",\r\n        \"timeout\",\"ne r\u00E9pond pas\",\"ne repond pas\",\"site plant\u00E9\",\"site plante\",\r\n        \"erreur serveur\",\"erreur technique\",\"probl\u00E8me technique\",\"probleme technique\",\r\n        \"lsite ma5dimch\",\"site ma5demch\",\"lsite 5asro\",\"bug technique\",\r\n      ],\r\n      weight: 2.0,\r\n    },\r\n    auth: {\r\n      keywords: [\r\n        \"login\",\"connexion\",\"mot de passe\",\"password\",\"otp\",\"mot de pass\",\r\n        \"authentification\",\"2fa\",\"d\u00E9connexion\",\"deconnexion\",\"d\u00E9connect\u00E9\",\"deconnecte\",\r\n        \"connecter\",\"se connecter\",\"me connecter\",\"pas connecter\",\"acc\u00E8s\",\"acces\",\r\n        \"acc\u00E9der\",\"acceder\",\"identifiant\",\"identifiants\",\"r\u00E9initialiser mot de passe\",\r\n        \"reset password\",\"forgot password\",\"oubli\u00E9 mot de passe\",\r\n        \"session expir\u00E9e\",\"session expiree\",\"code otp\",\"v\u00E9rification otp\",\"verification otp\",\r\n        \"llogin\",\"lpassword\",\"lconnexion\",\r\n      ],\r\n      weight: 1.8,\r\n    },\r\n    inventory: {\r\n      keywords: [\r\n        \"stock\",\"inventaire\",\"inventory\",\"quantit\u00E9\",\"quantite\",\"disponibilit\u00E9\",\"disponibilite\",\r\n        \"rupture de stock\",\"rupture\",\"en stock\",\"hors stock\",\"out of stock\",\r\n        \"mise \u00E0 jour stock\",\"maj stock\",\"stock disponible\",\"gestion stock\",\"gestion des stocks\",\r\n        \"niveau de stock\",\"niveaux de stock\",\"ajuster stock\",\"ajustement stock\",\r\n        \"stock n\u00E9gatif\",\"stock negatif\",\"synchroniser stock\",\"sync stock\",\r\n        \"lstock\",\"linventaire\",\r\n      ],\r\n      weight: 1.6,\r\n    },\r\n    notifications: {\r\n      keywords: [\r\n        \"notification\",\"notifications\",\"email notification\",\"sms\",\"alerte\",\"alertes\",\r\n        \"webhook\",\"email automatique\",\"mail automatique\",\"notification email\",\r\n        \"notification sms\",\"notification push\",\"envoyer notification\",\"configurer notification\",\r\n        \"d\u00E9sactiver notification\",\"desactiver notification\",\"activer notification\",\r\n        \"param\u00E8tres notification\",\"notification commande\",\"notification client\",\r\n        \"email de confirmation\",\"email confirmation\",\"mail de confirmation\",\r\n        \"lnotification\",\"lnotifications\",\r\n      ],\r\n      weight: 1.4,\r\n    },\r\n    general: {\r\n      keywords: [\r\n        \"activer mon compte\",\"activation boutique\",\"activation compte\",\"activer boutique\",\r\n        \"cr\u00E9er boutique\",\"nouvelle boutique\",\"ouvrir boutique\",\"cree boutique\",\"cree nouveau boutique\",\r\n        \"changer nom boutique\",\"changement nom\",\"nom de boutique\",\"nom boutique\",\"nom de la boutique\",\"changer le nom\",\r\n        \"changer email\",\"modifier email\",\"v\u00E9rification email\",\"verification email\",\"changer l'email\",\r\n        \"team\",\"\u00E9quipe\",\"capacit\u00E9 pack\",\"pack\",\r\n        \"liaison\",\"demande de liaison\",\"confirmation de la liaison\",\"retard de confirmation\",\r\n        \"compte bloqu\u00E9\",\"compte bloquer\",\"compte bloqu\",\"blocked\",\r\n        \"duplication\",\"dupliquer\",\"duplication du site\",\r\n        \"hallt boutique\",\"halit boutique\",\"7alit boutique\",\"n7el boutique\",\r\n      ],\r\n      weight: 1.0,\r\n    },\r\n  };\r\n\r\n  const scores: Record<string, number> = {};\r\n\r\n  // Score current message\r\n  for (const [module, cfg] of Object.entries(moduleKeywords)) {\r\n    let score = 0;\r\n    for (const kw of cfg.keywords) {\r\n      if (kw && lowerMsg.includes(kw)) score += cfg.weight;\r\n    }\r\n    if (score > 0) scores[module] = score;\r\n  }\r\n\r\n  // Add decayed history signal (last 4 messages)\r\n  const recentHistory = history.slice(-4);\r\n  for (let i = 0; i < recentHistory.length; i++) {\r\n    const msg = recentHistory[i];\r\n    const lowerHist = msg.content.toLowerCase();\r\n    const decay = 0.2 * (1 - i / Math.max(1, recentHistory.length));\r\n    for (const [module, cfg] of Object.entries(moduleKeywords)) {\r\n      for (const kw of cfg.keywords) {\r\n        if (kw && lowerHist.includes(kw)) {\r\n          scores[module] = (scores[module] || 0) + (cfg.weight * decay);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Pick best\r\n  let bestModule = \"general\";\r\n  let bestScore = 0;\r\n  for (const [module, score] of Object.entries(scores)) {\r\n    if (score > bestScore) {\r\n      bestScore = score;\r\n      bestModule = module;\r\n    }\r\n  }\r\n\r\n  return { module: canonicalModule(bestModule), score: bestScore };\r\n}\r\n\r\n/* ----------------------------- Entity extraction ----------------------------- */\r\n\r\nexport function extractEntities(message: string): import(\"./types\").ExtractedEntities {\r\n  const m = message || \"\";\r\n  const out: import(\"./types\").ExtractedEntities = {};\r\n\r\n  const urlMatch = m.match(/https?:\\/\\/[^\\s]+/i);\r\n  if (urlMatch) out.url = urlMatch[0];\r\n\r\n  const domainMatch = m.match(/\\b([a-z0-9-]+\\.)+[a-z]{2,}\\b/i);\r\n  if (domainMatch) out.domain = domainMatch[0];\r\n\r\n  const orderMatch = m.match(/(?:\\border\\b|\\bcommande\\b|#)\\s*([0-9]{3,})/i);\r\n  if (orderMatch) out.order_id = orderMatch[1];\r\n\r\n  const skuMatch = m.match(/\\bSKU\\b\\s*[:#-]?\\s*([A-Z0-9_-]{3,})/i);\r\n  if (skuMatch) out.sku_or_product = skuMatch[1];\r\n  else {\r\n    const prodMatch = m.match(/(?:\\bproduit\\b|\\bproduct\\b)\\s*[:#-]?\\s*([^\\n\\r]{3,40})/i);\r\n    if (prodMatch) out.sku_or_product = prodMatch[1].trim();\r\n  }\r\n\r\n  const pm = m.match(/\\b(stripe|paypal|carte|cb|visa|mastercard|edinar|e-dinar|virement|cash|cod)\\b/i);\r\n  if (pm) out.payment_method = pm[1].toLowerCase();\r\n\r\n  const quoted = m.match(/\"([^\"]{5,140})\"/);\r\n  if (quoted) out.error_message = quoted[1];\r\n  else if (/(5\\d\\d|4\\d\\d|timeout|erreur|error|panne|failed|refus|bloqu)/i.test(m)) {\r\n    out.error_message = m.slice(0, 220);\r\n  }\r\n\r\n  return out;\r\n}\r\n\r\n/* ----------------------------- Language detection ----------------------------- */\r\n\r\nexport function detectLanguage(msg: string): \"fr\" | \"ar\" | \"darija\" | \"en\" {\r\n  const m = (msg || \"\").trim();\r\n  if (/[\\u0600-\\u06FF]/.test(m)) return \"ar\";\r\n  if (/\\b(y7el|5alas|ma5dem|matet3ada|7alit|wesh|bech|chnou|kifech|3lech|ya5i)\\b/i.test(m)) return \"darija\";\r\n  if (/\\b(the|is|are|have|this|that|with|from|what|where|when|how|please|help)\\b/i.test(m)) return \"en\";\r\n  return \"fr\";\r\n}\r\n\r\n/* ----------------------------- Hard escalation ----------------------------- */\r\n\r\nexport function checkHardEscalation(message: string): { triggered: boolean; reason: string } {\r\n  const hardPatterns: Array<{ pattern: RegExp; reason: string }> = [\r\n    { pattern: /\\b(500|502|503|504)\\s*(error|erreur)?\\b/i, reason: \"HTTP 5xx error\" },\r\n    { pattern: /\\binternal server error\\b/i, reason: \"Internal server error\" },\r\n    { pattern: /\\bservice unavailable\\b/i, reason: \"Service unavailable\" },\r\n    { pattern: /\\btimeout\\b.*\\b(error|erreur|serveur|server)\\b/i, reason: \"Server timeout\" },\r\n    { pattern: /\\berreur\\s*serveur\\b/i, reason: \"Server error\" },\r\n    { pattern: /\\bpanne\\s*(syst\u00E8me|totale|compl\u00E8te|generale)?\\b/i, reason: \"System outage\" },\r\n  ];\r\n\r\n  for (const { pattern, reason } of hardPatterns) {\r\n    if (pattern.test(message)) return { triggered: true, reason };\r\n  }\r\n\r\n  return { triggered: false, reason: \"\" };\r\n}\r\n\r\n/* ----------------------------- Greeting / Thanks detection ----------------------------- */\r\n\r\nexport function isGreetingOnly(msg: string): boolean {\r\n  const greetings = [\"salut\", \"bonjour\", \"hello\", \"hi\", \"hey\", \"salam\", \"slm\", \"bsr\", \"bonsoir\", \"cc\", \"coucou\", \"wesh\", \"\u0627\u0644\u0633\u0644\u0627\u0645\", \"\u0635\u0628\u0627\u062D\", \"\u0645\u0631\u062D\u0628\u0627\"];\r\n  const lower = msg.toLowerCase().trim();\r\n  const wordCount = lower.split(/\\s+/).length;\r\n  if (wordCount > 3) return false;\r\n  return greetings.some((g) => lower === g || lower.startsWith(g + \" \") || lower.endsWith(\" \" + g));\r\n}\r\n\r\nexport function isThanksOnly(msg: string): boolean {\r\n  const thanks = [\"merci\", \"thank\", \"thanks\", \"thx\", \"\u0634\u0643\u0631\u0627\", \"choukran\"];\r\n  const lower = msg.toLowerCase().trim();\r\n  const wordCount = lower.split(/\\s+/).length;\r\n  if (wordCount > 4) return false;\r\n  return thanks.some((t) => lower === t || lower.startsWith(t + \" \") || lower.endsWith(\" \" + t));\r\n}\r\n\r\n/* ----------------------------- Related module check ----------------------------- */\r\n\r\nexport function areModulesRelated(module1: string, module2: string): boolean {\r\n  const m1 = canonicalModule(module1);\r\n  const m2 = canonicalModule(module2);\r\n\r\n  const relatedGroups: string[][] = [\r\n    [\"shipping\", \"orders\", \"products\", \"inventory\"],\r\n    [\"orders\", \"checkout\", \"payments\"],\r\n    [\"domains\", \"settings\", \"builder\"],\r\n    [\"products\", \"inventory\", \"builder\"],\r\n    [\"billing\", \"payments\", \"settings\"],\r\n    [\"apps\", \"settings\", \"technical\"],\r\n  ];\r\n\r\n  return relatedGroups.some((group) => group.includes(m1) && group.includes(m2));\r\n}\r\n\r\n/**\r\n * Infer module from vectorize retrieval when keyword detection yielded \"general\".\r\n */\r\nexport function inferModuleFromRetrieval(\r\n  pbCtx: RetrievalContext,\r\n  docsCtx: RetrievalContext\r\n): string | null {\r\n  const moduleScores: Record<string, number> = {};\r\n\r\n  for (const item of pbCtx.items) {\r\n    const mod = canonicalModule(item.module);\r\n    if (mod && mod !== \"general\") {\r\n      moduleScores[mod] = (moduleScores[mod] || 0) + item.score * 2;\r\n    }\r\n  }\r\n\r\n  for (const item of docsCtx.items) {\r\n    const mod = canonicalModule(item.module);\r\n    if (mod && mod !== \"general\") {\r\n      moduleScores[mod] = (moduleScores[mod] || 0) + item.score;\r\n    }\r\n  }\r\n\r\n  const entries = Object.entries(moduleScores);\r\n  if (entries.length === 0) return null;\r\n\r\n  entries.sort((a, b) => b[1] - a[1]);\r\n  const [bestMod, bestScore] = entries[0];\r\n  const secondScore = entries.length > 1 ? entries[1][1] : 0;\r\n\r\n  if (bestScore > 0 && (secondScore === 0 || bestScore >= secondScore * 1.3)) {\r\n    return toCoarseModule(bestMod);\r\n  }\r\n\r\n  return null;\r\n}\r\n", "// src/helpers.ts \u2014 Shared utilities, CORS, JSON parsing, response normalization\r\nimport type { ChatState, Playbook, PlaybookStep, HistoryMsg } from \"./types\";\r\nimport { toCoarseModule } from \"./detection\";\r\n\r\n/* ----------------------------- CORS / HTTP helpers ----------------------------- */\r\n\r\nexport function corsHeaders(req: Request): Record<string, string> {\r\n  const origin = req.headers.get(\"Origin\") || \"*\";\r\n  return {\r\n    \"Access-Control-Allow-Origin\": origin,\r\n    \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS\",\r\n    \"Access-Control-Allow-Headers\": \"Content-Type, Authorization, x-internal-secret\",\r\n    \"Access-Control-Max-Age\": \"86400\",\r\n  };\r\n}\r\n\r\nexport function preflight(req: Request): Response {\r\n  return new Response(null, { status: 204, headers: corsHeaders(req) });\r\n}\r\n\r\nexport function text(req: Request, body: string, status = 200): Response {\r\n  return new Response(body, {\r\n    status,\r\n    headers: { \"Content-Type\": \"text/plain; charset=utf-8\", ...corsHeaders(req) },\r\n  });\r\n}\r\n\r\nexport function json(req: Request, data: unknown, status = 200): Response {\r\n  return new Response(JSON.stringify(data), {\r\n    status,\r\n    headers: { \"Content-Type\": \"application/json; charset=utf-8\", ...corsHeaders(req) },\r\n  });\r\n}\r\n\r\nexport function clamp01(v: number): number {\r\n  if (Number.isNaN(v)) return 0;\r\n  return Math.min(1, Math.max(0, v));\r\n}\r\n\r\n/* ----------------------------- JSON / string utilities ----------------------------- */\r\n\r\nexport async function safeReadJson(req: Request): Promise<any | null> {\r\n  try {\r\n    return await req.json();\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function toStr(x: unknown): string {\r\n  if (typeof x === \"string\") return x;\r\n  if (x == null) return \"\";\r\n  return String(x);\r\n}\r\n\r\n/* ----------------------------- UI Routing ----------------------------- */\r\n\r\nconst DASH_BASE = \"https://app.tiktak.pro\";\r\n\r\nexport const ROUTE_BY_CONTEXT: Record<string, string> = {\r\n  orders: \"/orders\",\r\n  products: \"/products\",\r\n  builder: \"/builder\",\r\n  settings: \"/settings\",\r\n  shipping: \"/shipping\",\r\n  payments: \"/payments\",\r\n  billing: \"/billing\",\r\n  pos: \"/pos\",\r\n  apps: \"/apps-store\",\r\n  customers: \"/customers\",\r\n};\r\n\r\nexport function routeFor(context: string, subRoute: string | undefined): string | null {\r\n  const base = ROUTE_BY_CONTEXT[context];\r\n  if (!base) return null;\r\n  return subRoute ? `${DASH_BASE}${base}/${subRoute}` : `${DASH_BASE}${base}`;\r\n}\r\n\r\n/** G7-FIX: Corrected UTF-8 \u2014 was \"Ouvrir l\\u2019\\u00e9cran TikTak\" (mojibake) */\r\nexport function fallbackUiLink(\r\n  context: string,\r\n  _category?: string\r\n): { label: string; route: string } | null {\r\n  const route = ROUTE_BY_CONTEXT[context];\r\n  if (!route) return null;\r\n  return { label: \"Ouvrir l'\u00E9cran TikTak\", route: `${DASH_BASE}${route}` };\r\n}\r\n\r\n/* ----------------------------- JSON block extraction ----------------------------- */\r\n\r\nexport function extractJsonBlock(raw: string): string | null {\r\n  // Try to find JSON in markdown code block first\r\n  const fenced = raw.match(/```(?:json)?\\s*\\n?([\\s\\S]*?)```/);\r\n  if (fenced) return fenced[1].trim();\r\n\r\n  // Try to find raw JSON object\r\n  const obj = raw.match(/\\{[\\s\\S]*\\}/);\r\n  if (obj) return obj[0];\r\n\r\n  return null;\r\n}\r\n\r\nexport function tryParsePlaybook(raw: string): Playbook | null {\r\n  const block = extractJsonBlock(raw);\r\n  if (!block) return null;\r\n  try {\r\n    const parsed = JSON.parse(block);\r\n    if (parsed && Array.isArray(parsed.steps)) return parsed as Playbook;\r\n  } catch { /* ignore */ }\r\n  return null;\r\n}\r\n\r\nexport function pickNextQuestionFromPlaybook(playbook: Playbook): string | null {\r\n  for (const step of playbook.steps) {\r\n    if (step.kind === \"ask\") return step.question;\r\n  }\r\n  return null;\r\n}\r\n\r\n/* ----------------------------- Chat State utilities ----------------------------- */\r\n\r\nexport function mergeFollowupIntoQuery(\r\n  message: string,\r\n  state: ChatState\r\n): { merged: string; isFollowup: boolean } {\r\n  if (!state?.waiting_for || !state?.original_question) {\r\n    return { merged: message, isFollowup: false };\r\n  }\r\n  return {\r\n    merged: `${state.original_question}\\n[R\u00E9ponse: ${message}]`,\r\n    isFollowup: true,\r\n  };\r\n}\r\n\r\nexport function setWaitingState(\r\n  prev: ChatState,\r\n  waitingFor: NonNullable<ChatState>[\"waiting_for\"],\r\n  originalQuestion: string\r\n): ChatState {\r\n  return {\r\n    waiting_for: waitingFor,\r\n    original_question: originalQuestion,\r\n    clarify_count: (prev?.clarify_count ?? 0) + 1,\r\n  };\r\n}\r\n\r\n/* ----------------------------- Signal augmentation ----------------------------- */\r\n\r\nexport function augmentSignals(base: any, extras: { message?: string } = {}) {\r\n  const urgent = extras.message\r\n    ? /\\b(urgent|asap|immediately|critique|bloqu\u00E9|stuck|imm\u00E9diatement)\\b/i.test(extras.message)\r\n    : false;\r\n\r\n  if (urgent && base.severity === \"low\") {\r\n    base.severity = \"medium\";\r\n  }\r\n\r\n  return base;\r\n}\r\n\r\n/* ----------------------------- Response normalization ----------------------------- */\r\n\r\nexport function normalizeSupportResponse(data: any): any {\r\n  const raw = data && typeof data === \"object\" ? data : {};\r\n\r\n  const modeRaw = toStr(raw?.mode || \"\");\r\n  const mode =\r\n    modeRaw === \"solve\" || modeRaw === \"escalate\" || modeRaw === \"clarify\"\r\n      ? modeRaw\r\n      : raw?.verdict === \"tiktak_side\"\r\n        ? \"escalate\"\r\n        : raw?.verdict === \"user_side\"\r\n          ? \"solve\"\r\n          : \"clarify\";\r\n\r\n  const confidence: number = typeof raw?.confidence === \"number\" ? clamp01(raw.confidence) : 0;\r\n  const contextRaw = toStr(raw?.context ?? raw?.preferredModule ?? raw?.category ?? raw?.signals?.preferredModule ?? \"\");\r\n  const preferredModule = toCoarseModule(raw?.preferredModule ?? raw?.signals?.preferredModule ?? contextRaw ?? raw?.category);\r\n  const context = preferredModule;\r\n\r\n  const ui = raw?.ui ?? null;\r\n  const actions = Array.isArray(raw?.actions) ? raw.actions : [];\r\n  const questions: string[] = Array.isArray(raw?.questions) ? raw.questions.map((q: any) => toStr(q)) : [];\r\n\r\n  let answer = typeof raw?.answer === \"string\" ? raw.answer : \"\";\r\n  if (!answer && questions.length) {\r\n    const cleaned = questions.map((q) => q.trim()).filter(Boolean);\r\n    if (cleaned.length) answer = \"J'ai besoin de pr\u00E9ciser :\\n- \" + cleaned.join(\"\\n- \");\r\n  }\r\n  if (!answer && mode === \"escalate\") {\r\n    answer = \"Je propose d'escalader ce probl\u00E8me \u00E0 l'\u00E9quipe support TikTak PRO.\";\r\n  }\r\n\r\n  const cat = toStr(raw?.category ?? \"\").toLowerCase();\r\n  const incidentCategory = [\"incident\", \"outage\", \"api_down\", \"backend_error\", \"permission_issue\", \"bug_confirmed\"].includes(cat);\r\n  const incident = Boolean(raw?.signals?.incident ?? incidentCategory);\r\n\r\n  const rawSignals = raw?.signals ?? {};\r\n  const out: any = {\r\n    mode,\r\n    answer,\r\n    signals: {\r\n      confidence: Number(confidence.toFixed(2)),\r\n      preferredModule,\r\n      incident,\r\n      severity: typeof rawSignals.severity === \"string\" ? rawSignals.severity : undefined,\r\n      category: typeof rawSignals.category === \"string\" ? rawSignals.category : undefined,\r\n      sentiment: typeof rawSignals.sentiment === \"string\" ? rawSignals.sentiment : undefined,\r\n      escalation_recommended: typeof rawSignals.escalation_recommended === \"boolean\" ? rawSignals.escalation_recommended : undefined,\r\n      strategy: typeof rawSignals.strategy === \"string\" ? rawSignals.strategy : undefined,\r\n      strategy_reason: typeof rawSignals.strategy_reason === \"string\" ? rawSignals.strategy_reason : undefined,\r\n    },\r\n    context,\r\n    ui,\r\n    actions,\r\n  };\r\n  if (Array.isArray(raw?.evidence)) out.evidence = raw.evidence;\r\n  if (typeof raw?.next_question === \"string\") out.next_question = raw.next_question;\r\n  if (typeof raw?.escalate === \"boolean\") out.escalate = raw.escalate;\r\n  if (typeof raw?.verdict === \"string\") out.verdict = raw.verdict;\r\n  if (typeof raw?.category === \"string\") out.category = raw.category;\r\n  if (raw?.state) (out as any).state = raw.state;\r\n  // P0 new fields\r\n  if (typeof raw?.ticket_type === \"string\") out.ticket_type = raw.ticket_type;\r\n  if (typeof raw?.sentiment === \"string\") out.sentiment = raw.sentiment;\r\n  if (typeof raw?.severity === \"string\") out.severity = raw.severity;\r\n  if (typeof raw?.detected_language === \"string\") out.detected_language = raw.detected_language;\r\n  if (typeof raw?.processing_time_ms === \"number\") out.processing_time_ms = raw.processing_time_ms;\r\n  // frontend compatibility + UI fallback\r\n  (out as any).preferredModule = preferredModule;\r\n  (out as any).detected_module = out.context;\r\n  if (!out.ui && out.mode === \"solve\") out.ui = fallbackUiLink(out.context, out.category);\r\n  return out;\r\n}\r\n", "// src/prompt.ts \u2014 Single-source system prompt (fixes G2) + empathy injection (R3)\r\nimport type { HistoryMsg } from \"./types\";\r\n\r\n/* ----------------------------- R3: Empathy injection ----------------------------- */\r\n\r\n/**\r\n * R3: When the conversation has \u22651 prior turn AND sentiment is frustrated/urgent,\r\n * inject an empathy block into the system prompt so the LLM acknowledges the emotion\r\n * before jumping to a solution.\r\n */\r\nfunction empathyBlock(turnCount: number, sentiment?: string): string {\r\n  if (turnCount < 1) return \"\";\r\n  if (sentiment !== \"frustrated\" && sentiment !== \"urgent\") return \"\";\r\n\r\n  if (sentiment === \"frustrated\") {\r\n    return `\r\nEMPATHIE (le marchand semble frustr\u00E9):\r\n- Commence par reconna\u00EEtre l'\u00E9motion: \"Je comprends ta frustration\u2026\", \"Je suis d\u00E9sol\u00E9 pour ce d\u00E9sagr\u00E9ment\u2026\"\r\n- Montre que tu prends le probl\u00E8me au s\u00E9rieux: \"On va r\u00E9soudre \u00E7a ensemble\"\r\n- Ne minimise jamais le probl\u00E8me du marchand`;\r\n  }\r\n\r\n  return `\r\nEMPATHIE (situation urgente):\r\n- Montre de la r\u00E9activit\u00E9: \"Je comprends l'urgence\u2026\", \"On s'en occupe tout de suite\"\r\n- Priorise la solution la plus rapide\r\n- Si escalade n\u00E9cessaire, rassure: \"Je transf\u00E8re imm\u00E9diatement \u00E0 l'\u00E9quipe technique\"`;\r\n}\r\n\r\n/* ----------------------------- System prompts ----------------------------- */\r\n\r\n/**\r\n * Full system prompt used by runStructuredChat (non-streaming).\r\n * Single source of truth \u2014 fixes G2 (duplicated prompt).\r\n */\r\nexport function getSystemPrompt(opts?: { turnCount?: number; sentiment?: string }): string {\r\n  const empathy = empathyBlock(opts?.turnCount ?? 0, opts?.sentiment);\r\n\r\n  return `Tu es l'assistant IA de TikTak PRO. Objectif: r\u00E9soudre la majorit\u00E9 des demandes L0/L1 (le marchand applique tes \u00E9tapes). Escalade = dernier recours.\r\n\r\nPERSONNALIT\u00C9: professionnel, chaleureux, efficace. Tu tutoies.\r\n\r\n=== LANGUE ===\r\n- Par d\u00E9faut: r\u00E9pondre en FRAN\u00C7AIS.\r\n- Si le marchand \u00E9crit en arabe standard: tu peux r\u00E9pondre en arabe standard.\r\n- Tu comprends darija/arabizi (ex: \"mayhbch\", \"yekhdm\", \"ki ndir\") MAIS tu ne produis PAS de phrases en darija/arabizi.\r\n  Exception: salutations tr\u00E8s courtes (\"Aaslema\") autoris\u00E9es si le marchand \u00E9crit en darija.\r\n- Tu peux citer un message d'erreur EXACT du marchand (code, texte) m\u00EAme s'il est en arabe/darija, pour confirmer le diagnostic.\r\n- INTERDIT: \"je vais supposer que\u2026\" \u2192 dis directement ce que tu comprends ou pose une question claire.\r\n\r\n=== INDICES DE ROUTAGE (PRIORIT\u00C9 ABSOLUE) ===\r\nSi le bloc INDICES DE ROUTAGE contient FORCE_CATEGORY, PREFERRED_CATEGORY, FORCE_ESCALATE ou FORCE_VERDICT \u2192 respecte-les dans ton JSON, sans discussion.\r\n\r\nMODULES (champ \"category\"):\r\n- orders: Commandes, suivi, annulations, codes promo, coupons, checkout, bordereau, confirmation, panier\r\n- products: Produits, catalogue, variants, cat\u00E9gories, images, import produits, fiche produit, page produit\r\n- builder: Templates, design, sections, banni\u00E8res, SEO, pages, header/footer, apparence, logo, couleurs, CSS\r\n- settings: Domaines, DNS, SSL, certificat, langue, configuration site, nom de domaine\r\n- shipping: Livraison, transporteurs, synchronisation livreurs, colis, tracking, ramassage, bordereau livraison, exp\u00E9dition\r\n- payments: Paiement en ligne, Stripe, Konnect, carte bancaire, activation paiement, transaction, eDinar\r\n- billing: Factures TikTak, abonnement, forfait, renouvellement, plan, commissions\r\n- pos: Point de vente, caisse enregistreuse, TVA, ticket de caisse, personnel, vente boutique\r\n- apps: Int\u00E9grations, API, Shopify, Facebook Pixel, webhooks, modules tiers, shipper\r\n- customers: Gestion clients, profils utilisateurs, r\u00E9clamations\r\n- technical: Erreurs serveur 5xx (500, 502, 503, 504), gateway timeout, site crash, panne, bug technique\r\n- auth: Login, mot de passe, OTP, 2FA, d\u00E9connexion, session expir\u00E9e, r\u00E9initialiser mot de passe\r\n- inventory: Stock, inventaire, rupture de stock, gestion des stocks, synchronisation stock\r\n- notifications: Notifications email/SMS, alertes, emails automatiques, notification commande\r\n- general: Activation boutique, changement email/nom, duplication site, liaison, \u00E9quipe/team, pack\r\n\r\n=== M\u00C9THODE (DIAGNOSTIC AVANT PRESCRIPTION) ===\r\nR\u00E8gle: diagnostiquer avant de prescrire.\r\nException: si la demande est clairement \"comment faire X ?\" \u2192 donne directement 2-3 \u00E9tapes.\r\n\r\n1) Probl\u00E8me vague (\"\u00E7a marche pas\", \"bloqu\u00E9\") \u2192 verdict=\"unclear\" + next_question (1 question pr\u00E9cise: message exact / page / depuis quand).\r\n2) Ne r\u00E9p\u00E8te jamais les m\u00EAmes \u00E9tapes. Si \"tout est v\u00E9rifi\u00E9\" / \"persiste\" \u2192 propose une ALTERNATIVE ou question plus cibl\u00E9e.\r\n3) 2-3 \u00E9tapes max par r\u00E9ponse. Attends le retour.\r\n4) Utilise l'historique. Ne redemande pas une info d\u00E9j\u00E0 donn\u00E9e.\r\n\r\n=== STYLE (answer) ===\r\n- Reconnaissance br\u00E8ve (\"Je vois que\u2026\", \"Bien re\u00E7u !\")\r\n- \u00C9tapes num\u00E9rot\u00E9es 1..3, **Gras** pour menus/boutons\r\n- Concis: 2-4 phrases si simple, \u00E9tapes num\u00E9rot\u00E9es si proc\u00E9dure\r\n- Terminer par suivi (\"Dis-moi si \u00E7a fonctionne !\" / \"Tiens-moi au courant\")\r\n- JAMAIS inventer de fonctionnalit\u00E9s \u2014 UNIQUEMENT la base de connaissances fournie\r\n- Ne mentionne JAMAIS: playbook, documentation, docs, guide, base de connaissances. TU es la source.\r\n- Emojis: 1-2 max\r\n${empathy}\r\n=== ESCALADE ===\r\nescalade (verdict=\"tiktak_side\", escalate=true) uniquement si:\r\n- Incident TikTak confirm\u00E9 (5xx / crash / API down / fonction cass\u00E9e)\r\n- OU toutes solutions \u00E9puis\u00E9es, marchand a tout essay\u00E9, plus aucune alternative\r\n- OU n\u00E9cessite acc\u00E8s backend/serveur\r\n\r\nLa frustration/urgence influence le TON, pas la d\u00E9cision d'escalade.\r\n\r\n=== FORMAT JSON STRICT (rien avant/apr\u00E8s) ===\r\n{\"verdict\":\"...\",\"confidence\":0.0-1.0,\"category\":\"module\",\"ticket_type\":\"...\",\"sentiment\":\"...\",\"severity\":\"...\",\"detected_language\":\"...\",\"answer\":\"...\",\"next_question\":\"...\" ou null,\"escalate\":boolean,\"evidence\":[],\"actions\":[]}\r\n\r\nTICKET_TYPE: \"bug\" (fonctionnalit\u00E9 cass\u00E9e) | \"question\" (comment faire X) | \"demand\" (activation/modification) | \"incident\" (urgence: site down, 5xx, paiement bloqu\u00E9)\r\nSENTIMENT: \"calm\" | \"frustrated\" | \"urgent\" | \"satisfied\"\r\nSEVERITY: \"low\" (pas d'impact) | \"medium\" (contournable) | \"high\" (bloque fonctionnalit\u00E9) | \"critical\" (site down/perte donn\u00E9es)\r\nDETECTED_LANGUAGE: \"fr\" | \"ar\" | \"darija\" | \"en\"\r\n\r\nR\u00C8GLES FINALES:\r\n- verdict=\"unclear\" \u2192 next_question obligatoire (1 seule question pr\u00E9cise)\r\n- verdict != \"unclear\" \u2192 next_question=null\r\n- Historique: ne redemande pas, ne redonne pas. Si \u00E9chec \u2192 ALTERNATIVE ou escalade.`;\r\n}\r\n\r\n/**\r\n * Shorter prompt used by buildLlmMessages (streaming).\r\n * Uses the same getSystemPrompt \u2014 fixes G2 duplication.\r\n */\r\nexport function getStreamingSystemPrompt(opts?: { turnCount?: number; sentiment?: string }): string {\r\n  return getSystemPrompt(opts);\r\n}\r\n\r\n/* ----------------------------- Message builder ----------------------------- */\r\n\r\n/**\r\n * Build the LLM messages array for both non-streaming and streaming chat.\r\n * Single implementation \u2014 fixes G2 + G3 duplication.\r\n */\r\nexport function buildLlmMessages(\r\n  currentMessage: string,\r\n  history: HistoryMsg[],\r\n  knowledgeContext: string,\r\n  routingHints: string,\r\n  opts?: { turnCount?: number; sentiment?: string }\r\n): Array<{ role: string; content: string }> {\r\n  const systemPrompt = getSystemPrompt(opts);\r\n\r\n  const msgs: Array<{ role: string; content: string }> = [\r\n    { role: \"system\", content: systemPrompt },\r\n  ];\r\n\r\n  // Add conversation history as real turns (last 6 exchanges = 12 messages max)\r\n  const recentHistory = history.slice(-12);\r\n  for (const msg of recentHistory) {\r\n    msgs.push({ role: msg.role, content: msg.content.slice(0, 400) });\r\n  }\r\n\r\n  // Current user message + routing hints + knowledge context\r\n  const hintsBlock = routingHints ? `\\n--- INDICES DE ROUTAGE ---\\n${routingHints}\\n` : \"\";\r\n  const userContent = `${currentMessage}${hintsBlock}\\n--- BASE DE CONNAISSANCES ---\\n${knowledgeContext}\\n\\nR\u00E9ponds UNIQUEMENT en JSON valide.`;\r\n  msgs.push({ role: \"user\", content: userContent });\r\n\r\n  // Assistant prefill to force JSON output\r\n  msgs.push({ role: \"assistant\", content: \"{\" });\r\n\r\n  return msgs;\r\n}\r\n", "// src/rag.ts \u2014 RAG pipeline, embedding, evidence gathering, confidence calculation (R5)\r\nimport type { Env, RetrievalContext, Playbook, PlaybookIngestItem } from \"./types\";\r\nimport { EMBED_MODEL } from \"./types\";\r\nimport { toStr, clamp01 } from \"./helpers\";\r\nimport { canonicalModule, areModulesRelated } from \"./detection\";\r\n\r\n/* ----------------------------- Embedding ----------------------------- */\r\n\r\nexport async function embedText(env: Env, text: string): Promise<number[] | null> {\r\n  try {\r\n    const result = (await env.AI.run(EMBED_MODEL, { text })) as any;\r\n    if (result?.data?.[0]) return result.data[0];\r\n    return null;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/* ----------------------------- Smart context retrieval ----------------------------- */\r\n\r\n/**\r\n * TikTak-optimized retrieval with module boosting.\r\n */\r\nexport async function smartFetchContext(\r\n  env: Env,\r\n  index: VectorizeIndex,\r\n  vector: number[],\r\n  tenantId: string,\r\n  preferredModule: string,\r\n  maxResults: number,\r\n  contextType: \"playbook\" | \"doc\"\r\n): Promise<RetrievalContext> {\r\n  const results = await index.query(vector, {\r\n    topK: maxResults * 3,\r\n    filter: { tenant_id: tenantId },\r\n    returnMetadata: \"all\",\r\n  });\r\n\r\n  const matches = results?.matches || [];\r\n\r\n  // Score boosting: prefer items matching the preferred module\r\n  const scoredMatches = matches.map((match) => {\r\n    let score = match.score || 0;\r\n    const itemModuleRaw = toStr(match.metadata?.module || \"\");\r\n    const itemModule = canonicalModule(itemModuleRaw);\r\n    const pref = canonicalModule(preferredModule);\r\n\r\n    if (itemModule === pref) {\r\n      score *= 1.5;\r\n    } else if (areModulesRelated(itemModule, pref)) {\r\n      score *= 1.2;\r\n    }\r\n\r\n    return { ...match, adjustedScore: score };\r\n  });\r\n\r\n  scoredMatches.sort((a, b) => (b.adjustedScore || 0) - (a.adjustedScore || 0));\r\n\r\n  // Deduplicate\r\n  const seen = new Set<string>();\r\n  const uniqueMatches = scoredMatches.filter((m) => {\r\n    const key = `${m.metadata?.module}-${m.id}`;\r\n    if (seen.has(key)) return false;\r\n    seen.add(key);\r\n    return true;\r\n  });\r\n\r\n  const topMatches = uniqueMatches.slice(0, maxResults);\r\n\r\n  const scores = topMatches.map((m) => m.adjustedScore || 0);\r\n  const avgScore = scores.length ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;\r\n  const topScore = scores.length ? Math.max(...scores) : 0;\r\n\r\n  // Build items array\r\n  const items: Array<{ id: string; text: string; score: number; module: string }> = [];\r\n\r\n  if (contextType === \"playbook\") {\r\n    for (const match of topMatches) {\r\n      const r2Key = toStr(match.metadata?.r2_key || \"\");\r\n      if (!r2Key) continue;\r\n      try {\r\n        const obj = await env.TIKTAK_DOCS.get(r2Key);\r\n        if (!obj) continue;\r\n        const raw = await obj.text();\r\n        const parsed = JSON.parse(raw) as PlaybookIngestItem;\r\n        items.push({\r\n          id: match.id,\r\n          text: formatPlaybookForContext(parsed.playbook),\r\n          score: match.adjustedScore || 0,\r\n          module: toStr(match.metadata?.module || \"\"),\r\n        });\r\n      } catch {\r\n        continue;\r\n      }\r\n    }\r\n  } else {\r\n    for (const match of topMatches) {\r\n      items.push({\r\n        id: match.id,\r\n        text: toStr(match.metadata?.text || \"\"),\r\n        score: match.adjustedScore || 0,\r\n        module: toStr(match.metadata?.module || \"\"),\r\n      });\r\n    }\r\n  }\r\n\r\n  const text = items.map((item) => item.text).join(\"\\n\\n---\\n\\n\");\r\n\r\n  return { text, items, matches: topMatches, avgScore, topScore };\r\n}\r\n\r\n/* ----------------------------- Playbook formatting ----------------------------- */\r\n\r\nexport function formatPlaybookForContext(playbook: Playbook): string {\r\n  const parts: string[] = [];\r\n\r\n  parts.push(`[PLAYBOOK: ${playbook.title || playbook.id}]`);\r\n  if (playbook.scope) parts.push(`Module: ${playbook.scope}`);\r\n  if (playbook.description) parts.push(`Description: ${playbook.description}`);\r\n\r\n  if (playbook.triggers && playbook.triggers.length > 0) {\r\n    parts.push(`Mots-cl\u00E9s: ${playbook.triggers.slice(0, 8).join(\", \")}`);\r\n  }\r\n\r\n  if (playbook.scanner_setup) {\r\n    parts.push(`\\nConfiguration Scanner:`);\r\n    for (const [key, value] of Object.entries(playbook.scanner_setup)) {\r\n      parts.push(`- ${key}: ${value}`);\r\n    }\r\n  }\r\n\r\n  if (playbook.common_errors && playbook.common_errors.length > 0) {\r\n    parts.push(`\\nErreurs Fr\u00E9quentes:`);\r\n    for (const err of playbook.common_errors.slice(0, 4)) {\r\n      parts.push(`\u2022 Sympt\u00F4me: ${err.symptom}`);\r\n      parts.push(`  Cause: ${err.cause}`);\r\n      parts.push(`  Solution: ${err.solution}`);\r\n    }\r\n  }\r\n\r\n  if (playbook.diagnostic_checklist) {\r\n    parts.push(`\\nDiagnostic: ${JSON.stringify(playbook.diagnostic_checklist)}`);\r\n  }\r\n\r\n  parts.push(`\\n\u00C9tapes (${playbook.steps.length}):`);\r\n  for (let i = 0; i < Math.min(playbook.steps.length, 6); i++) {\r\n    const step = playbook.steps[i];\r\n    parts.push(`${i + 1}. [${step.kind.toUpperCase()}]`);\r\n    if (step.title) parts.push(`   ${step.title}`);\r\n\r\n    switch (step.kind) {\r\n      case \"ask\":\r\n        parts.push(`   Q: ${step.question.slice(0, 150)}`);\r\n        break;\r\n      case \"solve\":\r\n        parts.push(`   ${step.response.slice(0, 250)}`);\r\n        if (step.common_errors && step.common_errors.length > 0) {\r\n          parts.push(`   Erreurs: ${step.common_errors.slice(0, 3).join(\", \")}`);\r\n        }\r\n        if (step.common_fixes && step.common_fixes.length > 0) {\r\n          parts.push(`   Solutions: ${step.common_fixes.slice(0, 3).join(\", \")}`);\r\n        }\r\n        break;\r\n      case \"escalate\":\r\n        parts.push(`   Raison: ${step.reason}`);\r\n        break;\r\n    }\r\n  }\r\n\r\n  if (playbook.best_practices && playbook.best_practices.length > 0) {\r\n    parts.push(`\\nBonnes Pratiques:`);\r\n    playbook.best_practices.slice(0, 3).forEach((p) => parts.push(`- ${p}`));\r\n  }\r\n\r\n  return parts.join(\"\\n\");\r\n}\r\n\r\n/* ----------------------------- Evidence gathering ----------------------------- */\r\n\r\nexport function gatherEvidence(\r\n  modelEvidence: any[],\r\n  playbookContext: RetrievalContext,\r\n  docsContext: RetrievalContext,\r\n  maxEvidence: number = 6\r\n): Array<{ source: \"playbook\" | \"doc\"; id: string; snippet: string; score: number }> {\r\n  const evidenceMap = new Map<string, { source: \"playbook\" | \"doc\"; id: string; snippet: string; score: number }>();\r\n\r\n  // Priority 1: Model evidence\r\n  if (Array.isArray(modelEvidence)) {\r\n    for (const e of modelEvidence) {\r\n      if (!e?.id || !e?.snippet) continue;\r\n      const source = e?.source === \"playbook\" ? \"playbook\" : \"doc\";\r\n      const key = `${source}-${e.id}`;\r\n      evidenceMap.set(key, {\r\n        source,\r\n        id: toStr(e.id),\r\n        snippet: toStr(e.snippet).slice(0, 250),\r\n        score: 1.0,\r\n      });\r\n    }\r\n  }\r\n\r\n  // Priority 2: Top playbooks\r\n  for (const item of playbookContext.items.slice(0, 3)) {\r\n    const key = `playbook-${item.id}`;\r\n    if (!evidenceMap.has(key)) {\r\n      const snippet = item.text.split(\"\\n\").slice(0, 5).join(\" \").slice(0, 250);\r\n      evidenceMap.set(key, { source: \"playbook\", id: item.id, snippet, score: item.score });\r\n    }\r\n  }\r\n\r\n  // Priority 3: Top docs\r\n  for (const match of docsContext.matches.slice(0, 3)) {\r\n    const id = toStr(match?.id || \"\");\r\n    const key = `doc-${id}`;\r\n    if (!evidenceMap.has(key)) {\r\n      const snippet = `Module: ${toStr(match?.metadata?.module || \"\")} | Score: ${(match?.score * 100).toFixed(0)}%`;\r\n      evidenceMap.set(key, { source: \"doc\", id, snippet, score: match?.score || 0 });\r\n    }\r\n  }\r\n\r\n  const allEvidence = Array.from(evidenceMap.values());\r\n  allEvidence.sort((a, b) => b.score - a.score);\r\n  return allEvidence.slice(0, maxEvidence);\r\n}\r\n\r\n/* ----------------------------- Knowledge context builder ----------------------------- */\r\n\r\nexport function buildKnowledgeContext(\r\n  preferredModule: string,\r\n  playbookContext: RetrievalContext,\r\n  docsContext: RetrievalContext\r\n): string {\r\n  const parts: string[] = [];\r\n  parts.push(`[Module d\u00E9tect\u00E9: ${preferredModule}]`);\r\n\r\n  if (playbookContext.text.trim()) {\r\n    parts.push(\"\\n--- PLAYBOOKS TikTak PRO ---\");\r\n    parts.push(playbookContext.text);\r\n  }\r\n\r\n  if (docsContext.text.trim()) {\r\n    parts.push(\"\\n--- DOCUMENTATION TikTak PRO ---\");\r\n    parts.push(docsContext.text);\r\n  }\r\n\r\n  return parts.join(\"\\n\");\r\n}\r\n\r\n/* ----------------------------- R5: Confidence calculation ----------------------------- */\r\n\r\n/**\r\n * R5: Compute confidence from multiple signals instead of relying solely on the LLM.\r\n * Factors: Vectorize topScore, keyword match score, LLM self-reported confidence,\r\n * and response length heuristic.\r\n */\r\nexport function computeConfidence(opts: {\r\n  llmConfidence: number;\r\n  topVectorizeScore: number;\r\n  keywordScore: number;\r\n  answerLength: number;\r\n}): number {\r\n  const { llmConfidence, topVectorizeScore, keywordScore, answerLength } = opts;\r\n\r\n  // Weights: LLM 40%, Vectorize 30%, keyword 15%, length heuristic 15%\r\n  const vecNorm = clamp01(topVectorizeScore);  // already 0-1\r\n  const kwNorm = clamp01(Math.min(keywordScore / 5, 1));  // normalize to 0-1 (5+ = max)\r\n  const lenNorm = clamp01(answerLength > 200 ? 1 : answerLength > 50 ? 0.7 : answerLength > 10 ? 0.4 : 0);\r\n\r\n  const composite = (\r\n    llmConfidence * 0.40 +\r\n    vecNorm * 0.30 +\r\n    kwNorm * 0.15 +\r\n    lenNorm * 0.15\r\n  );\r\n\r\n  return clamp01(Number(composite.toFixed(2)));\r\n}\r\n", "// src/governance.ts \u2014 Deterministic governance layer (v4: decision-table, zero scoring)\r\n//\r\n// DESIGN: Pure boolean pattern matching \u2192 forced outputs.\r\n// No weighted scoring. First-match-wins priority chain.\r\n// Cost: <1ms (regex only, no I/O).\r\n//\r\n// DECISION TABLE (priority order):\r\n//   P0  HTTP false-positive filter  \u2192 blocks P1\r\n//   P1  HTTP 5xx incident           \u2192 force technical / tiktak_side / escalate\r\n//   P2  Emotional escalation        \u2192 force general / escalate\r\n//   P3  Site/link down (no 5xx)     \u2192 force technical / tiktak_side / escalate\r\n//\r\n// POST-LLM OVERRIDE:\r\n//   If tag=http_5xx     \u2192 force category=technical, verdict=tiktak_side, escalate=true\r\n//   If tag=emotion      \u2192 force category=general, escalate=true\r\n//   If tag=false_positive \u2192 de-escalate if LLM escalated\r\n//   If tag=site_down    \u2192 force category=technical, verdict=tiktak_side, escalate=true\r\n\r\n/* ====================================================================\r\n   TYPES\r\n   ==================================================================== */\r\n\r\nexport type GovTag =\r\n  | \"http_false_positive\"\r\n  | \"http_5xx\"\r\n  | \"emotion\"\r\n  | \"site_down\"\r\n  | \"http_5xx_emotion\"\r\n  | \"none\";\r\n\r\nexport interface GovernanceSignals {\r\n  /** Primary classification tag \u2014 first rule that matched */\r\n  tag: GovTag;\r\n\r\n  /** Emotion analysis */\r\n  emotion: {\r\n    score: number;\r\n    triggers: string[];\r\n    sentiment: \"frustrated\" | \"urgent\" | \"angry\" | \"calm\";\r\n    detected: boolean;\r\n  };\r\n\r\n  /** HTTP error analysis */\r\n  httpError: {\r\n    detected: boolean;\r\n    falsePositive: boolean;\r\n    codes: string[];\r\n    reason: string;\r\n    score: number;\r\n  };\r\n\r\n  /** Deterministic forced outputs from the decision table */\r\n  force: {\r\n    category?: string;\r\n    verdict?: \"user_side\" | \"tiktak_side\" | \"unclear\";\r\n    escalate?: boolean;\r\n    severity?: string;\r\n    ticket_type?: string;\r\n    sentiment?: string;\r\n  };\r\n\r\n  /** Category hints for LLM prompt (informational, not authoritative) */\r\n  categoryHints: Array<{ module: string; confidence: number; reason: string }>;\r\n\r\n  /** Persistence detection */\r\n  persistenceScore: number;\r\n\r\n  /** Severity keywords score */\r\n  severityScore: number;\r\n\r\n  // Legacy compat fields (used by routes.ts escalation logic)\r\n  escalationScore: number;\r\n  forceEscalate: boolean;\r\n  recommendEscalate: boolean;\r\n}\r\n\r\n/* ====================================================================\r\n   1. HTTP 5xx PATTERNS \u2014 ordered by specificity\r\n   ==================================================================== */\r\n\r\nconst HTTP_5XX_PATTERNS: RegExp[] = [\r\n  /\\b(erreur|error)\\s*(5\\d\\d)\\b/i,\r\n  /\\b(5\\d\\d)\\s*(error|erreur)\\b/i,\r\n  /\\binternal\\s*server\\s*error\\b/i,\r\n  /\\b(erreur|error)\\s*interne\\s*(du\\s*)?(serveur)?\\b/i,\r\n  /\\bgateway\\s*timeout\\b/i,\r\n  /\\bbad\\s*gateway\\b/i,\r\n  /\\bservice\\s*unavailable\\b/i,\r\n  /\\berreur\\s*serveur\\b/i,\r\n  /\\bserver\\s*error\\b/i,\r\n  /\\bpanne\\s*(syst[e\u00E8]me|totale|compl[e\u00E8]te|generale|g[e\u00E9]n[e\u00E9]rale|serveur)?\\b/i,\r\n  /\\b(affiche|montre|donne|appara[i\u00EE]t|renvoie|retourne)\\s*['\"]?\\s*(erreur\\s*)?(500|502|503|504)\\b/i,\r\n  /\\b(500|502|503|504)\\b.*\\b(quand|when|lorsque|ki|lors)\\b/i,\r\n  /\\byodher\\b.*\\b(erreur|error)\\s*(5\\d\\d)\\b/i,\r\n  /\\byatla3\\b.*\\b(erreur|error)\\s*(5\\d\\d)\\b/i,\r\n  /\\bfih\\b.*\\b(erreur|error)\\s*(5\\d\\d)\\b/i,\r\n  /\\btatla3\\b.*\\b(erreur|error)\\s*(5\\d\\d)\\b/i,\r\n  /\\b50[0234]\\s*(error|erreur)\\b/i,\r\n  /\\btimeout\\b.*\\b(serveur|server)\\b/i,\r\n  /\\b(serveur|server)\\b.*\\btimeout\\b/i,\r\n  /\\b(fix|r[e\u00E9]soudre|corriger|r[e\u00E9]parer)\\b.*\\b(500|502|503|504)\\s*(error|erreur)?\\b/i,\r\n];\r\n\r\n/* ====================================================================\r\n   2. HTTP FALSE-POSITIVE PATTERNS \u2014 \"500\" is a quantity\r\n   ==================================================================== */\r\n\r\nconst HTTP_FALSE_POSITIVE_PATTERNS: RegExp[] = [\r\n  /\\b500\\s*(produits?|articles?|commandes?|clients?|items?|r[e\u00E9]f[e\u00E9]rences?|SKU|fiches?|pages?|variantes?)\\b/i,\r\n  /\\b(plan|forfait|pack|limite|capacit[e\u00E9]|jusqu['']?[a\u00E0]|maximum|max)\\b.*\\b500\\b/i,\r\n  /\\b500\\b.*\\b(plan|forfait|pack|limite|capacit[e\u00E9])\\b/i,\r\n  /\\b(importer|ajouter|avoir|cr[e\u00E9]er|g[e\u00E9]rer|supporter)\\s+500\\b/i,\r\n  /\\b500\\s*(dinars?|dt|tnd|euros?|eur|dollars?|usd)\\b/i,\r\n  /\\bsuffit\\s+(pour\\s+)?500\\b/i,\r\n];\r\n\r\n/* ====================================================================\r\n   3. SITE/LINK DOWN PATTERNS (no explicit 5xx code)\r\n   ==================================================================== */\r\n\r\nconst SITE_DOWN_PATTERNS: RegExp[] = [\r\n  /\\b(site|lien|boutique|page|dashboard|tableau de bord)\\b.*\\bne\\s+(fonctionne|marche)\\s+pas\\b/i,\r\n  /\\bne\\s+(fonctionne|marche)\\s+pas\\b.*\\b(site|lien|boutique|page|dashboard)\\b/i,\r\n  /\\bsite\\s*(crash|down|plant[e\u00E9]|plante|inaccessible|bloqu[e\u00E9]|en panne)\\b/i,\r\n  /\\b(crash|plante|plant[e\u00E9])\\b.*\\b(site|page|boutique|dashboard)\\b/i,\r\n  /\\bsite\\s+ne\\s+(s['']ouvre|charge|r[e\u00E9]pond|repond)\\s+pas\\b/i,\r\n  /\\b(lien|link)\\b.*\\b(ne\\s+)?(fonctionne|marche|works?)\\s*pas\\b/i,\r\n  /\\b(fixer|fix|r[e\u00E9]soudre|corriger)\\b.*\\b(probl[e\u00E8]me|problem)\\b.*\\b(site|lien|page)\\b/i,\r\n  /\\bsite\\s*(ma5dimch|ma5demch|5asro|mayekhdemch|may5demch)\\b/i,\r\n  /\\bsite\\s+ma\\s*y(7el|5dem|ekhdem)ch\\b/i,\r\n];\r\n\r\n/* ====================================================================\r\n   4. EMOTION PATTERNS \u2014 deterministic boolean match\r\n   ==================================================================== */\r\n\r\ninterface EmotionPattern {\r\n  pattern: RegExp;\r\n  score: number;\r\n  sentiment: \"frustrated\" | \"urgent\" | \"angry\";\r\n  label: string;\r\n}\r\n\r\nconst EMOTION_PATTERNS: EmotionPattern[] = [\r\n  // -- ANGER / DEMAND ESCALATION --\r\n  { pattern: /\\b(je veux|je demande|je souhaite)\\s+(parler|voir|contacter)\\s+([a\u00E0])?\\s*(un|le|la|au)\\s*(responsable|manager|superviseur|directeur|sup[e\u00E9]rieur)/i, score: 10, sentiment: \"angry\", label: \"demand_manager_fr\" },\r\n  { pattern: /\\bparler\\s+([a\u00E0])\\s+(un\\s*)?(responsable|manager|superviseur|directeur)/i, score: 10, sentiment: \"angry\", label: \"speak_manager_fr\" },\r\n  { pattern: /\\b(speak|talk)\\s+to\\s+a?\\s*(manager|supervisor|boss|director|someone in charge)/i, score: 10, sentiment: \"angry\", label: \"demand_manager_en\" },\r\n  { pattern: /\\b(want|need)\\s+to\\s+(speak|talk)\\s+to\\s+a?\\s*(manager|supervisor|person|human)/i, score: 10, sentiment: \"angry\", label: \"demand_human_en\" },\r\n  { pattern: /\\binacceptable\\b|\\bscandale\\b|\\bscandaleux\\b|\\bhonteux\\b|\\bhonte\\b|\\bimpossible de travailler\\b/i, score: 9, sentiment: \"angry\", label: \"outrage_fr\" },\r\n  { pattern: /\\bunacceptable\\b|\\bscandalous\\b|\\boutrageous\\b|\\bdisgusting\\b|\\bshame\\b/i, score: 9, sentiment: \"angry\", label: \"outrage_en\" },\r\n\r\n  // -- FRUSTRATION --\r\n  { pattern: /\\b(tr[e\u00E8]s|vraiment|extr[e\u00EA]mement|trop)\\s+(d[e\u00E9][\u00E7c]u|m[e\u00E9]content|frustr[e\u00E9]|f[a\u00E2]ch[e\u00E9]|furieux|en col[e\u00E8]re)/i, score: 8, sentiment: \"frustrated\", label: \"strong_frustration_fr\" },\r\n  { pattern: /\\b(je suis|j['']en ai|on est)\\s+(d[e\u00E9][\u00E7c]u|m[e\u00E9]content|frustr[e\u00E9]|f[a\u00E2]ch[e\u00E9]|furieux|en col[e\u00E8]re|ras le bol|marre)/i, score: 8, sentiment: \"frustrated\", label: \"frustration_expr_fr\" },\r\n  { pattern: /\\bj['']en ai marre\\b|\\bras[- ]le[- ]bol\\b|\\bje n['']en peux plus\\b/i, score: 8, sentiment: \"frustrated\", label: \"fed_up_fr\" },\r\n  { pattern: /\\bmon (business|commerce|boutique|site|magasin) ne (marche|fonctionne) plus\\b/i, score: 8, sentiment: \"urgent\", label: \"business_down_fr\" },\r\n  { pattern: /\\b(very|extremely|really|so)\\s+(disappointed|frustrated|angry|upset|unhappy)/i, score: 8, sentiment: \"frustrated\", label: \"strong_frustration_en\" },\r\n  { pattern: /\\bI['']m (fed up|done|sick of|tired of)\\b/i, score: 8, sentiment: \"frustrated\", label: \"fed_up_en\" },\r\n  { pattern: /\\b([\u00E7c]a|ca|c['']est|cest)\\s+(ne marche|marche) pas\\b.*!/i, score: 7, sentiment: \"frustrated\", label: \"doesnt_work_fr\" },\r\n  { pattern: /\\b[\u00E7c]a fait\\s+(\\d+|une?|deux|trois|quatre|cinq|six|sept|huit|neuf|dix)\\s*(jours?|semaines?|heures?|mois)\\b/i, score: 7, sentiment: \"frustrated\", label: \"time_waiting_fr\" },\r\n  { pattern: /\\bdepuis\\s+(\\d+|une?|deux|trois)\\s*(jours?|semaines?|heures?|mois)\\b/i, score: 7, sentiment: \"frustrated\", label: \"since_duration_fr\" },\r\n  { pattern: /\\b(\\d+|une?|deux|trois)\\s*(jours?|days?|semaines?|weeks?)\\s*(sans|without|et|w|no)\\s*(r[e\u00E9]ponse|response|answer|nouvelle|rien)/i, score: 7, sentiment: \"frustrated\", label: \"days_no_response\" },\r\n  { pattern: /\\bsemaine\\b.*\\b(contacte|contact|appel|[e\u00E9]cri|envo)/i, score: 7, sentiment: \"frustrated\", label: \"week_contacting_fr\" },\r\n  { pattern: /\\bpersonne\\s*(ne)?\\s*(r[e\u00E9]pond|repond|aide|m['']aide)\\b/i, score: 7, sentiment: \"frustrated\", label: \"nobody_answers_fr\" },\r\n  { pattern: /\\b(le support|support)\\s+(est\\s+)?(nul|horrible|inutile|catastrophique|mauvais|inexistant)\\b/i, score: 8, sentiment: \"frustrated\", label: \"support_is_bad_fr\" },\r\n  { pattern: /\\bremboursez[- ]?moi\\b/i, score: 8, sentiment: \"angry\", label: \"refund_demand_fr\" },\r\n\r\n  // -- ARABIZI / DARIJA --\r\n  { pattern: /\\b7abset\\b|\\b7abit\\b|\\b7a9et\\b|\\bze3ma\\b.*\\bma\\b.*\\bch\\b/i, score: 8, sentiment: \"frustrated\", label: \"fed_up_arabizi\" },\r\n  { pattern: /\\bma\\s*jawb(ni|ouni|nech|ounech|nich)\\b|\\bma\\s*jaw[bw](ni|ouni)\\b/i, score: 7, sentiment: \"frustrated\", label: \"no_answer_arabizi\" },\r\n  { pattern: /\\b7ata\\s*wa7ed\\s*ma\\s*jaw[bw]/i, score: 8, sentiment: \"frustrated\", label: \"nobody_answered_arabizi\" },\r\n  { pattern: /\\bel\\s*7keya\\b|\\bhel\\s*7keya\\b|\\b7keyet\\b/i, score: 6, sentiment: \"frustrated\", label: \"this_situation_arabizi\" },\r\n  { pattern: /\\bbarcha\\s*(wa9t|wakt)\\b|\\bbezzaf\\b|\\byeser\\b/i, score: 6, sentiment: \"frustrated\", label: \"too_long_arabizi\" },\r\n  { pattern: /\\bnheb\\s*n(7ki|kellem)\\s*(m3a|ma3)\\s*(responsable|chef|manager)/i, score: 10, sentiment: \"angry\", label: \"demand_manager_arabizi\" },\r\n  { pattern: /\\bmech\\s*normal\\b|\\bmech\\s*ma39oul\\b/i, score: 7, sentiment: \"frustrated\", label: \"not_normal_arabizi\" },\r\n  { pattern: /\\btaw\\b.*\\bjours?\\b.*\\bma\\b.*\\bjaw[bw]/i, score: 7, sentiment: \"frustrated\", label: \"days_no_answer_arabizi\" },\r\n  { pattern: /\\b3awnouni\\b/i, score: 7, sentiment: \"urgent\", label: \"help_me_arabizi\" },\r\n  { pattern: /\\bbrabi\\b/i, score: 6, sentiment: \"urgent\", label: \"please_arabizi\" },\r\n\r\n  // -- ARABIC --\r\n  { pattern: /\u0623\u0631\u064A\u062F\\s*(\u0627\u0644\u062A\u062D\u062F\u062B|\u0627\u0644\u0643\u0644\u0627\u0645|\u0627\u0644\u062A\u0643\u0644\u0645)\\s*(\u0645\u0639|\u0625\u0644\u0649)\\s*(\u0645\u0633\u0624\u0648\u0644|\u0645\u062F\u064A\u0631)/i, score: 10, sentiment: \"angry\", label: \"demand_manager_ar\" },\r\n  { pattern: /\u0645\u0633\u062A\u0627\u0621|\u0645\u062D\u0628\u0637|\u063A\u0627\u0636\u0628|\u0632\u0639\u0644\u0627\u0646/i, score: 8, sentiment: \"frustrated\", label: \"frustrated_ar\" },\r\n  { pattern: /\u063A\u064A\u0631 \u0645\u0642\u0628\u0648\u0644|\u0641\u0636\u064A\u062D\u0629|\u0639\u0627\u0631/i, score: 9, sentiment: \"angry\", label: \"outrage_ar\" },\r\n\r\n  // -- URGENCY INDICATORS --\r\n  { pattern: /\\baide[zr]?[- ]?moi\\b.*!/i, score: 7, sentiment: \"urgent\", label: \"help_me_urgent_fr\" },\r\n  { pattern: /\\bpriez?\\s+d['']intervenir\\b/i, score: 8, sentiment: \"urgent\", label: \"please_intervene_fr\" },\r\n  { pattern: /\\bIMM\u00C9DIATEMENT\\b|\\bTOUT DE SUITE\\b|\\bURGENT\\b/, score: 9, sentiment: \"urgent\", label: \"caps_urgency_fr\" },\r\n  { pattern: /\\burgent(e|ly|ement)?\\b/i, score: 6, sentiment: \"urgent\", label: \"urgent_keyword\" },\r\n  { pattern: /\\b(help|please|asap)\\b.*!/i, score: 6, sentiment: \"urgent\", label: \"help_urgent_en\" },\r\n  { pattern: /!{2,}/, score: 5, sentiment: \"frustrated\", label: \"multiple_exclamations\" },\r\n  { pattern: /[A-Z\u00C0-\u00DA]{5,}/, score: 4, sentiment: \"angry\", label: \"caps_shouting\" },\r\n];\r\n\r\n/* ====================================================================\r\n   5. SCANNERS \u2014 pure boolean + metadata extraction\r\n   ==================================================================== */\r\n\r\nfunction scanEmotions(message: string): GovernanceSignals[\"emotion\"] {\r\n  const triggers: string[] = [];\r\n  let maxScore = 0;\r\n  let dominantSentiment: \"frustrated\" | \"urgent\" | \"angry\" | \"calm\" = \"calm\";\r\n\r\n  for (const ep of EMOTION_PATTERNS) {\r\n    if (ep.pattern.test(message)) {\r\n      triggers.push(ep.label);\r\n      if (ep.score > maxScore) {\r\n        maxScore = ep.score;\r\n        dominantSentiment = ep.sentiment;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Compound: 3+ moderate triggers bump score\r\n  if (triggers.length >= 3 && maxScore < 8) {\r\n    maxScore = Math.min(10, maxScore + triggers.length - 2);\r\n  }\r\n\r\n  return {\r\n    score: maxScore,\r\n    triggers,\r\n    sentiment: triggers.length > 0 ? dominantSentiment : \"calm\",\r\n    detected: triggers.length > 0 && maxScore >= 5,\r\n  };\r\n}\r\n\r\nfunction scanHttpErrors(message: string): GovernanceSignals[\"httpError\"] {\r\n  const isFalsePositive = HTTP_FALSE_POSITIVE_PATTERNS.some(fp => fp.test(message));\r\n  const has5xx = /\\b(500|502|503|504)\\b/.test(message);\r\n\r\n  const codes: string[] = [];\r\n  let detected = false;\r\n  let reason = \"\";\r\n  let maxScore = 0;\r\n\r\n  for (const p of HTTP_5XX_PATTERNS) {\r\n    if (p.test(message)) {\r\n      detected = true;\r\n      const codeMatch = message.match(/\\b(5\\d\\d)\\b/);\r\n      if (codeMatch && !codes.includes(codeMatch[1])) codes.push(codeMatch[1]);\r\n      const isNamed = /internal|gateway|panne|serveur|server/.test(p.source);\r\n      const s = isNamed ? 9 : 8;\r\n      if (s > maxScore) { maxScore = s; reason = p.source.slice(0, 40); }\r\n    }\r\n  }\r\n\r\n  // False-positive suppression\r\n  if (isFalsePositive && (detected || has5xx)) {\r\n    return { score: 0, detected: false, falsePositive: true, codes, reason: `false_positive: ${reason || \"quantity_context\"}` };\r\n  }\r\n\r\n  return { score: detected ? maxScore : 0, detected, falsePositive: false, codes, reason };\r\n}\r\n\r\nfunction scanSiteDown(message: string): boolean {\r\n  return SITE_DOWN_PATTERNS.some(p => p.test(message));\r\n}\r\n\r\nfunction detectPersistence(message: string): number {\r\n  let score = 0;\r\n  const durationMatch = message.match(/(\\d+)\\s*(jours?|semaines?|days?|weeks?)/i);\r\n  if (durationMatch) {\r\n    const n = parseInt(durationMatch[1], 10);\r\n    const unit = durationMatch[2].toLowerCase();\r\n    score = unit.startsWith(\"semaine\") || unit.startsWith(\"week\")\r\n      ? Math.min(10, n * 3) : Math.min(10, Math.ceil(n / 2));\r\n  }\r\n  if (/\\bune\\s+semaine\\b/i.test(message)) score = Math.max(score, 3);\r\n  if (/\\bun\\s+mois\\b/i.test(message)) score = Math.max(score, 5);\r\n  if (/\\bplusieurs\\s+(jours?|semaines?|mois)\\b/i.test(message)) score = Math.max(score, 4);\r\n  if (/\\b(d\u00E9j\u00E0|already|encore|again|plusieurs fois|multiple times)\\s*(contact\u00E9|appel\u00E9|envoy\u00E9|\u00E9crit|written|called|sent)/i.test(message)) score = Math.max(score, 5);\r\n  if (/\\b(personne|nobody|no one|aucune r\u00E9ponse|pas de r\u00E9ponse|no response|no answer)\\b/i.test(message)) score = Math.max(score, 4);\r\n  if (/\\b(toujours pas|still not|still no|toujours rien|encore rien)\\b/i.test(message)) score = Math.max(score, 4);\r\n  // Problem-persists patterns (user says steps didn't help)\r\n  if (/\\b(probl\u00E8me\\s+persist|probl[e\u00E8]me\\s+continu|le\\s+probl[e\u00E8]me\\s+est\\s+toujours|toujours\\s+(le\\s+)?m[e\u00EA]me\\s+probl[e\u00E8]me|m\u00EAme\\s+probl[e\u00E8]me)\\b/i.test(message)) score = Math.max(score, 5);\r\n  if (/\\b(tout\\s+(est\\s+)?v[\u00E9e]rifi[\u00E9e]|j['']ai\\s+(tout\\s+)?(fait|essay\u00E9|v\u00E9rifi\u00E9)|rien\\s+n['']a?\\s+(chang\u00E9|march\u00E9|fonctionn\u00E9))\\b/i.test(message)) score = Math.max(score, 5);\r\n  if (/\\b(toujours\\s+pareil|\u00E7a\\s+(change|marche|fonctionne)\\s+rien|m\u00EAme\\s+chose|m\u00EAme\\s+erreur|still\\s+the\\s+same)\\b/i.test(message)) score = Math.max(score, 5);\r\n  if (/\\b(\u00E7a\\s+persist|persist\\s+encore|ne\\s+marche\\s+toujours\\s+pas)\\b/i.test(message)) score = Math.max(score, 5);\r\n  return Math.min(10, score);\r\n}\r\n\r\nfunction detectSeverity(message: string): number {\r\n  let score = 0;\r\n  if (/\\b(site\\s*(down|bloqu\u00E9|inaccessible|ne s['']ouvre pas|crash)|perte\\s*(de\\s*)?(donn\u00E9es|argent|clients?)|impossible\\s+de\\s+(vendre|travailler|acc\u00E9der))\\b/i.test(message)) score = Math.max(score, 8);\r\n  if (/\\b(paiement\\s*(bloqu\u00E9|impossible|refus\u00E9)|commandes?\\s*(bloqu\u00E9e?s?|perdues?)|checkout\\s*(down|bloqu\u00E9|cass\u00E9))\\b/i.test(message)) score = Math.max(score, 6);\r\n  if (/\\b(bloqu\u00E9|blocked|stuck|cass\u00E9|broken|ne fonctionne|doesn['']t work)\\b/i.test(message)) score = Math.max(score, 4);\r\n  if (/\\b(marche|fonctionne)\\s*pas\\b/i.test(message)) score = Math.max(score, 4);\r\n  return Math.min(10, score);\r\n}\r\n\r\n/* ====================================================================\r\n   6. CATEGORY HINT RULES (informational, for LLM prompt + fallback)\r\n   ==================================================================== */\r\n\r\ninterface CategoryRule {\r\n  module: string;\r\n  pattern: RegExp;\r\n  confidence: number;\r\n  reason: string;\r\n}\r\n\r\nconst CATEGORY_RULES: CategoryRule[] = [\r\n  // --- technical (highest confidence \u2014 server errors / crashes) ---\r\n  { module: \"technical\", pattern: /\\b(erreur|error)\\s*(500|502|503|504|5\\d\\d)\\b/i, confidence: 0.95, reason: \"HTTP 5xx error\" },\r\n  { module: \"technical\", pattern: /\\binternal\\s*server\\s*error\\b/i, confidence: 0.95, reason: \"Internal server error\" },\r\n  { module: \"technical\", pattern: /\\bgateway\\s*(timeout|error)\\b/i, confidence: 0.95, reason: \"Gateway error\" },\r\n  { module: \"technical\", pattern: /\\bbad\\s*gateway\\b/i, confidence: 0.95, reason: \"Bad gateway\" },\r\n  { module: \"technical\", pattern: /\\bpanne\\b/i, confidence: 0.8, reason: \"System outage\" },\r\n  { module: \"technical\", pattern: /\\bsite\\s*(crash|down|plant[e\u00E9])\\b/i, confidence: 0.85, reason: \"Site down/crash\" },\r\n  { module: \"technical\", pattern: /\\b(dashboard|tableau de bord|back.?office)\\b.*\\b(erreur|error|5\\d\\d)\\b/i, confidence: 0.9, reason: \"Dashboard error\" },\r\n  { module: \"technical\", pattern: /\\bpage\\s*(blanche|vide)\\b/i, confidence: 0.8, reason: \"Blank page\" },\r\n  { module: \"technical\", pattern: /\\bbug\\s*(technique)?\\b/i, confidence: 0.75, reason: \"Bug report\" },\r\n  { module: \"technical\", pattern: /\\bprobl[e\u00E8]me\\s*technique\\b/i, confidence: 0.85, reason: \"Technical problem\" },\r\n  { module: \"technical\", pattern: /\\b(site|lien|boutique)\\b.*\\b(ne|pas)\\b.*\\b(fonctionne|marche|charge|ouvre|r[e\u00E9]pond)\\b/i, confidence: 0.8, reason: \"Site not working\" },\r\n  { module: \"technical\", pattern: /\\b(ne\\s+charge\\s+pas|ne\\s+s[''']?affiche\\s+pas|ne\\s+r[e\u00E9]pond\\s+pas)\\b/i, confidence: 0.75, reason: \"Page not loading\" },\r\n\r\n  // --- orders ---\r\n  { module: \"orders\", pattern: /\\b(commande|order)s?\\b.*\\b(annul|cancel|rembours|refund|bloqu|stuck|report[e\u00E9]e?|perdue?)\\b/i, confidence: 0.85, reason: \"Order issue\" },\r\n  { module: \"orders\", pattern: /\\b(annul|cancel|rembours|refund|bloqu)\\b.*\\b(commande|order)s?\\b/i, confidence: 0.85, reason: \"Order action\" },\r\n  { module: \"orders\", pattern: /\\b(suivi|tracking)\\s*(commande|order|colis)\\b/i, confidence: 0.8, reason: \"Order tracking\" },\r\n  { module: \"orders\", pattern: /\\b(confirmer|valider|modifier|changer)\\s*(la\\s+)?commande\\b/i, confidence: 0.8, reason: \"Order modification\" },\r\n  { module: \"orders\", pattern: /\\b(\u00E9tat|status|statut)\\s*(de\\s+)?(la\\s+)?commande\\b/i, confidence: 0.8, reason: \"Order status\" },\r\n  { module: \"orders\", pattern: /\\bnum[e\u00E9]ro\\s*(de\\s+)?commande\\b/i, confidence: 0.8, reason: \"Order number\" },\r\n  { module: \"orders\", pattern: /\\b(panier|cart)\\b/i, confidence: 0.7, reason: \"Cart\" },\r\n  { module: \"orders\", pattern: /\\bcheckout\\b/i, confidence: 0.7, reason: \"Checkout\" },\r\n  { module: \"orders\", pattern: /\\bcode\\s*promo\\b/i, confidence: 0.75, reason: \"Promo code\" },\r\n\r\n  // --- products ---\r\n  { module: \"products\", pattern: /\\b(produit|product)s?\\b.*\\b(ajout|cr[e\u00E9]|modif|supprim|import|export|image|photo|prix|fiche|page)/i, confidence: 0.8, reason: \"Product management\" },\r\n  { module: \"products\", pattern: /\\b(ajout|cr[e\u00E9]|modif|supprim|import|export)\\w*\\b.*\\b(produit|product)s?\\b/i, confidence: 0.8, reason: \"Product action\" },\r\n  { module: \"products\", pattern: /\\b(variante?|variant|collection|cat[e\u00E9]gorie|catalogue|catalog)\\b/i, confidence: 0.7, reason: \"Product catalog\" },\r\n  { module: \"products\", pattern: /\\bsku\\b/i, confidence: 0.75, reason: \"SKU reference\" },\r\n  { module: \"products\", pattern: /\\bfiche\\s*produit\\b/i, confidence: 0.85, reason: \"Product page\" },\r\n\r\n  // --- shipping ---\r\n  { module: \"shipping\", pattern: /\\b(livraison|shipping|exp[e\u00E9]dition|expedition)\\b/i, confidence: 0.8, reason: \"Shipping\" },\r\n  { module: \"shipping\", pattern: /\\b(colis|manifeste|manifest|[e\u00E9]tiquette|etiquette|bordereau)\\b/i, confidence: 0.8, reason: \"Shipment label/manifest\" },\r\n  { module: \"shipping\", pattern: /\\b(transporteur|carrier|livreur)\\b/i, confidence: 0.8, reason: \"Carrier\" },\r\n  { module: \"shipping\", pattern: /\\b(douchette|scanner|scan|barcode)\\b/i, confidence: 0.75, reason: \"Scan device\" },\r\n  { module: \"shipping\", pattern: /\\b(retour|return)\\s*(colis|produit|commande)\\b/i, confidence: 0.75, reason: \"Return shipment\" },\r\n  { module: \"shipping\", pattern: /\\b(ramassage|pickup|collecte)\\b/i, confidence: 0.7, reason: \"Pickup\" },\r\n  { module: \"shipping\", pattern: /\\b(poids|weight)\\b.*\\b(colis|bordereau)\\b/i, confidence: 0.8, reason: \"Package weight\" },\r\n\r\n  // --- payments ---\r\n  { module: \"payments\", pattern: /\\b(paiement|payment)\\b.*\\b(erreur|error|refus[e\u00E9]?|[e\u00E9]chec|fail|bloqu)\\b/i, confidence: 0.8, reason: \"Payment error\" },\r\n  { module: \"payments\", pattern: /\\b(erreur|error|refus|[e\u00E9]chec|fail)\\b.*\\b(paiement|payment|checkout)\\b/i, confidence: 0.8, reason: \"Error in payment\" },\r\n  { module: \"payments\", pattern: /\\b(carte\\s*(bancaire)?|visa|mastercard|cb|stripe|tpe)\\b/i, confidence: 0.75, reason: \"Payment method\" },\r\n  { module: \"payments\", pattern: /\\b(transaction|passerelle|gateway)\\b.*\\b(paiement|payment)?\\b/i, confidence: 0.7, reason: \"Payment gateway\" },\r\n  { module: \"payments\", pattern: /\\b3ds\\b/i, confidence: 0.8, reason: \"3DS payment\" },\r\n\r\n  // --- billing ---\r\n  { module: \"billing\", pattern: /\\b(facturation|facture|invoice)s?\\b/i, confidence: 0.8, reason: \"Billing/invoice\" },\r\n  { module: \"billing\", pattern: /\\b(plan|forfait|abonnement|subscription)\\b/i, confidence: 0.7, reason: \"Plan/subscription\" },\r\n  { module: \"billing\", pattern: /\\b(renouvellement|upgrade|downgrade)\\b/i, confidence: 0.75, reason: \"Plan change\" },\r\n  { module: \"billing\", pattern: /\\b(facture|\\u0641\\u0627\\u062a\\u0648\\u0631\\u0629)\\s*(mensuelle|\u0634\u0647\u0631\u064A\u0629)?\\b/i, confidence: 0.8, reason: \"Invoice inquiry\" },\r\n\r\n  // --- settings ---\r\n  { module: \"settings\", pattern: /\\b(domaine|domain)s?\\b/i, confidence: 0.75, reason: \"Domain\" },\r\n  { module: \"settings\", pattern: /\\b(dns|ssl|https|certificat|certificate|cloudflare|nameserver)\\b/i, confidence: 0.8, reason: \"DNS/SSL\" },\r\n  { module: \"settings\", pattern: /\\b(param[e\u00E8]tres?|configuration|r[e\u00E9]glages?)\\s*(du\\s+)?(site|boutique)?\\b/i, confidence: 0.7, reason: \"Site settings\" },\r\n  { module: \"settings\", pattern: /\\berreur\\s*(403|404)\\b/i, confidence: 0.8, reason: \"HTTP 4xx error\" },\r\n  { module: \"settings\", pattern: /\\blangue\\s*(du\\s+)?site\\b/i, confidence: 0.75, reason: \"Site language\" },\r\n\r\n  // --- builder ---\r\n  { module: \"builder\", pattern: /\\b(template|th[e\u00E8]me|theme|design|mise en page|layout)\\b/i, confidence: 0.75, reason: \"Site design\" },\r\n  { module: \"builder\", pattern: /\\b(header|footer|en-t[e\u00EA]te|pied de page|banni[e\u00E8]re|banner|slider)\\b/i, confidence: 0.8, reason: \"Page element\" },\r\n  { module: \"builder\", pattern: /\\b(section|bloc|block|popup|bouton|button|formulaire)\\b/i, confidence: 0.7, reason: \"Page block\" },\r\n  { module: \"builder\", pattern: /\\b(page d[''']accueil|homepage|accueil)\\b/i, confidence: 0.7, reason: \"Homepage\" },\r\n  { module: \"builder\", pattern: /\\b(logo|favicon|couleur|color|police|font|css|style)\\b/i, confidence: 0.7, reason: \"Visual styling\" },\r\n  { module: \"builder\", pattern: /\\b(modifier|ajouter|supprimer|cr[e\u00E9]er)\\s*(la\\s+|une\\s+)?page\\b/i, confidence: 0.8, reason: \"Page editing\" },\r\n  { module: \"builder\", pattern: /\\b(contenu|content|cms|seo)\\b/i, confidence: 0.65, reason: \"Content/CMS\" },\r\n\r\n  // --- customers ---\r\n  { module: \"customers\", pattern: /\\b(fiche|compte|profil|liste|gestion)\\s*(de\\s+|des\\s+|du\\s+)?(client|clients|customer|customers)\\b/i, confidence: 0.8, reason: \"Customer management\" },\r\n  { module: \"customers\", pattern: /\\b(client|customer)s?\\b.*\\b(supprim|modif|ajout|cr[e\u00E9]|import|export|donn[e\u00E9]es)\\b/i, confidence: 0.75, reason: \"Customer action\" },\r\n  { module: \"customers\", pattern: /\\b(utilisateur|user)s?\\b.*\\b(profil|compte|gestion)\\b/i, confidence: 0.7, reason: \"User profile\" },\r\n\r\n  // --- pos ---\r\n  { module: \"pos\", pattern: /\\b(pos|caisse|point\\s*de\\s*vente|terminal\\s*de\\s*vente)\\b/i, confidence: 0.85, reason: \"POS terminal\" },\r\n  { module: \"pos\", pattern: /\\b(vente\\s*(en\\s+)?(magasin|boutique\\s*physique)|magasin)\\b/i, confidence: 0.75, reason: \"In-store sale\" },\r\n  { module: \"pos\", pattern: /\\b(session\\s*caisse|ticket\\s*de\\s*caisse|bon\\s*de\\s*caisse)\\b/i, confidence: 0.85, reason: \"POS session/receipt\" },\r\n  { module: \"pos\", pattern: /\\bfacture\\s*pos\\b/i, confidence: 0.9, reason: \"POS invoice\" },\r\n\r\n  // --- auth ---\r\n  { module: \"auth\", pattern: /\\b(login|connexion|se\\s+connecter|me\\s+connecter)\\b/i, confidence: 0.8, reason: \"Login\" },\r\n  { module: \"auth\", pattern: /\\b(mot\\s*de\\s*passe|password)\\b/i, confidence: 0.85, reason: \"Password\" },\r\n  { module: \"auth\", pattern: /\\b(otp|2fa|authentification|v[e\u00E9]rification)\\b/i, confidence: 0.85, reason: \"Auth verification\" },\r\n  { module: \"auth\", pattern: /\\b(d[e\u00E9]connexion|d[e\u00E9]connect[e\u00E9]|session\\s*expir[e\u00E9]e?)\\b/i, confidence: 0.8, reason: \"Session/logout\" },\r\n  { module: \"auth\", pattern: /\\b(r[e\u00E9]initialiser|reset|oubli[e\u00E9]?)\\s*(mot\\s*de\\s*passe|password)\\b/i, confidence: 0.85, reason: \"Password reset\" },\r\n  { module: \"auth\", pattern: /\\bacc[e\u00E8]s\\b.*\\b(refus|bloqu|interdit|denied)\\b/i, confidence: 0.8, reason: \"Access denied\" },\r\n\r\n  // --- inventory ---\r\n  { module: \"inventory\", pattern: /\\b(stock|inventaire|inventory)\\b/i, confidence: 0.8, reason: \"Inventory\" },\r\n  { module: \"inventory\", pattern: /\\b(rupture\\s*(de\\s*)?stock|hors\\s*stock|out\\s*of\\s*stock)\\b/i, confidence: 0.85, reason: \"Out of stock\" },\r\n  { module: \"inventory\", pattern: /\\b(quantit[e\u00E9]|disponibilit[e\u00E9]|stock\\s*n[e\u00E9]gatif)\\b/i, confidence: 0.75, reason: \"Stock quantity\" },\r\n  { module: \"inventory\", pattern: /\\b(gestion|mise\\s*[a\u00E0]\\s*jour|sync|synchronis)\\b.*\\bstock\\b/i, confidence: 0.8, reason: \"Stock management\" },\r\n\r\n  // --- notifications ---\r\n  { module: \"notifications\", pattern: /\\bnotification(s)?\\b/i, confidence: 0.8, reason: \"Notification\" },\r\n  { module: \"notifications\", pattern: /\\b(email|mail)\\s*(automatique|de\\s*confirmation|notification)\\b/i, confidence: 0.8, reason: \"Email notification\" },\r\n  { module: \"notifications\", pattern: /\\b(alerte|alertes)\\b/i, confidence: 0.7, reason: \"Alert\" },\r\n  { module: \"notifications\", pattern: /\\bsms\\b/i, confidence: 0.7, reason: \"SMS\" },\r\n  { module: \"notifications\", pattern: /\\b(notification|alerte)\\s*(commande|client|push)\\b/i, confidence: 0.8, reason: \"Order/client notification\" },\r\n\r\n  // --- apps ---\r\n  { module: \"apps\", pattern: /\\b(api|endpoint|webhook)s?\\b/i, confidence: 0.75, reason: \"API/webhook\" },\r\n  { module: \"apps\", pattern: /\\b(int[e\u00E9]gration|integration)s?\\b/i, confidence: 0.7, reason: \"Integration\" },\r\n  { module: \"apps\", pattern: /\\b(module|modules|application|applications)\\b/i, confidence: 0.65, reason: \"App/module\" },\r\n  { module: \"apps\", pattern: /\\b(facebook\\s*pixel|pixel|leads\\s*facebook|tracking\\s*automatique)\\b/i, confidence: 0.8, reason: \"Facebook/tracking pixel\" },\r\n  { module: \"apps\", pattern: /\\b(shipper|first\\s*delivery)\\b/i, confidence: 0.75, reason: \"Shipper integration\" },\r\n\r\n  // --- general (complaints/frustration \u2014 low confidence) ---\r\n  { module: \"general\", pattern: /\\b(tr[e\u00E8]s\\s*d[e\u00E9][c\u00E7]u|m[e\u00E9]content|furieux|inacceptable|scandale|scandaleux|honteux)\\b/i, confidence: 0.7, reason: \"Complaint/frustration\" },\r\n  { module: \"general\", pattern: /\\b(responsable|manager|superviseur)\\b/i, confidence: 0.6, reason: \"Escalation demand\" },\r\n  { module: \"general\", pattern: /\\bremboursez\\b/i, confidence: 0.7, reason: \"Refund demand\" },\r\n  { module: \"general\", pattern: /\\b(activ|cr[e\u00E9])\\b.*\\b(compte|boutique)\\b/i, confidence: 0.7, reason: \"Account/shop activation\" },\r\n  { module: \"general\", pattern: /\\b(changer|modifier)\\s*(le\\s+)?nom\\s*(de\\s+)?(la\\s+)?boutique\\b/i, confidence: 0.7, reason: \"Shop name change\" },\r\n  { module: \"general\", pattern: /\\bcompte\\s*bloqu[e\u00E9]\\b/i, confidence: 0.75, reason: \"Blocked account\" },\r\n  { module: \"general\", pattern: /\\bduplication\\b/i, confidence: 0.7, reason: \"Duplication\" },\r\n];\r\n\r\nfunction generateCategoryHints(message: string): GovernanceSignals[\"categoryHints\"] {\r\n  const hints: GovernanceSignals[\"categoryHints\"] = [];\r\n  for (const rule of CATEGORY_RULES) {\r\n    if (rule.pattern.test(message)) {\r\n      hints.push({ module: rule.module, confidence: rule.confidence, reason: rule.reason });\r\n    }\r\n  }\r\n  const byModule = new Map<string, { module: string; confidence: number; reason: string }>();\r\n  for (const hint of hints) {\r\n    const existing = byModule.get(hint.module);\r\n    if (!existing || hint.confidence > existing.confidence) byModule.set(hint.module, hint);\r\n  }\r\n  return Array.from(byModule.values()).sort((a, b) => b.confidence - a.confidence);\r\n}\r\n\r\n/* ====================================================================\r\n   7. MAIN: governanceScan(message) \u2014 decision table, first-match-wins\r\n   ==================================================================== */\r\n\r\nexport function runGovernance(message: string): GovernanceSignals {\r\n  // Run all scanners\r\n  const emotion = scanEmotions(message);\r\n  const httpError = scanHttpErrors(message);\r\n  const isSiteDown = scanSiteDown(message);\r\n  const persistenceScore = detectPersistence(message);\r\n  const severityScore = detectSeverity(message);\r\n  const categoryHints = generateCategoryHints(message);\r\n\r\n  // Decision table\r\n  let tag: GovTag = \"none\";\r\n  const force: GovernanceSignals[\"force\"] = {};\r\n\r\n  // P0: HTTP false-positive \u2192 block HTTP rules, no forced outputs\r\n  if (httpError.falsePositive) {\r\n    tag = \"http_false_positive\";\r\n  }\r\n  // P1 + P2 combo: HTTP 5xx AND emotion\r\n  else if (httpError.detected && emotion.detected) {\r\n    tag = \"http_5xx_emotion\";\r\n    force.category = \"technical\";\r\n    force.verdict = \"tiktak_side\";\r\n    force.escalate = true;\r\n    force.severity = \"critical\";\r\n    force.ticket_type = \"incident\";\r\n    force.sentiment = emotion.sentiment;\r\n  }\r\n  // P1: HTTP 5xx incident (no emotion)\r\n  else if (httpError.detected) {\r\n    tag = \"http_5xx\";\r\n    force.category = \"technical\";\r\n    force.verdict = \"tiktak_side\";\r\n    force.escalate = true;\r\n    force.severity = \"critical\";\r\n    force.ticket_type = \"incident\";\r\n  }\r\n  // P2: Emotional message \u2014 inform sentiment, do NOT force escalation\r\n  else if (emotion.detected) {\r\n    tag = \"emotion\";\r\n    force.sentiment = emotion.sentiment;\r\n    // emotion alone never triggers escalation (L0/L1 philosophy)\r\n  }\r\n  // P3: Site/link down without explicit 5xx\r\n  else if (isSiteDown) {\r\n    tag = \"site_down\";\r\n    force.category = \"technical\";\r\n    force.verdict = \"tiktak_side\";\r\n    force.escalate = true;\r\n    force.severity = \"high\";\r\n    force.ticket_type = \"bug\";\r\n  }\r\n\r\n  // Legacy compat fields\r\n  const forceEscalate = force.escalate === true;\r\n  const escalationScore = forceEscalate ? 9 : (emotion.detected ? Math.min(emotion.score, 5) : 0);\r\n  const recommendEscalate = forceEscalate || httpError.detected || isSiteDown;\r\n\r\n  return {\r\n    tag,\r\n    emotion,\r\n    httpError,\r\n    force,\r\n    categoryHints,\r\n    persistenceScore,\r\n    severityScore,\r\n    escalationScore,\r\n    forceEscalate,\r\n    recommendEscalate,\r\n  };\r\n}\r\n\r\n/* ====================================================================\r\n   8. GOVERNANCE \u2192 LLM PROMPT HINTS\r\n   ==================================================================== */\r\n\r\nexport function governanceToPromptHints(gov: GovernanceSignals): string {\r\n  const parts: string[] = [];\r\n\r\n  if (gov.tag === \"http_5xx\" || gov.tag === \"http_5xx_emotion\") {\r\n    parts.push(\"ERREUR SERVEUR 5xx DETECTEE \u2014 INCIDENT TECHNIQUE.\");\r\n    parts.push('OBLIGATOIRE: category=\"technical\", verdict=\"tiktak_side\", escalate=true, ticket_type=\"incident\", severity=\"critical\".');\r\n    parts.push(\"Reconnaitre le probleme technique et expliquer que l equipe va investiguer.\");\r\n  }\r\n\r\n  if (gov.tag === \"http_false_positive\") {\r\n    parts.push('\"500\" detecte mais c est une quantite, PAS une erreur serveur. NE PAS escalader pour cela. escalate=false.');\r\n  }\r\n\r\n  if (gov.tag === \"site_down\") {\r\n    parts.push(\"SITE/LIEN EN PANNE DETECTE \u2014 INCIDENT TECHNIQUE.\");\r\n    parts.push('OBLIGATOIRE: category=\"technical\", verdict=\"tiktak_side\", escalate=true.');\r\n  }\r\n\r\n  if (gov.emotion.detected) {\r\n    parts.push(\"EMOTION DETECTEE (sentiment: \" + gov.emotion.sentiment + \", triggers: \" + gov.emotion.triggers.join(\", \") + \")\");\r\n    if (gov.tag === \"emotion\") {\r\n      parts.push(\"Le marchand est frustre/en colere. Commence par reconnaitre son emotion PUIS aide-le.\");\r\n      parts.push(\"NE PAS escalader juste pour l emotion. Pose des questions pour comprendre le probleme.\");\r\n    }\r\n  }\r\n\r\n  if (gov.persistenceScore >= 4) {\r\n    parts.push(\"CONTACT REPETE (persistence: \" + gov.persistenceScore + \"/10) \u2014 le marchand attend depuis longtemps.\");\r\n  }\r\n\r\n  if (gov.categoryHints.length > 0 && !gov.force.category) {\r\n    const top = gov.categoryHints[0];\r\n    parts.push(\"Categorie suggeree: \" + top.module + \" (\" + (top.confidence * 100).toFixed(0) + \"%) \u2014 \" + top.reason);\r\n  }\r\n\r\n  if (gov.forceEscalate && gov.tag !== \"http_false_positive\") {\r\n    parts.push(\"\");\r\n    parts.push('DIRECTIVE OBLIGATOIRE: escalate=true, verdict=\"tiktak_side\".');\r\n    parts.push(\"Commence ta reponse par reconnaitre l emotion/probleme du marchand.\");\r\n  }\r\n\r\n  return parts.length > 0 ? \"\\n--- SIGNAUX GOUVERNANCE (pre-analyse automatique) ---\\n\" + parts.join(\"\\n\") : \"\";\r\n}\r\n\r\n/* ====================================================================\r\n   9. POST-LLM OVERRIDE: validatePostLlm(gov, llmOutput)\r\n   ==================================================================== */\r\n\r\nexport interface PostLlmOverrides {\r\n  escalate?: boolean;\r\n  verdict?: \"user_side\" | \"tiktak_side\" | \"unclear\";\r\n  severity?: string;\r\n  sentiment?: string;\r\n  ticket_type?: string;\r\n  category?: string;\r\n  overrideReasons: string[];\r\n}\r\n\r\n/**\r\n * Deterministic post-LLM correction.\r\n *\r\n * R1  tag=http_5xx|http_5xx_emotion|site_down \u2192 force technical/tiktak_side/escalate\r\n * R2  tag=emotion \u2192 force general + escalate\r\n * R3  tag=http_false_positive + llm escalated + emotion < 5 \u2192 de-escalate\r\n * R4  Severity bump for strong emotion\r\n * R5  Severity bump for HTTP errors\r\n * R6  Sentiment correction\r\n * R7  Category fallback from hints\r\n */\r\nexport function validatePostLlm(\r\n  gov: GovernanceSignals,\r\n  llmOutput: {\r\n    escalate: boolean;\r\n    verdict: string;\r\n    category: string;\r\n    severity: string;\r\n    sentiment: string;\r\n    ticket_type: string;\r\n  }\r\n): PostLlmOverrides {\r\n  const o: PostLlmOverrides = { overrideReasons: [] };\r\n\r\n  // R1: HTTP 5xx / site-down \u2192 force technical incident\r\n  if (gov.tag === \"http_5xx\" || gov.tag === \"http_5xx_emotion\" || gov.tag === \"site_down\") {\r\n    if (llmOutput.category !== \"technical\") {\r\n      o.category = \"technical\";\r\n      o.overrideReasons.push(\"R1_category: tag=\" + gov.tag + \" force technical (was \" + llmOutput.category + \")\");\r\n    }\r\n    if (llmOutput.verdict !== \"tiktak_side\") {\r\n      o.verdict = \"tiktak_side\";\r\n      o.overrideReasons.push(\"R1_verdict: tag=\" + gov.tag + \" force tiktak_side\");\r\n    }\r\n    if (!llmOutput.escalate) {\r\n      o.escalate = true;\r\n      o.overrideReasons.push(\"R1_escalate: tag=\" + gov.tag + \" force escalate=true\");\r\n    }\r\n    if (llmOutput.severity !== \"critical\" && llmOutput.severity !== \"high\") {\r\n      o.severity = gov.tag === \"site_down\" ? \"high\" : \"critical\";\r\n      o.overrideReasons.push(\"R1_severity: \" + o.severity);\r\n    }\r\n    if (gov.tag !== \"site_down\" && llmOutput.ticket_type !== \"incident\") {\r\n      o.ticket_type = \"incident\";\r\n      o.overrideReasons.push(\"R1_ticket_type: incident\");\r\n    }\r\n  }\r\n\r\n  // R2: Pure emotion \u2014 only correct sentiment, do NOT force escalation\r\n  if (gov.tag === \"emotion\") {\r\n    // Let LLM decide category and escalation based on actual problem\r\n    // Only correct sentiment if LLM missed it\r\n    if (gov.emotion.score >= 7 && llmOutput.sentiment === \"calm\") {\r\n      o.sentiment = gov.emotion.sentiment;\r\n      o.overrideReasons.push(\"R2_sentiment: tag=emotion score=\" + gov.emotion.score + \" correct sentiment\");\r\n    }\r\n  }\r\n\r\n  // R3: HTTP false-positive de-escalation\r\n  if (gov.tag === \"http_false_positive\" && llmOutput.escalate && gov.emotion.score < 5) {\r\n    o.escalate = false;\r\n    o.overrideReasons.push(\"R3_deescalate: false_positive 500 is quantity, suppress LLM escalation\");\r\n  }\r\n\r\n  // R4: Severity bump for strong emotion\r\n  if (gov.emotion.score >= 7 && (llmOutput.severity === \"low\" || llmOutput.severity === \"medium\") && !o.severity) {\r\n    o.severity = \"high\";\r\n    o.overrideReasons.push(\"R4_severity: emotion=\" + gov.emotion.score + \" high\");\r\n  }\r\n\r\n  // R5: Severity bump for HTTP errors\r\n  if (gov.httpError.detected && !gov.httpError.falsePositive && !o.severity) {\r\n    if (llmOutput.severity !== \"critical\") {\r\n      o.severity = \"high\";\r\n      o.overrideReasons.push(\"R5_severity: HTTP detected high\");\r\n    }\r\n  }\r\n\r\n  // R6: Sentiment correction\r\n  if (gov.emotion.score >= 7 && llmOutput.sentiment === \"calm\") {\r\n    o.sentiment = gov.emotion.sentiment;\r\n    o.overrideReasons.push(\"R6_sentiment: emotion=\" + gov.emotion.score + \" \" + gov.emotion.sentiment);\r\n  }\r\n\r\n  // R7: Category fallback from hints (only if not already set by R1/R2)\r\n  if (!o.category && gov.categoryHints.length > 0) {\r\n    const topHint = gov.categoryHints[0];\r\n    if (topHint.confidence >= 0.7 && topHint.module !== llmOutput.category) {\r\n      const isLlmGeneric = llmOutput.category === \"general\" || llmOutput.category === \"unclear\";\r\n      if (isLlmGeneric) {\r\n        o.category = topHint.module;\r\n        o.overrideReasons.push(\"R7_category: hint=\" + topHint.module + \"(\" + (topHint.confidence * 100).toFixed(0) + \"%) vs llm=\" + llmOutput.category);\r\n      }\r\n    }\r\n  }\r\n\r\n  return o;\r\n}\r\n", "// src/routes.ts \u2014 HTTP route handlers with unified post-LLM logic (fixes G3)\r\n// v3.1: Governance layer integration for deterministic escalation + category routing\r\nimport type { Env, HistoryMsg, ChatState, PlaybookIngestItem, DocChunk, RetrievalContext } from \"./types\";\r\nimport { CHAT_MODEL } from \"./types\";\r\nimport { json, corsHeaders, safeReadJson, toStr, clamp01, normalizeSupportResponse, augmentSignals, mergeFollowupIntoQuery, setWaitingState } from \"./helpers\";\r\nimport { canonicalModule, toCoarseModule, detectPreferredModule, extractEntities, detectLanguage, checkHardEscalation, isGreetingOnly, isThanksOnly, inferModuleFromRetrieval } from \"./detection\";\r\nimport { buildLlmMessages } from \"./prompt\";\r\nimport { embedText, smartFetchContext, buildKnowledgeContext, gatherEvidence, computeConfidence } from \"./rag\";\r\nimport { runGovernance, governanceToPromptHints, validatePostLlm, type GovernanceSignals } from \"./governance\";\r\n\r\n/* ----------------------------- Helpers ----------------------------- */\r\n\r\n/**\r\n * Extract the dominant module from RAG retrieval results (playbooks + docs).\r\n * Returns the module with the highest weighted score, or null.\r\n */\r\nfunction inferRagTopModule(pbCtx: RetrievalContext, docsCtx: RetrievalContext): string | null {\r\n  const moduleScores: Record<string, number> = {};\r\n  for (const item of pbCtx.items) {\r\n    const mod = canonicalModule(item.module);\r\n    if (mod && mod !== \"general\") moduleScores[mod] = (moduleScores[mod] || 0) + item.score * 2;\r\n  }\r\n  for (const item of docsCtx.items) {\r\n    const mod = canonicalModule(item.module);\r\n    if (mod && mod !== \"general\") moduleScores[mod] = (moduleScores[mod] || 0) + item.score;\r\n  }\r\n  const entries = Object.entries(moduleScores);\r\n  if (entries.length === 0) return null;\r\n  entries.sort((a, b) => b[1] - a[1]);\r\n  return toCoarseModule(entries[0][0]);\r\n}\r\n\r\nfunction chatJson(req: Request, data: any, status = 200) {\r\n  return json(req, normalizeSupportResponse(data), status);\r\n}\r\n\r\n/* \u2500\u2500 Orchestration guardrail helpers \u2500\u2500 */\r\n\r\nfunction lastAssistantText(history: HistoryMsg[]): string {\r\n  for (let i = history.length - 1; i >= 0; i--) {\r\n    if (history[i].role === \"assistant\") return String(history[i].content || \"\");\r\n  }\r\n  return \"\";\r\n}\r\n\r\nfunction normText(s: string): string {\r\n  return s.toLowerCase().replace(/\\s+/g, \" \").replace(/[^\\p{L}\\p{N}\\s]/gu, \"\").trim();\r\n}\r\n\r\n/** Cheap token-overlap similarity (0\u20131). No embeddings needed. */\r\nfunction cheapSim(a: string, b: string): number {\r\n  const A = new Set(normText(a).split(\" \").filter(Boolean));\r\n  const B = new Set(normText(b).split(\" \").filter(Boolean));\r\n  if (A.size === 0 || B.size === 0) return 0;\r\n  let inter = 0;\r\n  for (const t of A) if (B.has(t)) inter++;\r\n  return inter / Math.max(A.size, B.size);\r\n}\r\n\r\n/** Build a short state summary from history for the LLM routing hints. */\r\nfunction buildHistoryStateSummary(history: HistoryMsg[], currentModule: string): string {\r\n  if (history.length === 0) return \"\";\r\n  const assistantMsgs = history.filter(h => h.role === \"assistant\").map(h => String(h.content || \"\"));\r\n  const userMsgs = history.filter(h => h.role === \"user\").map(h => String(h.content || \"\"));\r\n  if (assistantMsgs.length === 0) return \"\";\r\n\r\n  const parts: string[] = [];\r\n  parts.push(`\u00C9TAT CONVERSATION: ${assistantMsgs.length} r\u00E9ponses d\u00E9j\u00E0 donn\u00E9es.`);\r\n  parts.push(`Module: ${currentModule}.`);\r\n\r\n  // Detect user claims (confirmation / persistence)\r\n  const userClaims: string[] = [];\r\n  for (const msg of userMsgs) {\r\n    const m = msg.toLowerCase();\r\n    if (/tout\\s+(est\\s+)?v[\u00E9e]rifi[\u00E9e]|j['\u2019]ai\\s+(tout\\s+)?(fait|essay\u00E9|v\u00E9rifi\u00E9)/i.test(m)) userClaims.push(\"all_verified\");\r\n    if (/persist|toujours\\s+pareil|m\u00EAme\\s+probl|\u00E7a\\s+change\\s+rien|marche\\s+toujours\\s+pas/i.test(m)) userClaims.push(\"problem_persists\");\r\n    if (/c['\u2019]est\\s+bon|ok|d['\u2019]accord|merci/i.test(m) && userMsgs.indexOf(msg) < userMsgs.length - 1) userClaims.push(\"acknowledged\");\r\n  }\r\n  if (userClaims.length > 0) parts.push(`Le marchand affirme: ${[...new Set(userClaims)].join(\", \")}.`);\r\n\r\n  // Summarize previous steps given\r\n  const lastAnswer = assistantMsgs[assistantMsgs.length - 1];\r\n  if (lastAnswer.length > 30) {\r\n    parts.push(`Derni\u00E8re r\u00E9ponse (r\u00E9sum\u00E9): \"${lastAnswer.slice(0, 150)}\u2026\"`);\r\n  }\r\n\r\n  parts.push(\"NE R\u00C9P\u00C8TE PAS les m\u00EAmes \u00E9tapes. Propose une alternative ou pose une question cibl\u00E9e.\");\r\n  return \"\\n--- \u00C9TAT M\u00C9MOIRE ---\\n\" + parts.join(\"\\n\");\r\n}\r\n\r\nconst BANNED_TERMS_RE = /\\b(playbook|documentation|docs|notre guide|consulter le guide|consulter la doc|dans la documentation)\\b/i;\r\n\r\n/* ----------------------------- LLM call (non-streaming) ----------------------------- */\r\n\r\nasync function runStructuredChat(\r\n  env: Env,\r\n  currentMessage: string,\r\n  history: HistoryMsg[],\r\n  knowledgeContext: string,\r\n  routingHints: string,\r\n  maxTokens = 900,\r\n  opts?: { turnCount?: number; sentiment?: string }\r\n): Promise<any> {\r\n  const messages = buildLlmMessages(currentMessage, history, knowledgeContext, routingHints, opts);\r\n\r\n  try {\r\n    const result = (await env.AI.run(CHAT_MODEL as any, {\r\n      messages,\r\n      max_tokens: maxTokens,\r\n      temperature: 0.3,\r\n    })) as any;\r\n\r\n    let content = (result?.response || \"\").trim();\r\n    if (!content) return {};\r\n\r\n    // Prepend the \"{\" we used as prefill\r\n    if (!content.startsWith(\"{\")) content = \"{\" + content;\r\n\r\n    // Try 1: full JSON extraction\r\n    const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\r\n    if (jsonMatch) {\r\n      try {\r\n        return JSON.parse(jsonMatch[0]);\r\n      } catch {\r\n        // Try 2: JSON was truncated by max_tokens \u2014 close it\r\n        try {\r\n          let truncated = jsonMatch[0];\r\n          truncated = truncated.replace(/,\\s*\"[^\"]*\"?\\s*:?\\s*\"?[^\"]*$/, \"\");\r\n          if (!truncated.endsWith(\"}\")) truncated += \"}\";\r\n          return JSON.parse(truncated);\r\n        } catch { /* fall through */ }\r\n      }\r\n    }\r\n\r\n    // Try 3: extract \"answer\" field directly from malformed JSON\r\n    const answerFieldMatch = content.match(/\"answer\"\\s*:\\s*\"((?:[^\"\\\\]|\\\\.)*)\"/);\r\n    if (answerFieldMatch) {\r\n      const extractedAnswer = answerFieldMatch[1].replace(/\\\\\"/g, '\"').replace(/\\\\n/g, \"\\n\");\r\n      const verdictMatch = content.match(/\"verdict\"\\s*:\\s*\"([^\"]+)\"/);\r\n      const confMatch = content.match(/\"confidence\"\\s*:\\s*([\\d.]+)/);\r\n      const catMatch = content.match(/\"category\"\\s*:\\s*\"([^\"]+)\"/);\r\n      const escMatch = content.match(/\"escalate\"\\s*:\\s*(true|false)/);\r\n      return {\r\n        verdict: verdictMatch?.[1] || \"user_side\",\r\n        confidence: confMatch ? parseFloat(confMatch[1]) : 0.7,\r\n        category: catMatch?.[1] || \"general\",\r\n        answer: extractedAnswer,\r\n        next_question: null,\r\n        escalate: escMatch?.[1] === \"true\" || false,\r\n        evidence: [],\r\n        actions: [],\r\n      };\r\n    }\r\n\r\n    // Fallback: model returned pure plain text \u2014 wrap it\r\n    console.log(\"[LLM] No valid JSON, extracting plain text:\", content.slice(0, 200));\r\n    const plainAnswer = content\r\n      .replace(/^[{\\s\"]*/, \"\")\r\n      .replace(/[}\\s\"]*$/, \"\")\r\n      .trim();\r\n    if (plainAnswer.length > 10) {\r\n      return {\r\n        verdict: \"user_side\",\r\n        confidence: 0.65,\r\n        category: \"general\",\r\n        answer: plainAnswer,\r\n        next_question: null,\r\n        escalate: false,\r\n        evidence: [],\r\n        actions: [],\r\n      };\r\n    }\r\n\r\n    console.error(\"No usable AI response:\", content.slice(0, 200));\r\n    return {};\r\n  } catch (e) {\r\n    console.error(\"AI error:\", e);\r\n    return {};\r\n  }\r\n}\r\n\r\n/* ----------------------------- G3 FIX: Unified post-LLM processing ----------------------------- */\r\n\r\n/**\r\n * Process LLM diagnosis into a final structured response.\r\n * Shared between handleChat and handleChatStream \u2014 fixes G3 (duplicated post-LLM logic).\r\n */\r\nfunction processLlmDiagnosis(opts: {\r\n  diag: any;\r\n  message: string;\r\n  originalMessage: string;\r\n  preferredModule: string;\r\n  keywordScore: number;\r\n  pbCtx: import(\"./types\").RetrievalContext;\r\n  docsCtx: import(\"./types\").RetrievalContext;\r\n  state: ChatState;\r\n  t0: number;\r\n  governance?: GovernanceSignals;\r\n  history: HistoryMsg[];\r\n  entities?: import(\"./types\").ExtractedEntities;\r\n}): any {\r\n  const { diag, message, originalMessage, preferredModule, keywordScore, pbCtx, docsCtx, state, t0, governance, history, entities } = opts;\r\n\r\n  // --- LLM-FIRST: Trust the LLM's outputs as primary signals ---\r\n  const llmCategory = toCoarseModule(diag?.category || preferredModule || \"general\");\r\n  const verdictRaw = toStr(diag?.verdict || \"unclear\");\r\n  const llmVerdict: \"user_side\" | \"tiktak_side\" | \"unclear\" =\r\n    ([\"user_side\", \"tiktak_side\", \"unclear\"].includes(verdictRaw))\r\n      ? (verdictRaw as \"user_side\" | \"tiktak_side\" | \"unclear\")\r\n      : \"unclear\";\r\n  const rawLlmConfidence = clamp01(typeof diag?.confidence === \"number\" ? diag.confidence : 0.5);\r\n  const llmEscalate = diag?.escalate === true;\r\n  const llmAnswer = typeof diag?.answer === \"string\" ? diag.answer : \"\";\r\n  const llmNextQuestion =\r\n    typeof diag?.next_question === \"string\" && diag.next_question.trim()\r\n      ? diag.next_question.trim()\r\n      : null;\r\n\r\n  // --- P0 fields from LLM ---\r\n  const VALID_TICKET_TYPES = [\"bug\", \"question\", \"demand\", \"incident\"];\r\n  const llmTicketType = VALID_TICKET_TYPES.includes(diag?.ticket_type) ? diag.ticket_type : \"question\";\r\n  const VALID_SENTIMENTS = [\"calm\", \"frustrated\", \"urgent\", \"satisfied\"];\r\n  const llmSentiment = VALID_SENTIMENTS.includes(diag?.sentiment) ? diag.sentiment : \"calm\";\r\n  const VALID_SEVERITIES = [\"low\", \"medium\", \"high\", \"critical\"];\r\n  const llmSeverity = VALID_SEVERITIES.includes(diag?.severity) ? diag.severity : \"low\";\r\n  const llmLanguage = [\"fr\", \"ar\", \"darija\", \"en\"].includes(diag?.detected_language)\r\n    ? diag.detected_language\r\n    : detectLanguage(message);\r\n\r\n  // R5: Compute confidence from multiple signals\r\n  const llmConfidence = computeConfidence({\r\n    llmConfidence: rawLlmConfidence,\r\n    topVectorizeScore: Math.max(pbCtx.topScore, docsCtx.topScore),\r\n    keywordScore,\r\n    answerLength: llmAnswer.length,\r\n  });\r\n\r\n  // \u2500\u2500 GOVERNANCE POST-LLM VALIDATION \u2500\u2500\r\n  // Replaces the old checkHardEscalation() with the full governance layer\r\n  const hardEsc = checkHardEscalation(message); // backward compat\r\n  let govOverrides: import(\"./governance\").PostLlmOverrides = { overrideReasons: [] };\r\n  if (governance) {\r\n    govOverrides = validatePostLlm(governance, {\r\n      escalate: llmEscalate,\r\n      verdict: llmVerdict,\r\n      category: llmCategory,\r\n      severity: llmSeverity,\r\n      sentiment: llmSentiment,\r\n      ticket_type: llmTicketType,\r\n    });\r\n  }\r\n  // Escalation: governance explicit de-escalation takes priority over LLM\r\n  const govExplicitDeescalate = govOverrides.escalate === false;\r\n  const finalEscalate = govExplicitDeescalate\r\n    ? false\r\n    : (govOverrides.escalate ?? false) || llmEscalate || hardEsc.triggered || (governance?.forceEscalate ?? false);\r\n  let finalVerdict: \"user_side\" | \"tiktak_side\" | \"unclear\" = govOverrides.verdict ?? (finalEscalate ? \"tiktak_side\" : llmVerdict);\r\n\r\n  // Determine mode and finalize answer\r\n  let mode: \"solve\" | \"clarify\" | \"escalate\";\r\n  let finalAnswer = llmAnswer;\r\n  let nextQuestion: string | null = null;\r\n\r\n  if (finalVerdict === \"unclear\") {\r\n    mode = \"clarify\";\r\n    nextQuestion = llmNextQuestion || \"Peux-tu me donner plus de d\u00E9tails ? (message d'erreur, URL ou capture d'\u00E9cran)\";\r\n    if (!finalAnswer || finalAnswer.length < 10) {\r\n      finalAnswer = \"Je veux bien t'aider ! Pour te donner la bonne solution, j'ai besoin d'une petite pr\u00E9cision.\";\r\n    }\r\n  } else if (finalEscalate) {\r\n    mode = \"escalate\";\r\n    nextQuestion = null;\r\n    if (!finalAnswer || finalAnswer.length < 15) {\r\n      finalAnswer = \"Je comprends la situation \u2014 \u00E7a n\u00E9cessite l'intervention de notre \u00E9quipe technique. Je transf\u00E8re ton dossier \uD83D\uDCE7\";\r\n    }\r\n  } else {\r\n    mode = \"solve\";\r\n    nextQuestion = null;\r\n    if (!finalAnswer || finalAnswer.length < 10) {\r\n      finalAnswer = \"Peux-tu reformuler ta question pour que je puisse mieux t'aider ?\";\r\n      mode = \"clarify\";\r\n      finalVerdict = \"unclear\";\r\n      nextQuestion = \"Quel est exactement le probl\u00E8me que tu rencontres ?\";\r\n    }\r\n  }\r\n\r\n  // \u2550\u2550 GUARDRAIL 1: Diagnose-first \u2014 force clarify for vague messages without entities \u2550\u2550\r\n  if (mode === \"solve\" && !finalEscalate) {\r\n    const isVague = message.length < 20 ||\r\n      /\\b(\u00E7a marche pas|ne marche pas|fonctionne pas|persiste|tous est verifi|tout est verifi|toujours pareil|ne s['\u2019]ouvre pas|marche pas|khdem|ma5dem|maykhdemch)\\b/i.test(message);\r\n    const hasEntity = Boolean(\r\n      entities?.domain || entities?.order_id || entities?.error_message || entities?.payment_method || entities?.url\r\n    );\r\n    // Only force clarify on first user turn for a topic (no prior assistant answers about this)\r\n    const priorAssistantCount = history.filter(h => h.role === \"assistant\").length;\r\n    if (isVague && !hasEntity && priorAssistantCount === 0 && finalVerdict !== \"tiktak_side\") {\r\n      mode = \"clarify\";\r\n      finalVerdict = \"unclear\";\r\n      nextQuestion = llmNextQuestion || \"Tu peux pr\u00E9ciser : sur quelle page, quel message exact tu vois, et depuis quand ?\";\r\n      if (!finalAnswer || (nextQuestion && cheapSim(finalAnswer, nextQuestion) > 0.5)) {\r\n        finalAnswer = \"Ok \uD83D\uDC4D Pour te guider sans tourner en rond, j'ai besoin d'un d\u00E9tail pr\u00E9cis.\";\r\n      }\r\n    }\r\n  }\r\n\r\n  // \u2550\u2550 GUARDRAIL 2: No-repeat validator \u2014 block repeated answers \u2550\u2550\r\n  if (mode === \"solve\" || mode === \"clarify\") {\r\n    const prev = lastAssistantText(history);\r\n    if (prev && prev.length > 30) {\r\n      const sim = cheapSim(finalAnswer, prev);\r\n      if (sim >= 0.65) {\r\n        mode = \"clarify\";\r\n        finalVerdict = \"unclear\";\r\n        // Module-specific targeted questions (use preferredModule since finalModule not yet resolved)\r\n        const mod = preferredModule;\r\n        if (mod === \"settings\") {\r\n          nextQuestion = \"Tu peux m'envoyer le nom exact du domaine + le message affich\u00E9 (ex: SSL 525/526, site introuvable, page blanche) et depuis quand \u00E7a arrive ?\";\r\n        } else if (mod === \"technical\") {\r\n          nextQuestion = \"Quel est le code exact (500/504/etc) + sur quelle page (checkout, dashboard, produit) ? C'est intermittent ou permanent ?\";\r\n        } else if (mod === \"orders\") {\r\n          nextQuestion = \"Tu peux me donner le num\u00E9ro de commande + ce que tu vois exactement (erreur, statut, page bloqu\u00E9e) ?\";\r\n        } else if (mod === \"products\") {\r\n          nextQuestion = \"Quel produit exactement ? Tu peux m'envoyer le SKU ou le nom + le message d'erreur que tu vois ?\";\r\n        } else if (mod === \"payments\" || mod === \"billing\") {\r\n          nextQuestion = \"Quel moyen de paiement (Stripe / PayPal / e-Dinar / COD) ? Tu peux me donner le montant + le message d'erreur exact ?\";\r\n        } else if (mod === \"shipping\") {\r\n          nextQuestion = \"Quel transporteur + quel num\u00E9ro de commande / colis ? Qu'est-ce que tu vois exactement (erreur, statut, tracking) ?\";\r\n        } else {\r\n          nextQuestion = \"Donne-moi une pr\u00E9cision (message d'erreur / capture / depuis quand) pour \u00E9viter de te refaire les m\u00EAmes \u00E9tapes.\";\r\n        }\r\n        finalAnswer = \"Bien re\u00E7u \u2014 si tout est d\u00E9j\u00E0 v\u00E9rifi\u00E9, je veux \u00E9viter de te r\u00E9p\u00E9ter les m\u00EAmes \u00E9tapes. J'ai juste besoin d'une petite pr\u00E9cision pour diagnostiquer correctement.\";\r\n      }\r\n    }\r\n  }\r\n\r\n  // \u2550\u2550 GUARDRAIL 3: Banned terms filter \u2014 strip documentation/playbook references \u2550\u2550\r\n  if (BANNED_TERMS_RE.test(finalAnswer)) {\r\n    finalAnswer = finalAnswer\r\n      .split(\"\\n\")\r\n      .filter((l: string) => !BANNED_TERMS_RE.test(l))\r\n      .join(\"\\n\")\r\n      .trim() || \"Je te donne directement les \u00E9tapes. Dis-moi ce que tu vois exactement (message d'erreur / page) et on continue.\";\r\n  }\r\n\r\n  // \u2550\u2550 GUARDRAIL 4: Degeneration detector \u2014 catch repetitive/gibberish LLM output \u2550\u2550\r\n  if (finalAnswer.length > 60) {\r\n    // Detect any 3+ word sequence repeated 3+ times (token loop)\r\n    const words = finalAnswer.split(/\\s+/);\r\n    let degenerated = false;\r\n    outer: for (let len = 3; len <= 6; len++) {\r\n      for (let i = 0; i <= words.length - len; i++) {\r\n        const ngram = words.slice(i, i + len).join(\" \").toLowerCase();\r\n        let count = 0;\r\n        for (let j = 0; j <= words.length - len; j++) {\r\n          if (words.slice(j, j + len).join(\" \").toLowerCase() === ngram) count++;\r\n        }\r\n        if (count >= 3) { degenerated = true; break outer; }\r\n      }\r\n    }\r\n    // Detect raw JSON fragments leaking into answer\r\n    if (!degenerated && /\\{[\"\\s]*verdict|\"category\"\\s*:|\"confidence\"\\s*:/.test(finalAnswer)) {\r\n      degenerated = true;\r\n    }\r\n    // Detect single word repeated 4+ times\r\n    if (!degenerated) {\r\n      const freq: Record<string, number> = {};\r\n      for (const w of words) {\r\n        const lw = w.toLowerCase().replace(/[^\\p{L}]/gu, \"\");\r\n        if (lw.length > 3) freq[lw] = (freq[lw] || 0) + 1;\r\n      }\r\n      for (const [, count] of Object.entries(freq)) {\r\n        if (count >= 4 && count / words.length > 0.15) { degenerated = true; break; }\r\n      }\r\n    }\r\n    if (degenerated) {\r\n      console.warn(\"[GUARDRAIL-4] Degenerated LLM output detected, using fallback\");\r\n      finalAnswer = \"Je comprends ta demande. Peux-tu me d\u00E9crire le probl\u00E8me en d\u00E9tail (message d'erreur exact, page concern\u00E9e) pour que je te donne la solution adapt\u00E9e ?\";\r\n      mode = \"clarify\";\r\n      finalVerdict = \"unclear\";\r\n      nextQuestion = \"D\u00E9cris-moi exactement ce que tu vois : quel message d'erreur, sur quelle page, et depuis quand ?\";\r\n    }\r\n  }\r\n\r\n  // \u2500\u2500 HYBRID CATEGORY RESOLVER (priority chain) \u2500\u2500\r\n  // P1: Governance hard-locks (HTTP 5xx \u2192 technical, emotion \u2192 general, site_down \u2192 technical)\r\n  // P2: Keyword detection when confident (score \u2265 3)\r\n  // P3: RAG top-source module (when topScore \u2265 0.75 and module is clear)\r\n  // P4: LLM category (only if not \"general\" when keywords/RAG disagree)\r\n  // P5: Governance category hints (R7 fallback)\r\n  // P6: Vague-message fallback \u2192 \"general\"\r\n  let finalModule: string;\r\n\r\n  if (govOverrides.category) {\r\n    // P1: Governance hard-lock (HTTP 5xx, emotion, site_down)\r\n    finalModule = govOverrides.category;\r\n  } else if (keywordScore >= 3 && preferredModule !== \"general\") {\r\n    // P2: Keyword detection is confident \u2014 trust it over LLM\r\n    finalModule = preferredModule;\r\n  } else {\r\n    // P3: RAG top-source module (playbooks have module metadata)\r\n    const ragTopScore = Math.max(pbCtx.topScore, docsCtx.topScore);\r\n    const ragModule = inferRagTopModule(pbCtx, docsCtx);\r\n    if (ragTopScore >= 0.75 && ragModule && ragModule !== \"general\") {\r\n      // If LLM agrees with RAG, great. If LLM disagrees, trust RAG when score is strong.\r\n      if (llmCategory === ragModule || llmCategory === \"general\" || ragTopScore >= 0.85) {\r\n        finalModule = ragModule;\r\n      } else {\r\n        // LLM picked something specific that differs from RAG \u2014 trust LLM if keyword supports it\r\n        finalModule = (keywordScore > 0 && preferredModule === llmCategory) ? llmCategory : ragModule;\r\n      }\r\n    } else if (keywordScore > 0 && preferredModule !== \"general\") {\r\n      // P2b: Weaker keyword match (score 0-3) \u2014 still prefer over LLM when LLM says \"general\"\r\n      if (llmCategory === \"general\" || llmCategory === preferredModule) {\r\n        finalModule = preferredModule;\r\n      } else {\r\n        // LLM picked something specific, keywords say something else \u2014 use LLM\r\n        finalModule = llmCategory;\r\n      }\r\n    } else {\r\n      // P4: Fall back to LLM\r\n      finalModule = llmCategory;\r\n    }\r\n\r\n    // P5: Governance category hints (R7 \u2014 only overrides when LLM returned generic)\r\n    if (\r\n      finalModule === \"general\" &&\r\n      governance &&\r\n      governance.categoryHints.length > 0 &&\r\n      governance.categoryHints[0].confidence >= 0.7\r\n    ) {\r\n      finalModule = governance.categoryHints[0].module;\r\n    }\r\n\r\n    // P6: Vague-message protection \u2014 if no signals at all, keep \"general\"\r\n    if (\r\n      keywordScore === 0 &&\r\n      preferredModule === \"general\" &&\r\n      (!governance || governance.categoryHints.length === 0) &&\r\n      finalModule !== \"general\" &&\r\n      ragTopScore < 0.75\r\n    ) {\r\n      finalModule = \"general\";\r\n    }\r\n  }\r\n\r\n  // Evidence\r\n  const evidence = gatherEvidence(diag?.evidence || [], pbCtx, docsCtx, 6);\r\n\r\n  // Signals\r\n  const finalSeverity = govOverrides.severity ?? (hardEsc.triggered ? \"critical\" : llmSeverity);\r\n  const finalSentiment = govOverrides.sentiment ?? llmSentiment;\r\n  const signals = augmentSignals(\r\n    {\r\n      confidence: llmConfidence,\r\n      preferredModule: finalModule,\r\n      incident: finalEscalate,\r\n      severity: finalSeverity,\r\n      category: finalModule,\r\n      sentiment: finalSentiment,\r\n      escalation_recommended: finalEscalate,\r\n    },\r\n    { message }\r\n  );\r\n\r\n  const actions = Array.isArray(diag?.actions) ? diag.actions : [];\r\n\r\n  // State for multi-turn clarify flows\r\n  let responseState: ChatState = state;\r\n  if (mode === \"clarify\" && nextQuestion) {\r\n    const wf: NonNullable<ChatState>[\"waiting_for\"] =\r\n      llmCategory === \"settings\" ? \"domain\" : \"error_message\";\r\n    responseState = setWaitingState(state, wf, originalMessage);\r\n  }\r\n\r\n  return {\r\n    mode,\r\n    category: finalModule,\r\n    verdict: finalVerdict,\r\n    confidence: llmConfidence,\r\n    answer: finalAnswer,\r\n    next_question: nextQuestion,\r\n    escalate: finalEscalate,\r\n    ticket_type: govOverrides.ticket_type ?? llmTicketType,\r\n    sentiment: finalSentiment,\r\n    severity: finalSeverity,\r\n    detected_language: llmLanguage,\r\n    processing_time_ms: Date.now() - t0,\r\n    evidence,\r\n    signals,\r\n    context: finalModule,\r\n    preferredModule: finalModule,\r\n    actions,\r\n    state: responseState,\r\n  };\r\n}\r\n\r\n/* ----------------------------- Shared RAG pipeline ----------------------------- */\r\n\r\n/**\r\n * Common RAG pipeline used by both handleChat and handleChatStream.\r\n * Returns all the context needed for the LLM call and post-processing.\r\n */\r\nasync function runRagPipeline(env: Env, message: string, history: HistoryMsg[], tenantId: string) {\r\n  // \u2500\u2500 GOVERNANCE LAYER (pre-LLM, deterministic, <1ms) \u2500\u2500\r\n  const governance = runGovernance(message);\r\n\r\n  const detection = detectPreferredModule(message, history);\r\n  let preferredModule = canonicalModule(detection.module);\r\n  const keywordScore = detection.score;\r\n\r\n  // Governance-enhanced module: if keyword detection yielded \"general\" but governance\r\n  // has a high-confidence category hint, use it to guide RAG retrieval\r\n  if (preferredModule === \"general\" && governance.categoryHints.length > 0) {\r\n    const topHint = governance.categoryHints[0];\r\n    if (topHint.confidence >= 0.7) {\r\n      preferredModule = topHint.module;\r\n    }\r\n  }\r\n\r\n  const modulePrefix = preferredModule !== \"general\" ? `MODULE=${preferredModule}\\n` : \"\";\r\n  const pbQuery = `${modulePrefix}${message}\\n${history.slice(-5).map((h) => `${h.role}: ${h.content}`).join(\"\\n\")}`.trim();\r\n  const docsQuery = `${message}\\n${history.slice(-6).map((h) => `${h.role}: ${h.content}`).join(\"\\n\")}`.trim();\r\n\r\n  const [pbVec, docsVec] = await Promise.all([embedText(env, pbQuery), embedText(env, docsQuery)]);\r\n  if (!pbVec || !docsVec) return null;\r\n\r\n  const [pbCtx, docsCtx] = await Promise.all([\r\n    smartFetchContext(env, env.TIKTAK_PLAYBOOKS, pbVec, tenantId, preferredModule, 4, \"playbook\"),\r\n    smartFetchContext(env, env.TIKTAK_KB, docsVec, tenantId, preferredModule, 7, \"doc\"),\r\n  ]);\r\n\r\n  if (preferredModule === \"general\" && keywordScore === 0) {\r\n    const inferred = inferModuleFromRetrieval(pbCtx, docsCtx);\r\n    if (inferred && inferred !== \"general\") preferredModule = inferred;\r\n  }\r\n\r\n  const entities = extractEntities(message);\r\n  const hintParts: string[] = [];\r\n  if (keywordScore > 0) hintParts.push(`Mots-cl\u00E9s \u2192 ${preferredModule} (score: ${keywordScore.toFixed(1)})`);\r\n  if (entities.domain) hintParts.push(`Domaine: ${entities.domain}`);\r\n  if (entities.order_id) hintParts.push(`Commande #${entities.order_id}`);\r\n  if (entities.error_message) hintParts.push(`Erreur: \"${entities.error_message.slice(0, 100)}\"`);\r\n  if (entities.payment_method) hintParts.push(`Paiement: ${entities.payment_method}`);\r\n\r\n  // Inject governance hints into routing hints for the LLM\r\n  const govHints = governanceToPromptHints(governance);\r\n\r\n  const routingHints = (hintParts.length ? hintParts.join(\" | \") : \"\") + govHints;\r\n\r\n  const knowledgeContext = buildKnowledgeContext(preferredModule, pbCtx, docsCtx);\r\n\r\n  return { preferredModule, keywordScore, pbCtx, docsCtx, routingHints, knowledgeContext, governance, entities };\r\n}\r\n\r\n/* ----------------------------- Ingest handler ----------------------------- */\r\n\r\nexport async function handleIngest(req: Request, env: Env) {\r\n  const secret = req.headers.get(\"x-internal-secret\");\r\n  if (secret !== env.INTERNAL_SHARED_SECRET) {\r\n    return json(req, { error: \"unauthorized\" }, 403);\r\n  }\r\n\r\n  const payload = await safeReadJson(req);\r\n  if (!payload) return json(req, { error: \"invalid_json\" }, 400);\r\n\r\n  const kind = toStr(payload.kind);\r\n\r\n  // Batch playbook ingestion\r\n  if (kind === \"playbooks\" && Array.isArray(payload.items)) {\r\n    let stored = 0;\r\n    let upserted = 0;\r\n\r\n    for (const item of payload.items) {\r\n      const vec = await embedText(env, item.text);\r\n      if (!vec) continue;\r\n\r\n      const r2Key = `playbooks/${item.tenant_id}/${item.playbook_id}.json`;\r\n      await env.TIKTAK_DOCS.put(r2Key, JSON.stringify(item));\r\n      stored++;\r\n\r\n      const vecId = `${item.tenant_id}:pb:${item.playbook_id}`;\r\n      await env.TIKTAK_PLAYBOOKS.upsert([\r\n        {\r\n          id: vecId,\r\n          values: vec,\r\n          metadata: {\r\n            tenant_id: item.tenant_id,\r\n            kind: \"playbook\",\r\n            playbook_id: item.playbook_id,\r\n            module: item.module,\r\n            r2_key: r2Key,\r\n          },\r\n        },\r\n      ]);\r\n      upserted++;\r\n    }\r\n\r\n    return json(req, { ok: true, stored, upserted });\r\n  }\r\n\r\n  // Batch doc ingestion\r\n  if (kind === \"docs\" && Array.isArray(payload.items)) {\r\n    let upserted = 0;\r\n\r\n    for (const item of payload.items) {\r\n      const vec = await embedText(env, item.text);\r\n      if (!vec) continue;\r\n\r\n      const vecId = `${item.tenant_id}:doc:${item.doc_id}:${item.chunk_id}`;\r\n      await env.TIKTAK_KB.upsert([\r\n        {\r\n          id: vecId,\r\n          values: vec,\r\n          metadata: {\r\n            tenant_id: item.tenant_id,\r\n            kind: \"doc\",\r\n            doc_id: item.doc_id,\r\n            chunk_id: item.chunk_id,\r\n            module: item.module,\r\n            text: item.text.slice(0, 500),\r\n          },\r\n        },\r\n      ]);\r\n      upserted++;\r\n    }\r\n\r\n    return json(req, { ok: true, upserted });\r\n  }\r\n\r\n  // Legacy single-item ingestion (backward compatible)\r\n  const tenantId = toStr(payload.tenant_id);\r\n\r\n  if (kind === \"playbook\") {\r\n    const item = payload as PlaybookIngestItem;\r\n    const vec = await embedText(env, item.text);\r\n    if (!vec) return json(req, { error: \"embedding_failed\" }, 500);\r\n\r\n    const r2Key = `playbooks/${tenantId}/${item.playbook_id}.json`;\r\n    await env.TIKTAK_DOCS.put(r2Key, JSON.stringify(item));\r\n\r\n    const vecId = `${tenantId}:pb:${item.playbook_id}`;\r\n    await env.TIKTAK_PLAYBOOKS.upsert([\r\n      {\r\n        id: vecId,\r\n        values: vec,\r\n        metadata: {\r\n          tenant_id: tenantId,\r\n          kind: \"playbook\",\r\n          playbook_id: item.playbook_id,\r\n          module: item.module,\r\n          r2_key: r2Key,\r\n        },\r\n      },\r\n    ]);\r\n\r\n    return json(req, { ok: true, id: vecId, r2_key: r2Key });\r\n  }\r\n\r\n  if (kind === \"doc\") {\r\n    const item = payload as DocChunk;\r\n    const vec = await embedText(env, item.text);\r\n    if (!vec) return json(req, { error: \"embedding_failed\" }, 500);\r\n\r\n    const vecId = `${tenantId}:doc:${item.doc_id}:${item.chunk_id}`;\r\n    await env.TIKTAK_KB.upsert([\r\n      {\r\n        id: vecId,\r\n        values: vec,\r\n        metadata: {\r\n          tenant_id: tenantId,\r\n          kind: \"doc\",\r\n          doc_id: item.doc_id,\r\n          chunk_id: item.chunk_id,\r\n          module: item.module,\r\n          text: item.text.slice(0, 500),\r\n        },\r\n      },\r\n    ]);\r\n\r\n    return json(req, { ok: true, id: vecId });\r\n  }\r\n\r\n  return json(req, { error: \"unknown_kind\" }, 400);\r\n}\r\n\r\n/* ----------------------------- Chat handler ----------------------------- */\r\n\r\nexport async function handleChat(req: Request, env: Env, debug = false) {\r\n  const payload = await safeReadJson(req);\r\n  if (!payload) return chatJson(req, { error: \"invalid_json\" }, 400);\r\n\r\n  const t0 = Date.now();\r\n  const tenantId = toStr(payload.tenant_id || \"tiktak_pro\");\r\n  const state = (payload && typeof payload === \"object\" ? ((payload as any).state as ChatState) : null) || null;\r\n  const originalMessage = toStr(payload.message || \"\").trim();\r\n  let message = originalMessage;\r\n  const mergedFollowup = mergeFollowupIntoQuery(message, state);\r\n  message = mergedFollowup.merged;\r\n  const history: HistoryMsg[] = Array.isArray(payload.history) ? payload.history : [];\r\n  if (!message) {\r\n    return chatJson(req, { error: \"empty_message\" }, 400);\r\n  }\r\n\r\n  // Quick responses\r\n  if (isGreetingOnly(message)) {\r\n    return chatJson(req, {\r\n      mode: \"solve\", verdict: \"user_side\", category: \"general\",\r\n      ticket_type: \"question\", sentiment: \"calm\", severity: \"low\",\r\n      detected_language: detectLanguage(message), confidence: 1,\r\n      answer: \"Salut \uD83D\uDC4B Je suis ton assistant TikTak PRO. D\u00E9cris-moi ton probl\u00E8me et je t'aide \u00E0 le r\u00E9soudre ! Si tu as un message d'erreur ou une URL, partage-les pour un diagnostic plus rapide.\",\r\n      next_question: null, escalate: false, evidence: [],\r\n      signals: { confidence: 1, severity: \"low\", category: \"general\", sentiment: \"calm\", escalation_recommended: false },\r\n      processing_time_ms: Date.now() - t0,\r\n    });\r\n  }\r\n\r\n  if (isThanksOnly(message)) {\r\n    return chatJson(req, {\r\n      mode: \"solve\", verdict: \"user_side\", category: \"general\",\r\n      ticket_type: \"question\", sentiment: \"satisfied\", severity: \"low\",\r\n      detected_language: detectLanguage(message), confidence: 1,\r\n      answer: \"Avec plaisir \uD83D\uDE0A N'h\u00E9site pas si tu as d'autres questions, je suis l\u00E0 pour t'aider !\",\r\n      next_question: null, escalate: false, evidence: [],\r\n      signals: { confidence: 1, severity: \"low\", category: \"general\", sentiment: \"satisfied\", escalation_recommended: false },\r\n      processing_time_ms: Date.now() - t0,\r\n    });\r\n  }\r\n\r\n  // RAG pipeline\r\n  const rag = await runRagPipeline(env, message, history, tenantId);\r\n  if (!rag) return chatJson(req, { error: \"embedding_failed\" }, 500);\r\n\r\n  const { preferredModule, keywordScore, pbCtx, docsCtx, routingHints: baseRoutingHints, knowledgeContext, governance, entities } = rag;\r\n\r\n  // Inject history state summary into routing hints for LLM context\r\n  const stateSummary = buildHistoryStateSummary(history, preferredModule);\r\n  const routingHints = baseRoutingHints + stateSummary;\r\n\r\n  // Debug mode\r\n  if (debug) {\r\n    return json(req, {\r\n      debug: true, tenantId, preferredModule, message,\r\n      governance: {\r\n        escalationScore: governance.escalationScore,\r\n        forceEscalate: governance.forceEscalate,\r\n        emotion: governance.emotion,\r\n        httpError: governance.httpError,\r\n        categoryHints: governance.categoryHints,\r\n      },\r\n      playbooks: {\r\n        count: pbCtx.items.length,\r\n        avgScore: pbCtx.avgScore.toFixed(2),\r\n        topScore: pbCtx.topScore.toFixed(2),\r\n        items: pbCtx.items.map((i) => ({ id: i.id, score: i.score.toFixed(2), module: i.module })),\r\n      },\r\n      docs: {\r\n        count: docsCtx.items.length,\r\n        avgScore: docsCtx.avgScore.toFixed(2),\r\n        topScore: docsCtx.topScore.toFixed(2),\r\n        items: docsCtx.matches.slice(0, 7).map((m: any) => ({\r\n          id: m.id,\r\n          score: (m.score * 100).toFixed(0) + \"%\",\r\n          module: m.metadata?.module,\r\n        })),\r\n      },\r\n    });\r\n  }\r\n\r\n  // R3: Detect sentiment from history for empathy injection\r\n  const turnCount = history.filter((h) => h.role === \"user\").length;\r\n  // Use governance emotion as initial sentiment hint for empathy block\r\n  const lastSentiment = governance.emotion.score >= 5 ? governance.emotion.sentiment : undefined;\r\n\r\n  // AI diagnosis\r\n  const diag = await runStructuredChat(env, message, history, knowledgeContext, routingHints, 900, {\r\n    turnCount,\r\n    sentiment: lastSentiment,\r\n  });\r\n\r\n  // Unified post-LLM processing (G3 fix) + governance validation\r\n  const result = processLlmDiagnosis({\r\n    diag, message, originalMessage, preferredModule, keywordScore,\r\n    pbCtx, docsCtx, state, t0, governance, history, entities,\r\n  });\r\n\r\n  return chatJson(req, result);\r\n}\r\n\r\n/* ----------------------------- Streaming Chat handler ----------------------------- */\r\n\r\nexport async function handleChatStream(req: Request, env: Env) {\r\n  const payload = await safeReadJson(req);\r\n  if (!payload) {\r\n    return new Response('data: {\"error\":\"invalid_json\"}\\n\\n', {\r\n      status: 400,\r\n      headers: { \"Content-Type\": \"text/event-stream\", ...corsHeaders(req) },\r\n    });\r\n  }\r\n\r\n  const t0 = Date.now();\r\n  const tenantId = toStr(payload.tenant_id || \"tiktak_pro\");\r\n  const state = (payload && typeof payload === \"object\" ? ((payload as any).state as ChatState) : null) || null;\r\n  const originalMessage = toStr(payload.message || \"\").trim();\r\n  let message = originalMessage;\r\n  const mergedFollowup = mergeFollowupIntoQuery(message, state);\r\n  message = mergedFollowup.merged;\r\n  const history: HistoryMsg[] = Array.isArray(payload.history) ? payload.history : [];\r\n\r\n  if (!message) {\r\n    return new Response('data: {\"error\":\"empty_message\"}\\n\\n', {\r\n      status: 400,\r\n      headers: { \"Content-Type\": \"text/event-stream\", ...corsHeaders(req) },\r\n    });\r\n  }\r\n\r\n  // Quick responses\r\n  if (isGreetingOnly(message) || isThanksOnly(message)) {\r\n    const full = isGreetingOnly(message)\r\n      ? normalizeSupportResponse({\r\n          mode: \"solve\", verdict: \"user_side\", category: \"general\",\r\n          ticket_type: \"question\", sentiment: \"calm\", severity: \"low\",\r\n          detected_language: detectLanguage(message), confidence: 1,\r\n          answer: \"Salut \uD83D\uDC4B Je suis ton assistant TikTak PRO. D\u00E9cris-moi ton probl\u00E8me et je t'aide \u00E0 le r\u00E9soudre !\",\r\n          escalate: false, evidence: [], processing_time_ms: Date.now() - t0,\r\n        })\r\n      : normalizeSupportResponse({\r\n          mode: \"solve\", verdict: \"user_side\", category: \"general\",\r\n          ticket_type: \"question\", sentiment: \"satisfied\", severity: \"low\",\r\n          detected_language: detectLanguage(message), confidence: 1,\r\n          answer: \"Avec plaisir \uD83D\uDE0A N'h\u00E9site pas si tu as d'autres questions !\",\r\n          escalate: false, evidence: [], processing_time_ms: Date.now() - t0,\r\n        });\r\n    const body = `event: done\\ndata: ${JSON.stringify(full)}\\n\\n`;\r\n    return new Response(body, {\r\n      headers: { \"Content-Type\": \"text/event-stream\", \"Cache-Control\": \"no-cache\", ...corsHeaders(req) },\r\n    });\r\n  }\r\n\r\n  // RAG pipeline (shared with handleChat)\r\n  const rag = await runRagPipeline(env, message, history, tenantId);\r\n  if (!rag) {\r\n    return new Response('event: done\\ndata: {\"error\":\"embedding_failed\"}\\n\\n', {\r\n      status: 500,\r\n      headers: { \"Content-Type\": \"text/event-stream\", ...corsHeaders(req) },\r\n    });\r\n  }\r\n\r\n  const { preferredModule, keywordScore, pbCtx, docsCtx, routingHints: baseStreamHints, knowledgeContext, governance, entities } = rag;\r\n\r\n  // Inject history state summary into routing hints\r\n  const streamStateSummary = buildHistoryStateSummary(history, preferredModule);\r\n  const routingHints = baseStreamHints + streamStateSummary;\r\n\r\n  // R3: Detect sentiment from history for empathy injection\r\n  const turnCount = history.filter((h) => h.role === \"user\").length;\r\n  const streamSentiment = governance.emotion.score >= 5 ? governance.emotion.sentiment : undefined;\r\n\r\n  // Build LLM messages (using shared prompt \u2014 fixes G2)\r\n  const messages = buildLlmMessages(message, history, knowledgeContext, routingHints, { turnCount, sentiment: streamSentiment });\r\n\r\n  // Stream the LLM response via SSE\r\n  const encoder = new TextEncoder();\r\n  const { readable, writable } = new TransformStream();\r\n  const writer = writable.getWriter();\r\n\r\n  // Launch streaming in background\r\n  (async () => {\r\n    let fullContent = \"\";\r\n    try {\r\n      const stream = (await env.AI.run(CHAT_MODEL as any, {\r\n        messages,\r\n        max_tokens: 900,\r\n        temperature: 0.3,\r\n        stream: true,\r\n      })) as ReadableStream;\r\n\r\n      const reader = stream.getReader();\r\n      const decoder = new TextDecoder();\r\n\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n        const chunk = typeof value === \"string\" ? value : decoder.decode(value, { stream: true });\r\n\r\n        const lines = chunk.split(\"\\n\");\r\n        for (const line of lines) {\r\n          if (!line.startsWith(\"data: \")) continue;\r\n          const payloadStr = line.slice(6).trim();\r\n          if (payloadStr === \"[DONE]\") continue;\r\n          try {\r\n            const parsed = JSON.parse(payloadStr);\r\n            const token = parsed.response || \"\";\r\n            if (token) {\r\n              fullContent += token;\r\n              await writer.write(encoder.encode(`event: token\\ndata: ${JSON.stringify({ t: token })}\\n\\n`));\r\n            }\r\n          } catch {\r\n            // Non-JSON chunk, skip\r\n          }\r\n        }\r\n      }\r\n    } catch (e: any) {\r\n      console.error(\"Stream error:\", e);\r\n    }\r\n\r\n    // Parse completed response\r\n    if (!fullContent.startsWith(\"{\")) fullContent = \"{\" + fullContent;\r\n    let diag: any = {};\r\n    try {\r\n      const jsonMatch = fullContent.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) diag = JSON.parse(jsonMatch[0]);\r\n    } catch {\r\n      try {\r\n        let truncated = fullContent.replace(/,\\s*\"[^\"]*\"?\\s*:?\\s*\"?[^\"]*$/, \"\");\r\n        if (!truncated.endsWith(\"}\")) truncated += \"}\";\r\n        diag = JSON.parse(truncated);\r\n      } catch {\r\n        const answerMatch = fullContent.match(/\"answer\"\\s*:\\s*\"((?:[^\"\\\\]|\\\\.)*)\"/);\r\n        if (answerMatch) {\r\n          diag = { answer: answerMatch[1].replace(/\\\\\"/g, '\"').replace(/\\\\n/g, \"\\n\"), verdict: \"user_side\" };\r\n        }\r\n      }\r\n    }\r\n\r\n    // Unified post-LLM processing (G3 fix \u2014 same function as handleChat) + governance\r\n    const result = processLlmDiagnosis({\r\n      diag, message, originalMessage, preferredModule, keywordScore,\r\n      pbCtx, docsCtx, state, t0, governance, history, entities,\r\n    });\r\n\r\n    const donePayload = normalizeSupportResponse(result);\r\n    await writer.write(encoder.encode(`event: done\\ndata: ${JSON.stringify(donePayload)}\\n\\n`));\r\n    await writer.close();\r\n  })();\r\n\r\n  return new Response(readable, {\r\n    headers: {\r\n      \"Content-Type\": \"text/event-stream\",\r\n      \"Cache-Control\": \"no-cache\",\r\n      \"Connection\": \"keep-alive\",\r\n      ...corsHeaders(req),\r\n    },\r\n  });\r\n}\r\n", "// src/index.ts \u2014 Thin router entry point (R2 refactoring)\r\n// Fixes: G1 (monolithic), G6 (auth on /chat), R4 (rate limiting by IP)\r\n//\r\n// Module layout (was 2121 lines \u2192 now ~100 lines):\r\n//   src/types.ts      \u2014 Types and constants\r\n//   src/helpers.ts     \u2014 CORS, JSON, normalization utilities\r\n//   src/detection.ts   \u2014 Module detection, entities, language\r\n//   src/prompt.ts      \u2014 Single-source system prompt + empathy (R3)\r\n//   src/rag.ts         \u2014 RAG pipeline, evidence, confidence (R5)\r\n//   src/routes.ts      \u2014 HTTP route handlers, unified post-LLM logic (G3)\r\n//   src/index.ts       \u2014 This file: router + rate limiter + auth\r\n\r\nimport type { Env } from \"./types\";\r\nimport { EMBED_MODEL, CHAT_MODEL } from \"./types\";\r\nimport { preflight, text, json, toStr, corsHeaders } from \"./helpers\";\r\nimport { handleChat, handleChatStream, handleIngest } from \"./routes\";\r\n\r\n/* ----------------------------- R4: Rate limiting by IP ----------------------------- */\r\n\r\nconst RATE_LIMIT_WINDOW_MS = 60_000; // 1 minute\r\nconst RATE_LIMIT_MAX = 30;           // max 30 requests per minute per IP\r\n\r\nconst ipBuckets = new Map<string, { count: number; resetAt: number }>();\r\n\r\nfunction checkRateLimit(ip: string): { allowed: boolean; remaining: number } {\r\n  const now = Date.now();\r\n  let bucket = ipBuckets.get(ip);\r\n\r\n  if (!bucket || now >= bucket.resetAt) {\r\n    bucket = { count: 0, resetAt: now + RATE_LIMIT_WINDOW_MS };\r\n    ipBuckets.set(ip, bucket);\r\n  }\r\n\r\n  bucket.count++;\r\n\r\n  // Garbage-collect stale entries every ~100 checks\r\n  if (ipBuckets.size > 500) {\r\n    for (const [key, b] of ipBuckets) {\r\n      if (now >= b.resetAt) ipBuckets.delete(key);\r\n    }\r\n  }\r\n\r\n  return {\r\n    allowed: bucket.count <= RATE_LIMIT_MAX,\r\n    remaining: Math.max(0, RATE_LIMIT_MAX - bucket.count),\r\n  };\r\n}\r\n\r\n/* ----------------------------- Worker Entry ----------------------------- */\r\n\r\nexport default {\r\n  async fetch(req: Request, env: Env) {\r\n    const url = new URL(req.url);\r\n    if (req.method === \"OPTIONS\") return preflight(req);\r\n\r\n    // Health check\r\n    if (url.pathname === \"/health\") {\r\n      return json(req, {\r\n        ok: true,\r\n        version: \"3.0-modular\",\r\n        models: { chat: CHAT_MODEL, embed: EMBED_MODEL },\r\n        bindings: {\r\n          ai: !!env.AI,\r\n          docs_kb: !!env.TIKTAK_KB,\r\n          playbooks: !!env.TIKTAK_PLAYBOOKS,\r\n          r2: !!env.TIKTAK_DOCS,\r\n        },\r\n      });\r\n    }\r\n\r\n    // Admin ingest (already auth-protected by x-internal-secret)\r\n    if (url.pathname === \"/admin/ingest\" && req.method === \"POST\") {\r\n      try {\r\n        return await handleIngest(req, env);\r\n      } catch (e: any) {\r\n        return json(req, { error: \"ingest_exception\", message: toStr(e?.message || e) }, 500);\r\n      }\r\n    }\r\n\r\n    // G6: Auth on /chat \u2014 require shared secret or allow open access via query param\r\n    if (url.pathname === \"/chat\" || url.pathname === \"/chat/stream\") {\r\n      // R4: Rate limiting by IP\r\n      const clientIp = req.headers.get(\"CF-Connecting-IP\") || req.headers.get(\"X-Forwarded-For\") || \"unknown\";\r\n      const rateCheck = checkRateLimit(clientIp);\r\n      if (!rateCheck.allowed) {\r\n        return json(req, {\r\n          error: \"rate_limit_exceeded\",\r\n          message: \"Trop de requ\u00EAtes. R\u00E9essaie dans une minute.\",\r\n          retry_after_seconds: 60,\r\n        }, 429);\r\n      }\r\n    }\r\n\r\n    // Chat endpoint\r\n    if (url.pathname === \"/chat\") {\r\n      const debug = url.searchParams.get(\"debug\") === \"1\";\r\n      try {\r\n        return await handleChat(req, env, debug);\r\n      } catch (e: any) {\r\n        console.error(\"chat_exception:\", e?.message || e);\r\n        return json(req, { error: \"chat_exception\", message: toStr(e?.message || e) }, 500);\r\n      }\r\n    }\r\n\r\n    // Streaming chat endpoint\r\n    if (url.pathname === \"/chat/stream\") {\r\n      try {\r\n        return await handleChatStream(req, env);\r\n      } catch (e: any) {\r\n        console.error(\"stream_exception:\", e?.message || e);\r\n        return new Response(\r\n          `event: done\\ndata: ${JSON.stringify({ error: \"stream_exception\", message: toStr(e?.message || e) })}\\n\\n`,\r\n          { status: 500, headers: { \"Content-Type\": \"text/event-stream\", ...corsHeaders(req) } }\r\n        );\r\n      }\r\n    }\r\n\r\n    return text(req, \"Not found\", 404);\r\n  },\r\n};\r\n\r\n/* ----------------------------- Re-exports for tests ----------------------------- */\r\n// Preserve backward compatibility: tests import from '../src/index'\r\nexport { augmentSignals, normalizeSupportResponse, clamp01, routeFor, extractJsonBlock } from \"./helpers\";\r\nexport { canonicalModule, toCoarseModule, detectPreferredModule, extractEntities, checkHardEscalation, isGreetingOnly, isThanksOnly, detectLanguage } from \"./detection\";\r\nexport { runGovernance, governanceToPromptHints, validatePostLlm } from \"./governance\";\r\nexport type { GovernanceSignals, PostLlmOverrides } from \"./governance\";\r\n"],
  "mappings": ";;;;AAWO,IAAM,cAAc;AACpB,IAAM,aAAa;;;ACJnB,IAAM,SAAS;AAAA;AAAA,EAEpB;AAAA,EACA;AAAA;AAAA,EAGA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AASA,IAAM,UAAiC;AAAA;AAAA,EAErC,UAAU;AAAA,EACV,WAAW;AAAA,EACX,OAAO;AAAA,EACP,OAAO;AAAA,EACP,SAAS;AAAA,EACT,cAAc;AAAA,EACd,eAAe;AAAA,EACf,cAAc;AAAA;AAAA,EAGd,aAAa;AAAA,EACb,YAAY;AAAA,EACZ,SAAS;AAAA,EACT,UAAU;AAAA,EACV,UAAU;AAAA,EACV,QAAQ;AAAA,EACR,SAAS;AAAA,EACT,cAAc;AAAA,EACd,QAAQ;AAAA,EACR,WAAW;AAAA,EACX,YAAY;AAAA,EACZ,OAAO;AAAA,EACP,OAAO;AAAA,EACP,WAAW;AAAA,EACX,YAAY;AAAA,EACZ,UAAU;AAAA,EACV,WAAW;AAAA,EACX,WAAW;AAAA,EACX,UAAU;AAAA,EACV,UAAU;AAAA,EACV,QAAQ;AAAA,EACR,WAAW;AAAA,EACX,gBAAgB;AAAA,EAChB,iBAAc;AAAA,EACd,UAAU;AAAA,EACV,eAAe;AAAA,EACf,uBAAoB;AAAA,EACpB,WAAW;AAAA,EACX,iBAAiB;AAAA,EACjB,WAAW;AAAA,EACX,YAAY;AAAA,EACZ,eAAe;AAAA,EACf,WAAW;AAAA,EACX,eAAe;AAAA,EACf,wBAAqB;AAAA,EACrB,sBAAmB;AAAA,EACnB,UAAU;AAAA;AAAA,EAGV,OAAO;AAAA,EACP,OAAO;AAAA,EACP,QAAQ;AAAA,EACR,eAAe;AAAA,EACf,gBAAgB;AAAA,EAChB,WAAW;AAAA,EACX,UAAU;AAAA,EACV,eAAe;AAAA,EACf,gBAAgB;AAAA,EAChB,WAAW;AAAA,EACX,YAAY;AAAA;AAAA,EAGZ,WAAW;AAAA,EACX,YAAY;AAAA,EACZ,YAAY;AAAA,EACZ,YAAY;AAAA,EACZ,UAAU;AAAA,EACV,WAAW;AAAA,EAEX,WAAW;AAAA,EACX,WAAW;AAAA,EACX,eAAe;AAAA,EACf,WAAW;AAAA,EACX,gBAAgB;AAAA,EAChB,cAAc;AAAA;AAAA,EAGd,SAAS;AAAA,EACT,UAAU;AAAA,EACV,YAAY;AAAA;AAAA,EAGZ,WAAW;AAAA,EACX,YAAY;AAAA,EACZ,WAAW;AAAA,EACX,aAAa;AAAA,EACb,OAAO;AAAA,EACP,YAAY;AAAA,EACZ,cAAc;AAAA,EACd,cAAc;AAAA,EACd,eAAe;AAAA,EAEf,SAAS;AAAA,EACT,cAAc;AAAA,EACd,aAAa;AAAA;AAAA,EAGb,YAAY;AAAA,EACZ,YAAY;AAAA,EACZ,YAAY;AAAA,EACZ,aAAa;AAAA,EACb,cAAc;AAAA,EACd,iBAAc;AAAA,EACd,aAAa;AAAA,EACb,WAAW;AAAA,EACX,QAAQ;AAAA,EACR,WAAW;AAAA;AAAA,EAGX,YAAY;AAAA,EACZ,aAAa;AAAA,EACb,UAAU;AAAA,EACV,eAAe;AAAA,EACf,QAAQ;AAAA,EACR,UAAU;AAAA,EAEV,OAAO;AAAA,EACP,UAAU;AAAA,EAEV,SAAS;AAAA,EACT,aAAa;AAAA,EACb,YAAY;AAAA,EACZ,gBAAgB;AAAA,EAChB,OAAO;AAAA,EAEP,UAAU;AAAA,EACV,WAAW;AAAA,EACX,aAAa;AAAA,EACb,kBAAe;AAAA,EACf,cAAc;AAChB;AAEO,SAAS,eAAe,GAAkB;AAC/C,QAAM,KAAK,KAAK,IAAI,YAAY,EAAE,KAAK;AAEvC,MAAI,CAAC,EAAG,QAAO;AACf,MAAI,QAAQ,CAAC,EAAG,QAAO,QAAQ,CAAC;AAEhC,MAAK,OAA6B,SAAS,CAAC,EAAG,QAAO;AACtD,SAAO;AACT;AARgB;;;ACxKT,SAAS,gBAAgB,KAAsB;AACpD,QAAM,IAAI,OAAO,OAAO,EAAE,EAAE,KAAK,EAAE,YAAY;AAC/C,MAAI,CAAC,EAAG,QAAO;AACf,QAAM,OAAO,eAAe,CAAC;AAC7B,SAAO,eAAe,IAAI;AAC5B;AALgB;AAeT,SAAS,eAAe,GAAmB;AAChD,QAAM,IAAI,OAAO,KAAK,EAAE,EAAE,KAAK,EAAE,YAAY;AAC7C,MAAI,CAAC,KAAK,MAAM,UAAW,QAAO;AAGlC,MACE,MAAM,UAAU,MAAM,aAAa,MAAM,aAAa,MAAM,YAC5D,MAAM,cAAc,MAAM,cAAc,MAAM,cAC9C,MAAM,cAAc,MAAM,aAAa,MAAM,eAAe,MAAM,SAClE,MAAM,eAAe,MAAM,UAAU,MAAM,eAAe,MAAM,gBAChE,QAAO;AAGT,QAAM,MAA6B;AAAA;AAAA,IAEjC,aAAa;AAAA,IAAW,YAAY;AAAA,IAAW,WAAW;AAAA,IAC1D,YAAY;AAAA,IAAW,OAAO;AAAA,IAAW,SAAS;AAAA,IAClD,QAAQ;AAAA,IAAW,cAAc;AAAA,IAAW,SAAS;AAAA,IACrD,UAAU;AAAA,IAAW,UAAU;AAAA,IAAW,OAAO;AAAA;AAAA,IAGjD,UAAU;AAAA,IAAY,WAAW;AAAA,IAAY,OAAO;AAAA,IACpD,OAAO;AAAA,IAAY,iBAAiB;AAAA,IAAY,UAAU;AAAA;AAAA,IAG1D,QAAQ;AAAA,IAAQ,SAAS;AAAA,IAAQ,YAAY;AAAA,IAC7C,gBAAgB;AAAA,IAAQ,OAAO;AAAA,IAAQ,aAAa;AAAA,IACpD,oBAAoB;AAAA,IAAQ,OAAO;AAAA,IAAQ,kBAAe;AAAA;AAAA,IAG1D,iBAAiB;AAAA,IAAiB,gBAAgB;AAAA,IAClD,UAAU;AAAA,IAAiB,WAAW;AAAA,IACtC,sBAAsB;AAAA,IAAiB,OAAO;AAAA;AAAA,IAG9C,WAAW;AAAA,IAAY,YAAY;AAAA,IAAY,SAAS;AAAA,IACxD,eAAe;AAAA,IAAY,OAAO;AAAA,IAAY,UAAU;AAAA;AAAA,IAGxD,WAAW;AAAA,IAAW,YAAY;AAAA,IAAW,eAAe;AAAA,IAC5D,WAAW;AAAA,IAAW,cAAc;AAAA,IAAW,gBAAgB;AAAA;AAAA,IAG/D,SAAS;AAAA,IAAU,YAAY;AAAA,IAAU,qBAAqB;AAAA,IAC9D,YAAY;AAAA,IAAU,QAAQ;AAAA,IAAU,UAAU;AAAA;AAAA,IAGlD,WAAW;AAAA,IAAY,WAAW;AAAA,IAAY,aAAa;AAAA,IAC3D,OAAO;AAAA,IAAY,YAAY;AAAA,IAAY,cAAc;AAAA,IACzD,cAAc;AAAA,IAAY,eAAe;AAAA;AAAA,IAGzC,aAAa;AAAA,IAAa,cAAc;AAAA,IACxC,SAAS;AAAA,IAAa,WAAW;AAAA,IAAa,oBAAiB;AAAA;AAAA,IAG/D,YAAY;AAAA,IAAY,WAAW;AAAA,IAAY,aAAa;AAAA,IAC5D,cAAc;AAAA,IAAY,iBAAc;AAAA,IAAY,WAAW;AAAA,IAC/D,aAAa;AAAA,IAAY,QAAQ;AAAA,IAAY,WAAW;AAAA,IACxD,aAAa;AAAA,IAAY,YAAY;AAAA,IAAY,SAAS;AAAA,IAC1D,gBAAa;AAAA,IAAY,aAAa;AAAA;AAAA,IAGtC,YAAY;AAAA,IAAa,UAAU;AAAA,IAAa,WAAW;AAAA,IAC3D,eAAe;AAAA,IAAa,QAAQ;AAAA;AAAA,IAGpC,OAAO;AAAA,IAAQ,eAAe;AAAA,IAAQ,gBAAgB;AAAA,IACtD,OAAO;AAAA,IAAQ,eAAe;AAAA,IAAQ,gBAAgB;AAAA,IACtD,cAAc;AAAA,IAAQ,UAAU;AAAA,IAAQ,WAAW;AAAA,IACnD,WAAW;AAAA,IAAQ,YAAY;AAAA,IAAQ,SAAS;AAAA,IAChD,YAAY;AAAA,IAAQ,SAAS;AAAA,IAAQ,aAAa;AAAA,IAClD,wBAAwB;AAAA,IAAQ,WAAW;AAAA;AAAA,IAG3C,UAAU;AAAA,IAAO,kBAAkB;AAAA,IAAO,WAAW;AAAA,IAAO,YAAY;AAAA;AAAA,IAGxE,aAAa;AAAA,IAAa,OAAO;AAAA,IACjC,YAAY;AAAA,IAAa,SAAS;AAAA,IAAa,SAAS;AAAA;AAAA,IAGxD,WAAW;AAAA,IAAW,UAAU;AAAA,IAAW,WAAW;AAAA,IACtD,aAAa;AAAA,IAAW,kBAAe;AAAA,EACzC;AAEA,SAAO,IAAI,CAAC,KAAK;AACnB;AAvFgB;AA8FT,SAAS,sBAAsB,SAAiB,SAA0D;AAC/G,QAAM,WAAW,QAAQ,YAAY;AAErC,QAAM,iBAAyE;AAAA,IAC7E,QAAQ;AAAA,MACN,UAAU;AAAA,QACR;AAAA,QAAW;AAAA,QAAQ;AAAA,QAAY;AAAA,QAC/B;AAAA,QAAmB;AAAA,QAAU;AAAA,QAAa;AAAA,QAAgB;AAAA,QAC1D;AAAA,QAAiB;AAAA,QAAqB;AAAA,QAAgB;AAAA,QACtD;AAAA,QAAS;AAAA,QAAO;AAAA,QAAW;AAAA,QAAa;AAAA,QAAS;AAAA,QACjD;AAAA,QAA2B;AAAA,QAAmB;AAAA,QAC9C;AAAA,QAAU;AAAA,QAAW;AAAA,QAAoB;AAAA,QACzC;AAAA,QAAY;AAAA,QAAU;AAAA,QAAc;AAAA,QAAc;AAAA,QAAU;AAAA,MAC9D;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,SAAS;AAAA,MACP,UAAU;AAAA,QACR;AAAA,QAAW;AAAA,QAAY;AAAA,QAAQ;AAAA,QAAQ;AAAA,QAAS;AAAA,QAAO;AAAA,QACvD;AAAA,QAAU;AAAA,QAAU;AAAA,QAAM;AAAA,QAAM;AAAA,QAChC;AAAA,QAAe;AAAA,QAAU;AAAA,QAAS;AAAA,QAAS;AAAA,QAAe;AAAA,QAAW;AAAA,QAAS;AAAA,QAC9E;AAAA,QAAS;AAAA,QAAU;AAAA,QAAO;AAAA,QAAQ;AAAA,QAAU;AAAA,QAAU;AAAA,QACtD;AAAA,QAAiB;AAAA,QAAU;AAAA,QAC3B;AAAA,QAAU;AAAA,QAAQ;AAAA,QAAS;AAAA,QAAO;AAAA,QAAO;AAAA,QAAe;AAAA,QACxD;AAAA,QAAO;AAAA,QAAU;AAAA,QAAsB;AAAA,QAAU;AAAA,QACjD;AAAA,QAAQ;AAAA,QAAS;AAAA,QAAS;AAAA,QAAS;AAAA,QAAa;AAAA,QAChD;AAAA,QAAM;AAAA,QAAQ;AAAA,QAAY;AAAA,QAAS;AAAA,QAAO;AAAA,QAC1C;AAAA,QAAkB;AAAA,QAAmB;AAAA,QACrC;AAAA,QAAmB;AAAA,QAAiB;AAAA,QAAa;AAAA,QACjD;AAAA,QAAmB;AAAA,QAAe;AAAA,QAClC;AAAA,QAAsB;AAAA,QAAmB;AAAA,QAAoB;AAAA,QAC7D;AAAA,QAAY;AAAA,QAAY;AAAA,QACxB;AAAA,QAAgC;AAAA,QAAc;AAAA,QAC9C;AAAA,QAAU;AAAA,QAAS;AAAA,QAAa;AAAA,QAChC;AAAA,QAAS;AAAA,QAAa;AAAA,QAAe;AAAA,QACrC;AAAA,QAAe;AAAA,QAAkB;AAAA,QAAY;AAAA,QAC7C;AAAA,QAAiB;AAAA,QAAiB;AAAA,QAClC;AAAA,QAAe;AAAA,QAAQ;AAAA,QAAQ;AAAA,QAC/B;AAAA,QAAU;AAAA,MACZ;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,UAAU;AAAA,MACR,UAAU;AAAA,QACR;AAAA,QAAU;AAAA,QAAU;AAAA,QAAW;AAAA,QAC/B;AAAA,QAAM;AAAA,QAAY;AAAA,QAAY;AAAA,QAAY;AAAA,QAC1C;AAAA,QAAU;AAAA,QAAW;AAAA,QAAa;AAAA,QAAY;AAAA,QAAY;AAAA,QAC1D;AAAA,QAAiB;AAAA,QAAiB;AAAA,QAAgB;AAAA,QAClD;AAAA,QAAe;AAAA,QAAkB;AAAA,QAAmB;AAAA,QACpD;AAAA,QAAgB;AAAA,QAChB;AAAA,QAAmB;AAAA,QAAqB;AAAA,QAAiB;AAAA,QACzD;AAAA,QAAW;AAAA,QAAS;AAAA,QAAa;AAAA,QAAY;AAAA,QAAY;AAAA,QACzD;AAAA,QAAY;AAAA,MACd;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,UAAU;AAAA,MACR,UAAU;AAAA,QACR;AAAA,QAAW;AAAA,QAAU;AAAA,QAAiB;AAAA,QAAQ;AAAA,QAAK;AAAA,QAAO;AAAA,QAC1D;AAAA,QAAkB;AAAA,QAAS;AAAA,QAAc;AAAA,QAAM;AAAA,QAC/C;AAAA,QAAU;AAAA,QAAa;AAAA,QACvB;AAAA,QAAY;AAAA,QAAQ;AAAA,QAAS;AAAA,QAAS;AAAA,QAAQ;AAAA,QAAS;AAAA,MACzD;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,UAAU;AAAA,MACR,UAAU;AAAA,QACR;AAAA,QAAU;AAAA,QAAS;AAAA,QAAM;AAAA,QAAM;AAAA,QAAQ;AAAA,QAAa;AAAA,QAAc;AAAA,QAAa;AAAA,QAAa;AAAA,QAC5F;AAAA,QAAa;AAAA,QAAa;AAAA,QAAO;AAAA,QACjC;AAAA,QACA;AAAA,QAAqB;AAAA,QAAqB;AAAA,QAC1C;AAAA,QAAiB;AAAA,QAAgB;AAAA,QACjC;AAAA,QAAQ;AAAA,MACV;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,UAAU;AAAA,MACR,UAAU;AAAA,QACR;AAAA,QAAY;AAAA,QAAW;AAAA,QAAU;AAAA,QAAa;AAAA,QAC9C;AAAA,QAAQ;AAAA,QAAY;AAAA,QAAW;AAAA,QAAY;AAAA,QAC3C;AAAA,QAAY;AAAA,QAAU;AAAA,QAAO;AAAA,QAC7B;AAAA,QAAc;AAAA,QAAe;AAAA,QAAU;AAAA,QAAe;AAAA,QACtD;AAAA,QAAmB;AAAA,QACnB;AAAA,QAAa;AAAA,QAAY;AAAA,MAC3B;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,SAAS;AAAA,MACP,UAAU;AAAA,QACR;AAAA,QAAc;AAAA,QAAU;AAAA,QAAU;AAAA,QAAU;AAAA,QAC5C;AAAA,QAAa;AAAA,QAAe;AAAA,QAAO;AAAA,QACnC;AAAA,QAAiB;AAAA,QAAU;AAAA,QAC3B;AAAA,MACF;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,KAAK;AAAA,MACH,UAAU;AAAA,QACR;AAAA,QAAM;AAAA,QAAS;AAAA,QAAQ;AAAA,QAAiB;AAAA,QAAU;AAAA,QAAW;AAAA,QAC7D;AAAA,QAAuB;AAAA,QAAiB;AAAA,QACxC;AAAA,QAAM;AAAA,QAAY;AAAA,QAAmB;AAAA,QACrC;AAAA,QAAiB;AAAA,QAAoB;AAAA,QACrC;AAAA,QAAY;AAAA,QAAoB;AAAA,QAChC;AAAA,QAAmB;AAAA,QACnB;AAAA,QAAc;AAAA,QAAe;AAAA,QAC7B;AAAA,QAAU;AAAA,MACZ;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,WAAW;AAAA,MACT,UAAU;AAAA,QACR;AAAA,QAAe;AAAA,QAAgB;AAAA,QAAgB;AAAA,QAC/C;AAAA,QAAW;AAAA,QAAY;AAAA,QAAiB;AAAA,QACxC;AAAA,QAAc;AAAA,QAAO;AAAA,QAAS;AAAA,QAC9B;AAAA,QAAiB;AAAA,QAAmB;AAAA,MACtC;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,MAAM;AAAA,MACJ,UAAU;AAAA,QACR;AAAA,QAAM;AAAA,QAAW;AAAA,QAAU;AAAA,QAAc;AAAA,QACzC;AAAA,QAAc;AAAA,QAAY;AAAA,QAAU;AAAA,QAAS;AAAA,QAAc;AAAA,QAC3D;AAAA,QAAiB;AAAA,QAAQ;AAAA,QACzB;AAAA,QAAiB;AAAA,QAAuB;AAAA,QACxC;AAAA,QAAU;AAAA,MACZ;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,WAAW;AAAA,MACT,UAAU;AAAA,QACR;AAAA,QAAa;AAAA,QAAY;AAAA,QAAa;AAAA,QAAY;AAAA,QAAa;AAAA,QAC/D;AAAA,QAAY;AAAA,QAAkB;AAAA,QAC9B;AAAA,QAAa;AAAA,QAAQ;AAAA,QAAM;AAAA,QAAY;AAAA,QAAyB;AAAA,QAChE;AAAA,QAAe;AAAA,QAAY;AAAA,QAAQ;AAAA,QAAS;AAAA,QAC5C;AAAA,QAAmB;AAAA,QAAU;AAAA,QAAe;AAAA,QAAY;AAAA,QAAY;AAAA,QAAY;AAAA,QAChF;AAAA,QAAU;AAAA,QAAgB;AAAA,QAAgB;AAAA,QAAc;AAAA,QACxD;AAAA,QAAiB;AAAA,QAAmB;AAAA,QAAqB;AAAA,QACzD;AAAA,QAAiB;AAAA,QAAgB;AAAA,QAAc;AAAA,MACjD;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,MAAM;AAAA,MACJ,UAAU;AAAA,QACR;AAAA,QAAQ;AAAA,QAAY;AAAA,QAAe;AAAA,QAAW;AAAA,QAAM;AAAA,QACpD;AAAA,QAAmB;AAAA,QAAM;AAAA,QAAc;AAAA,QAAc;AAAA,QAAa;AAAA,QAClE;AAAA,QAAY;AAAA,QAAe;AAAA,QAAe;AAAA,QAAgB;AAAA,QAAQ;AAAA,QAClE;AAAA,QAAU;AAAA,QAAU;AAAA,QAAc;AAAA,QAAe;AAAA,QACjD;AAAA,QAAiB;AAAA,QAAkB;AAAA,QACnC;AAAA,QAAkB;AAAA,QAAkB;AAAA,QAAW;AAAA,QAAmB;AAAA,QAClE;AAAA,QAAS;AAAA,QAAY;AAAA,MACvB;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,WAAW;AAAA,MACT,UAAU;AAAA,QACR;AAAA,QAAQ;AAAA,QAAa;AAAA,QAAY;AAAA,QAAW;AAAA,QAAW;AAAA,QAAgB;AAAA,QACvE;AAAA,QAAmB;AAAA,QAAU;AAAA,QAAW;AAAA,QAAa;AAAA,QACrD;AAAA,QAAoB;AAAA,QAAY;AAAA,QAAmB;AAAA,QAAgB;AAAA,QACnE;AAAA,QAAkB;AAAA,QAAmB;AAAA,QAAgB;AAAA,QACrD;AAAA,QAAgB;AAAA,QAAgB;AAAA,QAAqB;AAAA,QACrD;AAAA,QAAS;AAAA,MACX;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,eAAe;AAAA,MACb,UAAU;AAAA,QACR;AAAA,QAAe;AAAA,QAAgB;AAAA,QAAqB;AAAA,QAAM;AAAA,QAAS;AAAA,QACnE;AAAA,QAAU;AAAA,QAAoB;AAAA,QAAmB;AAAA,QACjD;AAAA,QAAmB;AAAA,QAAoB;AAAA,QAAuB;AAAA,QAC9D;AAAA,QAA0B;AAAA,QAA0B;AAAA,QACpD;AAAA,QAA0B;AAAA,QAAwB;AAAA,QAClD;AAAA,QAAwB;AAAA,QAAqB;AAAA,QAC7C;AAAA,QAAgB;AAAA,MAClB;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,IACA,SAAS;AAAA,MACP,UAAU;AAAA,QACR;AAAA,QAAqB;AAAA,QAAsB;AAAA,QAAoB;AAAA,QAC/D;AAAA,QAAiB;AAAA,QAAoB;AAAA,QAAkB;AAAA,QAAgB;AAAA,QACvE;AAAA,QAAuB;AAAA,QAAiB;AAAA,QAAkB;AAAA,QAAe;AAAA,QAAqB;AAAA,QAC9F;AAAA,QAAgB;AAAA,QAAiB;AAAA,QAAqB;AAAA,QAAqB;AAAA,QAC3E;AAAA,QAAO;AAAA,QAAS;AAAA,QAAgB;AAAA,QAChC;AAAA,QAAU;AAAA,QAAqB;AAAA,QAA6B;AAAA,QAC5D;AAAA,QAAgB;AAAA,QAAiB;AAAA,QAAe;AAAA,QAChD;AAAA,QAAc;AAAA,QAAY;AAAA,QAC1B;AAAA,QAAiB;AAAA,QAAiB;AAAA,QAAiB;AAAA,MACrD;AAAA,MACA,QAAQ;AAAA,IACV;AAAA,EACF;AAEA,QAAM,SAAiC,CAAC;AAGxC,aAAW,CAAC,QAAQ,GAAG,KAAK,OAAO,QAAQ,cAAc,GAAG;AAC1D,QAAI,QAAQ;AACZ,eAAW,MAAM,IAAI,UAAU;AAC7B,UAAI,MAAM,SAAS,SAAS,EAAE,EAAG,UAAS,IAAI;AAAA,IAChD;AACA,QAAI,QAAQ,EAAG,QAAO,MAAM,IAAI;AAAA,EAClC;AAGA,QAAM,gBAAgB,QAAQ,MAAM,EAAE;AACtC,WAAS,IAAI,GAAG,IAAI,cAAc,QAAQ,KAAK;AAC7C,UAAM,MAAM,cAAc,CAAC;AAC3B,UAAM,YAAY,IAAI,QAAQ,YAAY;AAC1C,UAAM,QAAQ,OAAO,IAAI,IAAI,KAAK,IAAI,GAAG,cAAc,MAAM;AAC7D,eAAW,CAAC,QAAQ,GAAG,KAAK,OAAO,QAAQ,cAAc,GAAG;AAC1D,iBAAW,MAAM,IAAI,UAAU;AAC7B,YAAI,MAAM,UAAU,SAAS,EAAE,GAAG;AAChC,iBAAO,MAAM,KAAK,OAAO,MAAM,KAAK,KAAM,IAAI,SAAS;AAAA,QACzD;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAGA,MAAI,aAAa;AACjB,MAAI,YAAY;AAChB,aAAW,CAAC,QAAQ,KAAK,KAAK,OAAO,QAAQ,MAAM,GAAG;AACpD,QAAI,QAAQ,WAAW;AACrB,kBAAY;AACZ,mBAAa;AAAA,IACf;AAAA,EACF;AAEA,SAAO,EAAE,QAAQ,gBAAgB,UAAU,GAAG,OAAO,UAAU;AACjE;AArOgB;AAyOT,SAAS,gBAAgB,SAAsD;AACpF,QAAM,IAAI,WAAW;AACrB,QAAM,MAA2C,CAAC;AAElD,QAAM,WAAW,EAAE,MAAM,oBAAoB;AAC7C,MAAI,SAAU,KAAI,MAAM,SAAS,CAAC;AAElC,QAAM,cAAc,EAAE,MAAM,+BAA+B;AAC3D,MAAI,YAAa,KAAI,SAAS,YAAY,CAAC;AAE3C,QAAM,aAAa,EAAE,MAAM,6CAA6C;AACxE,MAAI,WAAY,KAAI,WAAW,WAAW,CAAC;AAE3C,QAAM,WAAW,EAAE,MAAM,sCAAsC;AAC/D,MAAI,SAAU,KAAI,iBAAiB,SAAS,CAAC;AAAA,OACxC;AACH,UAAM,YAAY,EAAE,MAAM,yDAAyD;AACnF,QAAI,UAAW,KAAI,iBAAiB,UAAU,CAAC,EAAE,KAAK;AAAA,EACxD;AAEA,QAAM,KAAK,EAAE,MAAM,gFAAgF;AACnG,MAAI,GAAI,KAAI,iBAAiB,GAAG,CAAC,EAAE,YAAY;AAE/C,QAAM,SAAS,EAAE,MAAM,iBAAiB;AACxC,MAAI,OAAQ,KAAI,gBAAgB,OAAO,CAAC;AAAA,WAC/B,+DAA+D,KAAK,CAAC,GAAG;AAC/E,QAAI,gBAAgB,EAAE,MAAM,GAAG,GAAG;AAAA,EACpC;AAEA,SAAO;AACT;AA9BgB;AAkCT,SAAS,eAAe,KAA4C;AACzE,QAAM,KAAK,OAAO,IAAI,KAAK;AAC3B,MAAI,kBAAkB,KAAK,CAAC,EAAG,QAAO;AACtC,MAAI,6EAA6E,KAAK,CAAC,EAAG,QAAO;AACjG,MAAI,6EAA6E,KAAK,CAAC,EAAG,QAAO;AACjG,SAAO;AACT;AANgB;AAUT,SAAS,oBAAoB,SAAyD;AAC3F,QAAM,eAA2D;AAAA,IAC/D,EAAE,SAAS,4CAA4C,QAAQ,iBAAiB;AAAA,IAChF,EAAE,SAAS,8BAA8B,QAAQ,wBAAwB;AAAA,IACzE,EAAE,SAAS,4BAA4B,QAAQ,sBAAsB;AAAA,IACrE,EAAE,SAAS,mDAAmD,QAAQ,iBAAiB;AAAA,IACvF,EAAE,SAAS,yBAAyB,QAAQ,eAAe;AAAA,IAC3D,EAAE,SAAS,oDAAoD,QAAQ,gBAAgB;AAAA,EACzF;AAEA,aAAW,EAAE,SAAS,OAAO,KAAK,cAAc;AAC9C,QAAI,QAAQ,KAAK,OAAO,EAAG,QAAO,EAAE,WAAW,MAAM,OAAO;AAAA,EAC9D;AAEA,SAAO,EAAE,WAAW,OAAO,QAAQ,GAAG;AACxC;AAfgB;AAmBT,SAAS,eAAe,KAAsB;AACnD,QAAM,YAAY,CAAC,SAAS,WAAW,SAAS,MAAM,OAAO,SAAS,OAAO,OAAO,WAAW,MAAM,UAAU,QAAQ,wCAAU,4BAAQ,gCAAO;AAChJ,QAAM,QAAQ,IAAI,YAAY,EAAE,KAAK;AACrC,QAAM,YAAY,MAAM,MAAM,KAAK,EAAE;AACrC,MAAI,YAAY,EAAG,QAAO;AAC1B,SAAO,UAAU,KAAK,CAAC,MAAM,UAAU,KAAK,MAAM,WAAW,IAAI,GAAG,KAAK,MAAM,SAAS,MAAM,CAAC,CAAC;AAClG;AANgB;AAQT,SAAS,aAAa,KAAsB;AACjD,QAAM,SAAS,CAAC,SAAS,SAAS,UAAU,OAAO,4BAAQ,UAAU;AACrE,QAAM,QAAQ,IAAI,YAAY,EAAE,KAAK;AACrC,QAAM,YAAY,MAAM,MAAM,KAAK,EAAE;AACrC,MAAI,YAAY,EAAG,QAAO;AAC1B,SAAO,OAAO,KAAK,CAAC,MAAM,UAAU,KAAK,MAAM,WAAW,IAAI,GAAG,KAAK,MAAM,SAAS,MAAM,CAAC,CAAC;AAC/F;AANgB;AAUT,SAAS,kBAAkB,SAAiB,SAA0B;AAC3E,QAAM,KAAK,gBAAgB,OAAO;AAClC,QAAM,KAAK,gBAAgB,OAAO;AAElC,QAAM,gBAA4B;AAAA,IAChC,CAAC,YAAY,UAAU,YAAY,WAAW;AAAA,IAC9C,CAAC,UAAU,YAAY,UAAU;AAAA,IACjC,CAAC,WAAW,YAAY,SAAS;AAAA,IACjC,CAAC,YAAY,aAAa,SAAS;AAAA,IACnC,CAAC,WAAW,YAAY,UAAU;AAAA,IAClC,CAAC,QAAQ,YAAY,WAAW;AAAA,EAClC;AAEA,SAAO,cAAc,KAAK,CAAC,UAAU,MAAM,SAAS,EAAE,KAAK,MAAM,SAAS,EAAE,CAAC;AAC/E;AAdgB;AAmBT,SAAS,yBACd,OACA,SACe;AACf,QAAM,eAAuC,CAAC;AAE9C,aAAW,QAAQ,MAAM,OAAO;AAC9B,UAAM,MAAM,gBAAgB,KAAK,MAAM;AACvC,QAAI,OAAO,QAAQ,WAAW;AAC5B,mBAAa,GAAG,KAAK,aAAa,GAAG,KAAK,KAAK,KAAK,QAAQ;AAAA,IAC9D;AAAA,EACF;AAEA,aAAW,QAAQ,QAAQ,OAAO;AAChC,UAAM,MAAM,gBAAgB,KAAK,MAAM;AACvC,QAAI,OAAO,QAAQ,WAAW;AAC5B,mBAAa,GAAG,KAAK,aAAa,GAAG,KAAK,KAAK,KAAK;AAAA,IACtD;AAAA,EACF;AAEA,QAAM,UAAU,OAAO,QAAQ,YAAY;AAC3C,MAAI,QAAQ,WAAW,EAAG,QAAO;AAEjC,UAAQ,KAAK,CAAC,GAAG,MAAM,EAAE,CAAC,IAAI,EAAE,CAAC,CAAC;AAClC,QAAM,CAAC,SAAS,SAAS,IAAI,QAAQ,CAAC;AACtC,QAAM,cAAc,QAAQ,SAAS,IAAI,QAAQ,CAAC,EAAE,CAAC,IAAI;AAEzD,MAAI,YAAY,MAAM,gBAAgB,KAAK,aAAa,cAAc,MAAM;AAC1E,WAAO,eAAe,OAAO;AAAA,EAC/B;AAEA,SAAO;AACT;AAhCgB;;;AC1bT,SAAS,YAAY,KAAsC;AAChE,QAAM,SAAS,IAAI,QAAQ,IAAI,QAAQ,KAAK;AAC5C,SAAO;AAAA,IACL,+BAA+B;AAAA,IAC/B,gCAAgC;AAAA,IAChC,gCAAgC;AAAA,IAChC,0BAA0B;AAAA,EAC5B;AACF;AARgB;AAUT,SAAS,UAAU,KAAwB;AAChD,SAAO,IAAI,SAAS,MAAM,EAAE,QAAQ,KAAK,SAAS,YAAY,GAAG,EAAE,CAAC;AACtE;AAFgB;AAIT,SAAS,KAAK,KAAc,MAAc,SAAS,KAAe;AACvE,SAAO,IAAI,SAAS,MAAM;AAAA,IACxB;AAAA,IACA,SAAS,EAAE,gBAAgB,6BAA6B,GAAG,YAAY,GAAG,EAAE;AAAA,EAC9E,CAAC;AACH;AALgB;AAOT,SAAS,KAAK,KAAc,MAAe,SAAS,KAAe;AACxE,SAAO,IAAI,SAAS,KAAK,UAAU,IAAI,GAAG;AAAA,IACxC;AAAA,IACA,SAAS,EAAE,gBAAgB,mCAAmC,GAAG,YAAY,GAAG,EAAE;AAAA,EACpF,CAAC;AACH;AALgB;AAOT,SAAS,QAAQ,GAAmB;AACzC,MAAI,OAAO,MAAM,CAAC,EAAG,QAAO;AAC5B,SAAO,KAAK,IAAI,GAAG,KAAK,IAAI,GAAG,CAAC,CAAC;AACnC;AAHgB;AAOhB,eAAsB,aAAa,KAAmC;AACpE,MAAI;AACF,WAAO,MAAM,IAAI,KAAK;AAAA,EACxB,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AANsB;AAQf,SAAS,MAAM,GAAoB;AACxC,MAAI,OAAO,MAAM,SAAU,QAAO;AAClC,MAAI,KAAK,KAAM,QAAO;AACtB,SAAO,OAAO,CAAC;AACjB;AAJgB;AAQhB,IAAM,YAAY;AAEX,IAAM,mBAA2C;AAAA,EACtD,QAAQ;AAAA,EACR,UAAU;AAAA,EACV,SAAS;AAAA,EACT,UAAU;AAAA,EACV,UAAU;AAAA,EACV,UAAU;AAAA,EACV,SAAS;AAAA,EACT,KAAK;AAAA,EACL,MAAM;AAAA,EACN,WAAW;AACb;AAEO,SAAS,SAAS,SAAiB,UAA6C;AACrF,QAAM,OAAO,iBAAiB,OAAO;AACrC,MAAI,CAAC,KAAM,QAAO;AAClB,SAAO,WAAW,GAAG,SAAS,GAAG,IAAI,IAAI,QAAQ,KAAK,GAAG,SAAS,GAAG,IAAI;AAC3E;AAJgB;AAOT,SAAS,eACd,SACA,WACyC;AACzC,QAAM,QAAQ,iBAAiB,OAAO;AACtC,MAAI,CAAC,MAAO,QAAO;AACnB,SAAO,EAAE,OAAO,4BAAyB,OAAO,GAAG,SAAS,GAAG,KAAK,GAAG;AACzE;AAPgB;AAWT,SAAS,iBAAiB,KAA4B;AAE3D,QAAM,SAAS,IAAI,MAAM,iCAAiC;AAC1D,MAAI,OAAQ,QAAO,OAAO,CAAC,EAAE,KAAK;AAGlC,QAAM,MAAM,IAAI,MAAM,aAAa;AACnC,MAAI,IAAK,QAAO,IAAI,CAAC;AAErB,SAAO;AACT;AAVgB;AA+BT,SAAS,uBACd,SACA,OACyC;AACzC,MAAI,CAAC,OAAO,eAAe,CAAC,OAAO,mBAAmB;AACpD,WAAO,EAAE,QAAQ,SAAS,YAAY,MAAM;AAAA,EAC9C;AACA,SAAO;AAAA,IACL,QAAQ,GAAG,MAAM,iBAAiB;AAAA,eAAe,OAAO;AAAA,IACxD,YAAY;AAAA,EACd;AACF;AAXgB;AAaT,SAAS,gBACd,MACA,YACA,kBACW;AACX,SAAO;AAAA,IACL,aAAa;AAAA,IACb,mBAAmB;AAAA,IACnB,gBAAgB,MAAM,iBAAiB,KAAK;AAAA,EAC9C;AACF;AAVgB;AAcT,SAAS,eAAe,MAAW,SAA+B,CAAC,GAAG;AAC3E,QAAM,SAAS,OAAO,UAClB,qEAAqE,KAAK,OAAO,OAAO,IACxF;AAEJ,MAAI,UAAU,KAAK,aAAa,OAAO;AACrC,SAAK,WAAW;AAAA,EAClB;AAEA,SAAO;AACT;AAVgB;AAcT,SAAS,yBAAyB,MAAgB;AACvD,QAAM,MAAM,QAAQ,OAAO,SAAS,WAAW,OAAO,CAAC;AAEvD,QAAM,UAAU,MAAM,KAAK,QAAQ,EAAE;AACrC,QAAM,OACJ,YAAY,WAAW,YAAY,cAAc,YAAY,YACzD,UACA,KAAK,YAAY,gBACf,aACA,KAAK,YAAY,cACf,UACA;AAEV,QAAM,aAAqB,OAAO,KAAK,eAAe,WAAW,QAAQ,IAAI,UAAU,IAAI;AAC3F,QAAM,aAAa,MAAM,KAAK,WAAW,KAAK,mBAAmB,KAAK,YAAY,KAAK,SAAS,mBAAmB,EAAE;AACrH,QAAM,kBAAkB,eAAe,KAAK,mBAAmB,KAAK,SAAS,mBAAmB,cAAc,KAAK,QAAQ;AAC3H,QAAM,UAAU;AAEhB,QAAM,KAAK,KAAK,MAAM;AACtB,QAAM,UAAU,MAAM,QAAQ,KAAK,OAAO,IAAI,IAAI,UAAU,CAAC;AAC7D,QAAM,YAAsB,MAAM,QAAQ,KAAK,SAAS,IAAI,IAAI,UAAU,IAAI,CAAC,MAAW,MAAM,CAAC,CAAC,IAAI,CAAC;AAEvG,MAAI,SAAS,OAAO,KAAK,WAAW,WAAW,IAAI,SAAS;AAC5D,MAAI,CAAC,UAAU,UAAU,QAAQ;AAC/B,UAAM,UAAU,UAAU,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,EAAE,OAAO,OAAO;AAC7D,QAAI,QAAQ,OAAQ,UAAS,qCAAkC,QAAQ,KAAK,MAAM;AAAA,EACpF;AACA,MAAI,CAAC,UAAU,SAAS,YAAY;AAClC,aAAS;AAAA,EACX;AAEA,QAAM,MAAM,MAAM,KAAK,YAAY,EAAE,EAAE,YAAY;AACnD,QAAM,mBAAmB,CAAC,YAAY,UAAU,YAAY,iBAAiB,oBAAoB,eAAe,EAAE,SAAS,GAAG;AAC9H,QAAM,WAAW,QAAQ,KAAK,SAAS,YAAY,gBAAgB;AAEnE,QAAM,aAAa,KAAK,WAAW,CAAC;AACpC,QAAM,MAAW;AAAA,IACf;AAAA,IACA;AAAA,IACA,SAAS;AAAA,MACP,YAAY,OAAO,WAAW,QAAQ,CAAC,CAAC;AAAA,MACxC;AAAA,MACA;AAAA,MACA,UAAU,OAAO,WAAW,aAAa,WAAW,WAAW,WAAW;AAAA,MAC1E,UAAU,OAAO,WAAW,aAAa,WAAW,WAAW,WAAW;AAAA,MAC1E,WAAW,OAAO,WAAW,cAAc,WAAW,WAAW,YAAY;AAAA,MAC7E,wBAAwB,OAAO,WAAW,2BAA2B,YAAY,WAAW,yBAAyB;AAAA,MACrH,UAAU,OAAO,WAAW,aAAa,WAAW,WAAW,WAAW;AAAA,MAC1E,iBAAiB,OAAO,WAAW,oBAAoB,WAAW,WAAW,kBAAkB;AAAA,IACjG;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACA,MAAI,MAAM,QAAQ,KAAK,QAAQ,EAAG,KAAI,WAAW,IAAI;AACrD,MAAI,OAAO,KAAK,kBAAkB,SAAU,KAAI,gBAAgB,IAAI;AACpE,MAAI,OAAO,KAAK,aAAa,UAAW,KAAI,WAAW,IAAI;AAC3D,MAAI,OAAO,KAAK,YAAY,SAAU,KAAI,UAAU,IAAI;AACxD,MAAI,OAAO,KAAK,aAAa,SAAU,KAAI,WAAW,IAAI;AAC1D,MAAI,KAAK,MAAO,CAAC,IAAY,QAAQ,IAAI;AAEzC,MAAI,OAAO,KAAK,gBAAgB,SAAU,KAAI,cAAc,IAAI;AAChE,MAAI,OAAO,KAAK,cAAc,SAAU,KAAI,YAAY,IAAI;AAC5D,MAAI,OAAO,KAAK,aAAa,SAAU,KAAI,WAAW,IAAI;AAC1D,MAAI,OAAO,KAAK,sBAAsB,SAAU,KAAI,oBAAoB,IAAI;AAC5E,MAAI,OAAO,KAAK,uBAAuB,SAAU,KAAI,qBAAqB,IAAI;AAE9E,EAAC,IAAY,kBAAkB;AAC/B,EAAC,IAAY,kBAAkB,IAAI;AACnC,MAAI,CAAC,IAAI,MAAM,IAAI,SAAS,QAAS,KAAI,KAAK,eAAe,IAAI,SAAS,IAAI,QAAQ;AACtF,SAAO;AACT;AAvEgB;;;ACxJhB,SAAS,aAAa,WAAmB,WAA4B;AACnE,MAAI,YAAY,EAAG,QAAO;AAC1B,MAAI,cAAc,gBAAgB,cAAc,SAAU,QAAO;AAEjE,MAAI,cAAc,cAAc;AAC9B,WAAO;AAAA;AAAA;AAAA;AAAA;AAAA,EAKT;AAEA,SAAO;AAAA;AAAA;AAAA;AAAA;AAKT;AAjBS;AAyBF,SAAS,gBAAgB,MAA2D;AACzF,QAAM,UAAU,aAAa,MAAM,aAAa,GAAG,MAAM,SAAS;AAElE,SAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAiDP,OAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAqBT;AAzEgB;AAyFT,SAAS,iBACd,gBACA,SACA,kBACA,cACA,MAC0C;AAC1C,QAAM,eAAe,gBAAgB,IAAI;AAEzC,QAAM,OAAiD;AAAA,IACrD,EAAE,MAAM,UAAU,SAAS,aAAa;AAAA,EAC1C;AAGA,QAAM,gBAAgB,QAAQ,MAAM,GAAG;AACvC,aAAW,OAAO,eAAe;AAC/B,SAAK,KAAK,EAAE,MAAM,IAAI,MAAM,SAAS,IAAI,QAAQ,MAAM,GAAG,GAAG,EAAE,CAAC;AAAA,EAClE;AAGA,QAAM,aAAa,eAAe;AAAA;AAAA,EAAiC,YAAY;AAAA,IAAO;AACtF,QAAM,cAAc,GAAG,cAAc,GAAG,UAAU;AAAA;AAAA,EAAoC,gBAAgB;AAAA;AAAA;AACtG,OAAK,KAAK,EAAE,MAAM,QAAQ,SAAS,YAAY,CAAC;AAGhD,OAAK,KAAK,EAAE,MAAM,aAAa,SAAS,IAAI,CAAC;AAE7C,SAAO;AACT;AA5BgB;;;ACpHhB,eAAsB,UAAU,KAAUA,OAAwC;AAChF,MAAI;AACF,UAAM,SAAU,MAAM,IAAI,GAAG,IAAI,aAAa,EAAE,MAAAA,MAAK,CAAC;AACtD,QAAI,QAAQ,OAAO,CAAC,EAAG,QAAO,OAAO,KAAK,CAAC;AAC3C,WAAO;AAAA,EACT,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AARsB;AAetB,eAAsB,kBACpB,KACA,OACA,QACA,UACA,iBACA,YACA,aAC2B;AAC3B,QAAM,UAAU,MAAM,MAAM,MAAM,QAAQ;AAAA,IACxC,MAAM,aAAa;AAAA,IACnB,QAAQ,EAAE,WAAW,SAAS;AAAA,IAC9B,gBAAgB;AAAA,EAClB,CAAC;AAED,QAAM,UAAU,SAAS,WAAW,CAAC;AAGrC,QAAM,gBAAgB,QAAQ,IAAI,CAAC,UAAU;AAC3C,QAAI,QAAQ,MAAM,SAAS;AAC3B,UAAM,gBAAgB,MAAM,MAAM,UAAU,UAAU,EAAE;AACxD,UAAM,aAAa,gBAAgB,aAAa;AAChD,UAAM,OAAO,gBAAgB,eAAe;AAE5C,QAAI,eAAe,MAAM;AACvB,eAAS;AAAA,IACX,WAAW,kBAAkB,YAAY,IAAI,GAAG;AAC9C,eAAS;AAAA,IACX;AAEA,WAAO,EAAE,GAAG,OAAO,eAAe,MAAM;AAAA,EAC1C,CAAC;AAED,gBAAc,KAAK,CAAC,GAAG,OAAO,EAAE,iBAAiB,MAAM,EAAE,iBAAiB,EAAE;AAG5E,QAAM,OAAO,oBAAI,IAAY;AAC7B,QAAM,gBAAgB,cAAc,OAAO,CAAC,MAAM;AAChD,UAAM,MAAM,GAAG,EAAE,UAAU,MAAM,IAAI,EAAE,EAAE;AACzC,QAAI,KAAK,IAAI,GAAG,EAAG,QAAO;AAC1B,SAAK,IAAI,GAAG;AACZ,WAAO;AAAA,EACT,CAAC;AAED,QAAM,aAAa,cAAc,MAAM,GAAG,UAAU;AAEpD,QAAM,SAAS,WAAW,IAAI,CAAC,MAAM,EAAE,iBAAiB,CAAC;AACzD,QAAM,WAAW,OAAO,SAAS,OAAO,OAAO,CAAC,GAAG,MAAM,IAAI,GAAG,CAAC,IAAI,OAAO,SAAS;AACrF,QAAM,WAAW,OAAO,SAAS,KAAK,IAAI,GAAG,MAAM,IAAI;AAGvD,QAAM,QAA4E,CAAC;AAEnF,MAAI,gBAAgB,YAAY;AAC9B,eAAW,SAAS,YAAY;AAC9B,YAAM,QAAQ,MAAM,MAAM,UAAU,UAAU,EAAE;AAChD,UAAI,CAAC,MAAO;AACZ,UAAI;AACF,cAAM,MAAM,MAAM,IAAI,YAAY,IAAI,KAAK;AAC3C,YAAI,CAAC,IAAK;AACV,cAAM,MAAM,MAAM,IAAI,KAAK;AAC3B,cAAM,SAAS,KAAK,MAAM,GAAG;AAC7B,cAAM,KAAK;AAAA,UACT,IAAI,MAAM;AAAA,UACV,MAAM,yBAAyB,OAAO,QAAQ;AAAA,UAC9C,OAAO,MAAM,iBAAiB;AAAA,UAC9B,QAAQ,MAAM,MAAM,UAAU,UAAU,EAAE;AAAA,QAC5C,CAAC;AAAA,MACH,QAAQ;AACN;AAAA,MACF;AAAA,IACF;AAAA,EACF,OAAO;AACL,eAAW,SAAS,YAAY;AAC9B,YAAM,KAAK;AAAA,QACT,IAAI,MAAM;AAAA,QACV,MAAM,MAAM,MAAM,UAAU,QAAQ,EAAE;AAAA,QACtC,OAAO,MAAM,iBAAiB;AAAA,QAC9B,QAAQ,MAAM,MAAM,UAAU,UAAU,EAAE;AAAA,MAC5C,CAAC;AAAA,IACH;AAAA,EACF;AAEA,QAAMA,QAAO,MAAM,IAAI,CAAC,SAAS,KAAK,IAAI,EAAE,KAAK,aAAa;AAE9D,SAAO,EAAE,MAAAA,OAAM,OAAO,SAAS,YAAY,UAAU,SAAS;AAChE;AAtFsB;AA0Ff,SAAS,yBAAyB,UAA4B;AACnE,QAAM,QAAkB,CAAC;AAEzB,QAAM,KAAK,cAAc,SAAS,SAAS,SAAS,EAAE,GAAG;AACzD,MAAI,SAAS,MAAO,OAAM,KAAK,WAAW,SAAS,KAAK,EAAE;AAC1D,MAAI,SAAS,YAAa,OAAM,KAAK,gBAAgB,SAAS,WAAW,EAAE;AAE3E,MAAI,SAAS,YAAY,SAAS,SAAS,SAAS,GAAG;AACrD,UAAM,KAAK,iBAAc,SAAS,SAAS,MAAM,GAAG,CAAC,EAAE,KAAK,IAAI,CAAC,EAAE;AAAA,EACrE;AAEA,MAAI,SAAS,eAAe;AAC1B,UAAM,KAAK;AAAA,uBAA0B;AACrC,eAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,SAAS,aAAa,GAAG;AACjE,YAAM,KAAK,KAAK,GAAG,KAAK,KAAK,EAAE;AAAA,IACjC;AAAA,EACF;AAEA,MAAI,SAAS,iBAAiB,SAAS,cAAc,SAAS,GAAG;AAC/D,UAAM,KAAK;AAAA,uBAAuB;AAClC,eAAW,OAAO,SAAS,cAAc,MAAM,GAAG,CAAC,GAAG;AACpD,YAAM,KAAK,uBAAe,IAAI,OAAO,EAAE;AACvC,YAAM,KAAK,YAAY,IAAI,KAAK,EAAE;AAClC,YAAM,KAAK,eAAe,IAAI,QAAQ,EAAE;AAAA,IAC1C;AAAA,EACF;AAEA,MAAI,SAAS,sBAAsB;AACjC,UAAM,KAAK;AAAA,cAAiB,KAAK,UAAU,SAAS,oBAAoB,CAAC,EAAE;AAAA,EAC7E;AAEA,QAAM,KAAK;AAAA,aAAa,SAAS,MAAM,MAAM,IAAI;AACjD,WAAS,IAAI,GAAG,IAAI,KAAK,IAAI,SAAS,MAAM,QAAQ,CAAC,GAAG,KAAK;AAC3D,UAAM,OAAO,SAAS,MAAM,CAAC;AAC7B,UAAM,KAAK,GAAG,IAAI,CAAC,MAAM,KAAK,KAAK,YAAY,CAAC,GAAG;AACnD,QAAI,KAAK,MAAO,OAAM,KAAK,MAAM,KAAK,KAAK,EAAE;AAE7C,YAAQ,KAAK,MAAM;AAAA,MACjB,KAAK;AACH,cAAM,KAAK,SAAS,KAAK,SAAS,MAAM,GAAG,GAAG,CAAC,EAAE;AACjD;AAAA,MACF,KAAK;AACH,cAAM,KAAK,MAAM,KAAK,SAAS,MAAM,GAAG,GAAG,CAAC,EAAE;AAC9C,YAAI,KAAK,iBAAiB,KAAK,cAAc,SAAS,GAAG;AACvD,gBAAM,KAAK,eAAe,KAAK,cAAc,MAAM,GAAG,CAAC,EAAE,KAAK,IAAI,CAAC,EAAE;AAAA,QACvE;AACA,YAAI,KAAK,gBAAgB,KAAK,aAAa,SAAS,GAAG;AACrD,gBAAM,KAAK,iBAAiB,KAAK,aAAa,MAAM,GAAG,CAAC,EAAE,KAAK,IAAI,CAAC,EAAE;AAAA,QACxE;AACA;AAAA,MACF,KAAK;AACH,cAAM,KAAK,cAAc,KAAK,MAAM,EAAE;AACtC;AAAA,IACJ;AAAA,EACF;AAEA,MAAI,SAAS,kBAAkB,SAAS,eAAe,SAAS,GAAG;AACjE,UAAM,KAAK;AAAA,kBAAqB;AAChC,aAAS,eAAe,MAAM,GAAG,CAAC,EAAE,QAAQ,CAAC,MAAM,MAAM,KAAK,KAAK,CAAC,EAAE,CAAC;AAAA,EACzE;AAEA,SAAO,MAAM,KAAK,IAAI;AACxB;AA9DgB;AAkET,SAAS,eACd,eACA,iBACA,aACA,cAAsB,GAC6D;AACnF,QAAM,cAAc,oBAAI,IAAwF;AAGhH,MAAI,MAAM,QAAQ,aAAa,GAAG;AAChC,eAAW,KAAK,eAAe;AAC7B,UAAI,CAAC,GAAG,MAAM,CAAC,GAAG,QAAS;AAC3B,YAAM,SAAS,GAAG,WAAW,aAAa,aAAa;AACvD,YAAM,MAAM,GAAG,MAAM,IAAI,EAAE,EAAE;AAC7B,kBAAY,IAAI,KAAK;AAAA,QACnB;AAAA,QACA,IAAI,MAAM,EAAE,EAAE;AAAA,QACd,SAAS,MAAM,EAAE,OAAO,EAAE,MAAM,GAAG,GAAG;AAAA,QACtC,OAAO;AAAA,MACT,CAAC;AAAA,IACH;AAAA,EACF;AAGA,aAAW,QAAQ,gBAAgB,MAAM,MAAM,GAAG,CAAC,GAAG;AACpD,UAAM,MAAM,YAAY,KAAK,EAAE;AAC/B,QAAI,CAAC,YAAY,IAAI,GAAG,GAAG;AACzB,YAAM,UAAU,KAAK,KAAK,MAAM,IAAI,EAAE,MAAM,GAAG,CAAC,EAAE,KAAK,GAAG,EAAE,MAAM,GAAG,GAAG;AACxE,kBAAY,IAAI,KAAK,EAAE,QAAQ,YAAY,IAAI,KAAK,IAAI,SAAS,OAAO,KAAK,MAAM,CAAC;AAAA,IACtF;AAAA,EACF;AAGA,aAAW,SAAS,YAAY,QAAQ,MAAM,GAAG,CAAC,GAAG;AACnD,UAAM,KAAK,MAAM,OAAO,MAAM,EAAE;AAChC,UAAM,MAAM,OAAO,EAAE;AACrB,QAAI,CAAC,YAAY,IAAI,GAAG,GAAG;AACzB,YAAM,UAAU,WAAW,MAAM,OAAO,UAAU,UAAU,EAAE,CAAC,cAAc,OAAO,QAAQ,KAAK,QAAQ,CAAC,CAAC;AAC3G,kBAAY,IAAI,KAAK,EAAE,QAAQ,OAAO,IAAI,SAAS,OAAO,OAAO,SAAS,EAAE,CAAC;AAAA,IAC/E;AAAA,EACF;AAEA,QAAM,cAAc,MAAM,KAAK,YAAY,OAAO,CAAC;AACnD,cAAY,KAAK,CAAC,GAAG,MAAM,EAAE,QAAQ,EAAE,KAAK;AAC5C,SAAO,YAAY,MAAM,GAAG,WAAW;AACzC;AA7CgB;AAiDT,SAAS,sBACd,iBACA,iBACA,aACQ;AACR,QAAM,QAAkB,CAAC;AACzB,QAAM,KAAK,0BAAoB,eAAe,GAAG;AAEjD,MAAI,gBAAgB,KAAK,KAAK,GAAG;AAC/B,UAAM,KAAK,gCAAgC;AAC3C,UAAM,KAAK,gBAAgB,IAAI;AAAA,EACjC;AAEA,MAAI,YAAY,KAAK,KAAK,GAAG;AAC3B,UAAM,KAAK,oCAAoC;AAC/C,UAAM,KAAK,YAAY,IAAI;AAAA,EAC7B;AAEA,SAAO,MAAM,KAAK,IAAI;AACxB;AAnBgB;AA4BT,SAAS,kBAAkB,MAKvB;AACT,QAAM,EAAE,eAAe,mBAAmB,cAAc,aAAa,IAAI;AAGzE,QAAM,UAAU,QAAQ,iBAAiB;AACzC,QAAM,SAAS,QAAQ,KAAK,IAAI,eAAe,GAAG,CAAC,CAAC;AACpD,QAAM,UAAU,QAAQ,eAAe,MAAM,IAAI,eAAe,KAAK,MAAM,eAAe,KAAK,MAAM,CAAC;AAEtG,QAAM,YACJ,gBAAgB,MAChB,UAAU,MACV,SAAS,OACT,UAAU;AAGZ,SAAO,QAAQ,OAAO,UAAU,QAAQ,CAAC,CAAC,CAAC;AAC7C;AArBgB;;;AChLhB,IAAM,oBAA8B;AAAA,EAClC;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAMA,IAAM,+BAAyC;AAAA,EAC7C;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAMA,IAAM,qBAA+B;AAAA,EACnC;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAaA,IAAM,mBAAqC;AAAA;AAAA,EAEzC,EAAE,SAAS,sJAAsJ,OAAO,IAAI,WAAW,SAAS,OAAO,oBAAoB;AAAA,EAC3N,EAAE,SAAS,4EAA4E,OAAO,IAAI,WAAW,SAAS,OAAO,mBAAmB;AAAA,EAChJ,EAAE,SAAS,oFAAoF,OAAO,IAAI,WAAW,SAAS,OAAO,oBAAoB;AAAA,EACzJ,EAAE,SAAS,oFAAoF,OAAO,IAAI,WAAW,SAAS,OAAO,kBAAkB;AAAA,EACvJ,EAAE,SAAS,oGAAoG,OAAO,GAAG,WAAW,SAAS,OAAO,aAAa;AAAA,EACjK,EAAE,SAAS,4EAA4E,OAAO,GAAG,WAAW,SAAS,OAAO,aAAa;AAAA;AAAA,EAGzI,EAAE,SAAS,qHAAqH,OAAO,GAAG,WAAW,cAAc,OAAO,wBAAwB;AAAA,EAClM,EAAE,SAAS,2HAA2H,OAAO,GAAG,WAAW,cAAc,OAAO,sBAAsB;AAAA,EACtM,EAAE,SAAS,uEAAuE,OAAO,GAAG,WAAW,cAAc,OAAO,YAAY;AAAA,EACxI,EAAE,SAAS,kFAAkF,OAAO,GAAG,WAAW,UAAU,OAAO,mBAAmB;AAAA,EACtJ,EAAE,SAAS,iFAAiF,OAAO,GAAG,WAAW,cAAc,OAAO,wBAAwB;AAAA,EAC9J,EAAE,SAAS,8CAA8C,OAAO,GAAG,WAAW,cAAc,OAAO,YAAY;AAAA,EAC/G,EAAE,SAAS,6DAA6D,OAAO,GAAG,WAAW,cAAc,OAAO,iBAAiB;AAAA,EACnI,EAAE,SAAS,gHAAgH,OAAO,GAAG,WAAW,cAAc,OAAO,kBAAkB;AAAA,EACvL,EAAE,SAAS,yEAAyE,OAAO,GAAG,WAAW,cAAc,OAAO,oBAAoB;AAAA,EAClJ,EAAE,SAAS,oIAAoI,OAAO,GAAG,WAAW,cAAc,OAAO,mBAAmB;AAAA,EAC5M,EAAE,SAAS,yDAAyD,OAAO,GAAG,WAAW,cAAc,OAAO,qBAAqB;AAAA,EACnI,EAAE,SAAS,6DAA6D,OAAO,GAAG,WAAW,cAAc,OAAO,oBAAoB;AAAA,EACtI,EAAE,SAAS,iGAAiG,OAAO,GAAG,WAAW,cAAc,OAAO,oBAAoB;AAAA,EAC1K,EAAE,SAAS,2BAA2B,OAAO,GAAG,WAAW,SAAS,OAAO,mBAAmB;AAAA;AAAA,EAG9F,EAAE,SAAS,6DAA6D,OAAO,GAAG,WAAW,cAAc,OAAO,iBAAiB;AAAA,EACnI,EAAE,SAAS,sEAAsE,OAAO,GAAG,WAAW,cAAc,OAAO,oBAAoB;AAAA,EAC/I,EAAE,SAAS,kCAAkC,OAAO,GAAG,WAAW,cAAc,OAAO,0BAA0B;AAAA,EACjH,EAAE,SAAS,8CAA8C,OAAO,GAAG,WAAW,cAAc,OAAO,yBAAyB;AAAA,EAC5H,EAAE,SAAS,kDAAkD,OAAO,GAAG,WAAW,cAAc,OAAO,mBAAmB;AAAA,EAC1H,EAAE,SAAS,oEAAoE,OAAO,IAAI,WAAW,SAAS,OAAO,yBAAyB;AAAA,EAC9I,EAAE,SAAS,yCAAyC,OAAO,GAAG,WAAW,cAAc,OAAO,qBAAqB;AAAA,EACnH,EAAE,SAAS,2CAA2C,OAAO,GAAG,WAAW,cAAc,OAAO,yBAAyB;AAAA,EACzH,EAAE,SAAS,iBAAiB,OAAO,GAAG,WAAW,UAAU,OAAO,kBAAkB;AAAA,EACpF,EAAE,SAAS,cAAc,OAAO,GAAG,WAAW,UAAU,OAAO,iBAAiB;AAAA;AAAA,EAGhF,EAAE,SAAS,4DAA4D,OAAO,IAAI,WAAW,SAAS,OAAO,oBAAoB;AAAA,EACjI,EAAE,SAAS,0BAA0B,OAAO,GAAG,WAAW,cAAc,OAAO,gBAAgB;AAAA,EAC/F,EAAE,SAAS,wBAAwB,OAAO,GAAG,WAAW,SAAS,OAAO,aAAa;AAAA;AAAA,EAGrF,EAAE,SAAS,6BAA6B,OAAO,GAAG,WAAW,UAAU,OAAO,oBAAoB;AAAA,EAClG,EAAE,SAAS,iCAAiC,OAAO,GAAG,WAAW,UAAU,OAAO,sBAAsB;AAAA,EACxG,EAAE,SAAS,kDAAkD,OAAO,GAAG,WAAW,UAAU,OAAO,kBAAkB;AAAA,EACrH,EAAE,SAAS,4BAA4B,OAAO,GAAG,WAAW,UAAU,OAAO,iBAAiB;AAAA,EAC9F,EAAE,SAAS,8BAA8B,OAAO,GAAG,WAAW,UAAU,OAAO,iBAAiB;AAAA,EAChG,EAAE,SAAS,SAAS,OAAO,GAAG,WAAW,cAAc,OAAO,wBAAwB;AAAA,EACtF,EAAE,SAAS,gBAAgB,OAAO,GAAG,WAAW,SAAS,OAAO,gBAAgB;AAClF;AAMA,SAAS,aAAa,SAA+C;AACnE,QAAM,WAAqB,CAAC;AAC5B,MAAI,WAAW;AACf,MAAI,oBAAgE;AAEpE,aAAW,MAAM,kBAAkB;AACjC,QAAI,GAAG,QAAQ,KAAK,OAAO,GAAG;AAC5B,eAAS,KAAK,GAAG,KAAK;AACtB,UAAI,GAAG,QAAQ,UAAU;AACvB,mBAAW,GAAG;AACd,4BAAoB,GAAG;AAAA,MACzB;AAAA,IACF;AAAA,EACF;AAGA,MAAI,SAAS,UAAU,KAAK,WAAW,GAAG;AACxC,eAAW,KAAK,IAAI,IAAI,WAAW,SAAS,SAAS,CAAC;AAAA,EACxD;AAEA,SAAO;AAAA,IACL,OAAO;AAAA,IACP;AAAA,IACA,WAAW,SAAS,SAAS,IAAI,oBAAoB;AAAA,IACrD,UAAU,SAAS,SAAS,KAAK,YAAY;AAAA,EAC/C;AACF;AA1BS;AA4BT,SAAS,eAAe,SAAiD;AACvE,QAAM,kBAAkB,6BAA6B,KAAK,QAAM,GAAG,KAAK,OAAO,CAAC;AAChF,QAAM,SAAS,wBAAwB,KAAK,OAAO;AAEnD,QAAM,QAAkB,CAAC;AACzB,MAAI,WAAW;AACf,MAAI,SAAS;AACb,MAAI,WAAW;AAEf,aAAW,KAAK,mBAAmB;AACjC,QAAI,EAAE,KAAK,OAAO,GAAG;AACnB,iBAAW;AACX,YAAM,YAAY,QAAQ,MAAM,aAAa;AAC7C,UAAI,aAAa,CAAC,MAAM,SAAS,UAAU,CAAC,CAAC,EAAG,OAAM,KAAK,UAAU,CAAC,CAAC;AACvE,YAAM,UAAU,wCAAwC,KAAK,EAAE,MAAM;AACrE,YAAM,IAAI,UAAU,IAAI;AACxB,UAAI,IAAI,UAAU;AAAE,mBAAW;AAAG,iBAAS,EAAE,OAAO,MAAM,GAAG,EAAE;AAAA,MAAG;AAAA,IACpE;AAAA,EACF;AAGA,MAAI,oBAAoB,YAAY,SAAS;AAC3C,WAAO,EAAE,OAAO,GAAG,UAAU,OAAO,eAAe,MAAM,OAAO,QAAQ,mBAAmB,UAAU,kBAAkB,GAAG;AAAA,EAC5H;AAEA,SAAO,EAAE,OAAO,WAAW,WAAW,GAAG,UAAU,eAAe,OAAO,OAAO,OAAO;AACzF;AA1BS;AA4BT,SAAS,aAAa,SAA0B;AAC9C,SAAO,mBAAmB,KAAK,OAAK,EAAE,KAAK,OAAO,CAAC;AACrD;AAFS;AAIT,SAAS,kBAAkB,SAAyB;AAClD,MAAI,QAAQ;AACZ,QAAM,gBAAgB,QAAQ,MAAM,0CAA0C;AAC9E,MAAI,eAAe;AACjB,UAAM,IAAI,SAAS,cAAc,CAAC,GAAG,EAAE;AACvC,UAAM,OAAO,cAAc,CAAC,EAAE,YAAY;AAC1C,YAAQ,KAAK,WAAW,SAAS,KAAK,KAAK,WAAW,MAAM,IACxD,KAAK,IAAI,IAAI,IAAI,CAAC,IAAI,KAAK,IAAI,IAAI,KAAK,KAAK,IAAI,CAAC,CAAC;AAAA,EACzD;AACA,MAAI,qBAAqB,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AACjE,MAAI,iBAAiB,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AAC7D,MAAI,2CAA2C,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AACvF,MAAI,oHAAoH,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AAChK,MAAI,oFAAoF,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AAChI,MAAI,mEAAmE,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AAE/G,MAAI,gJAAgJ,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AAC5L,MAAI,6HAA6H,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AACzK,MAAI,gHAAgH,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AAC5J,MAAI,oEAAoE,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AAChH,SAAO,KAAK,IAAI,IAAI,KAAK;AAC3B;AArBS;AAuBT,SAAS,eAAe,SAAyB;AAC/C,MAAI,QAAQ;AACZ,MAAI,2JAA2J,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AACvM,MAAI,iHAAiH,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AAC7J,MAAI,yEAAyE,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AACrH,MAAI,iCAAiC,KAAK,OAAO,EAAG,SAAQ,KAAK,IAAI,OAAO,CAAC;AAC7E,SAAO,KAAK,IAAI,IAAI,KAAK;AAC3B;AAPS;AAoBT,IAAM,iBAAiC;AAAA;AAAA,EAErC,EAAE,QAAQ,aAAa,SAAS,iDAAiD,YAAY,MAAM,QAAQ,iBAAiB;AAAA,EAC5H,EAAE,QAAQ,aAAa,SAAS,kCAAkC,YAAY,MAAM,QAAQ,wBAAwB;AAAA,EACpH,EAAE,QAAQ,aAAa,SAAS,kCAAkC,YAAY,MAAM,QAAQ,gBAAgB;AAAA,EAC5G,EAAE,QAAQ,aAAa,SAAS,sBAAsB,YAAY,MAAM,QAAQ,cAAc;AAAA,EAC9F,EAAE,QAAQ,aAAa,SAAS,cAAc,YAAY,KAAK,QAAQ,gBAAgB;AAAA,EACvF,EAAE,QAAQ,aAAa,SAAS,sCAAsC,YAAY,MAAM,QAAQ,kBAAkB;AAAA,EAClH,EAAE,QAAQ,aAAa,SAAS,2EAA2E,YAAY,KAAK,QAAQ,kBAAkB;AAAA,EACtJ,EAAE,QAAQ,aAAa,SAAS,8BAA8B,YAAY,KAAK,QAAQ,aAAa;AAAA,EACpG,EAAE,QAAQ,aAAa,SAAS,2BAA2B,YAAY,MAAM,QAAQ,aAAa;AAAA,EAClG,EAAE,QAAQ,aAAa,SAAS,gCAAgC,YAAY,MAAM,QAAQ,oBAAoB;AAAA,EAC9G,EAAE,QAAQ,aAAa,SAAS,2FAA2F,YAAY,KAAK,QAAQ,mBAAmB;AAAA,EACvK,EAAE,QAAQ,aAAa,SAAS,2EAA2E,YAAY,MAAM,QAAQ,mBAAmB;AAAA;AAAA,EAGxJ,EAAE,QAAQ,UAAU,SAAS,gGAAgG,YAAY,MAAM,QAAQ,cAAc;AAAA,EACrK,EAAE,QAAQ,UAAU,SAAS,qEAAqE,YAAY,MAAM,QAAQ,eAAe;AAAA,EAC3I,EAAE,QAAQ,UAAU,SAAS,kDAAkD,YAAY,KAAK,QAAQ,iBAAiB;AAAA,EACzH,EAAE,QAAQ,UAAU,SAAS,gEAAgE,YAAY,KAAK,QAAQ,qBAAqB;AAAA,EAC3I,EAAE,QAAQ,UAAU,SAAS,wDAAwD,YAAY,KAAK,QAAQ,eAAe;AAAA,EAC7H,EAAE,QAAQ,UAAU,SAAS,qCAAqC,YAAY,KAAK,QAAQ,eAAe;AAAA,EAC1G,EAAE,QAAQ,UAAU,SAAS,sBAAsB,YAAY,KAAK,QAAQ,OAAO;AAAA,EACnF,EAAE,QAAQ,UAAU,SAAS,iBAAiB,YAAY,KAAK,QAAQ,WAAW;AAAA,EAClF,EAAE,QAAQ,UAAU,SAAS,qBAAqB,YAAY,MAAM,QAAQ,aAAa;AAAA;AAAA,EAGzF,EAAE,QAAQ,YAAY,SAAS,sGAAsG,YAAY,KAAK,QAAQ,qBAAqB;AAAA,EACnL,EAAE,QAAQ,YAAY,SAAS,+EAA+E,YAAY,KAAK,QAAQ,iBAAiB;AAAA,EACxJ,EAAE,QAAQ,YAAY,SAAS,sEAAsE,YAAY,KAAK,QAAQ,kBAAkB;AAAA,EAChJ,EAAE,QAAQ,YAAY,SAAS,YAAY,YAAY,MAAM,QAAQ,gBAAgB;AAAA,EACrF,EAAE,QAAQ,YAAY,SAAS,wBAAwB,YAAY,MAAM,QAAQ,eAAe;AAAA;AAAA,EAGhG,EAAE,QAAQ,YAAY,SAAS,sDAAsD,YAAY,KAAK,QAAQ,WAAW;AAAA,EACzH,EAAE,QAAQ,YAAY,SAAS,oEAAoE,YAAY,KAAK,QAAQ,0BAA0B;AAAA,EACtJ,EAAE,QAAQ,YAAY,SAAS,uCAAuC,YAAY,KAAK,QAAQ,UAAU;AAAA,EACzG,EAAE,QAAQ,YAAY,SAAS,yCAAyC,YAAY,MAAM,QAAQ,cAAc;AAAA,EAChH,EAAE,QAAQ,YAAY,SAAS,mDAAmD,YAAY,MAAM,QAAQ,kBAAkB;AAAA,EAC9H,EAAE,QAAQ,YAAY,SAAS,oCAAoC,YAAY,KAAK,QAAQ,SAAS;AAAA,EACrG,EAAE,QAAQ,YAAY,SAAS,8CAA8C,YAAY,KAAK,QAAQ,iBAAiB;AAAA;AAAA,EAGvH,EAAE,QAAQ,YAAY,SAAS,8EAA8E,YAAY,KAAK,QAAQ,gBAAgB;AAAA,EACtJ,EAAE,QAAQ,YAAY,SAAS,4EAA4E,YAAY,KAAK,QAAQ,mBAAmB;AAAA,EACvJ,EAAE,QAAQ,YAAY,SAAS,4DAA4D,YAAY,MAAM,QAAQ,iBAAiB;AAAA,EACtI,EAAE,QAAQ,YAAY,SAAS,kEAAkE,YAAY,KAAK,QAAQ,kBAAkB;AAAA,EAC5I,EAAE,QAAQ,YAAY,SAAS,YAAY,YAAY,KAAK,QAAQ,cAAc;AAAA;AAAA,EAGlF,EAAE,QAAQ,WAAW,SAAS,wCAAwC,YAAY,KAAK,QAAQ,kBAAkB;AAAA,EACjH,EAAE,QAAQ,WAAW,SAAS,+CAA+C,YAAY,KAAK,QAAQ,oBAAoB;AAAA,EAC1H,EAAE,QAAQ,WAAW,SAAS,2CAA2C,YAAY,MAAM,QAAQ,cAAc;AAAA,EACjH,EAAE,QAAQ,WAAW,SAAS,4EAA4E,YAAY,KAAK,QAAQ,kBAAkB;AAAA;AAAA,EAGrJ,EAAE,QAAQ,YAAY,SAAS,2BAA2B,YAAY,MAAM,QAAQ,SAAS;AAAA,EAC7F,EAAE,QAAQ,YAAY,SAAS,qEAAqE,YAAY,KAAK,QAAQ,UAAU;AAAA,EACvI,EAAE,QAAQ,YAAY,SAAS,+EAA+E,YAAY,KAAK,QAAQ,gBAAgB;AAAA,EACvJ,EAAE,QAAQ,YAAY,SAAS,2BAA2B,YAAY,KAAK,QAAQ,iBAAiB;AAAA,EACpG,EAAE,QAAQ,YAAY,SAAS,8BAA8B,YAAY,MAAM,QAAQ,gBAAgB;AAAA;AAAA,EAGvG,EAAE,QAAQ,WAAW,SAAS,6DAA6D,YAAY,MAAM,QAAQ,cAAc;AAAA,EACnI,EAAE,QAAQ,WAAW,SAAS,0EAA0E,YAAY,KAAK,QAAQ,eAAe;AAAA,EAChJ,EAAE,QAAQ,WAAW,SAAS,4DAA4D,YAAY,KAAK,QAAQ,aAAa;AAAA,EAChI,EAAE,QAAQ,WAAW,SAAS,8CAA8C,YAAY,KAAK,QAAQ,WAAW;AAAA,EAChH,EAAE,QAAQ,WAAW,SAAS,2DAA2D,YAAY,KAAK,QAAQ,iBAAiB;AAAA,EACnI,EAAE,QAAQ,WAAW,SAAS,oEAAoE,YAAY,KAAK,QAAQ,eAAe;AAAA,EAC1I,EAAE,QAAQ,WAAW,SAAS,kCAAkC,YAAY,MAAM,QAAQ,cAAc;AAAA;AAAA,EAGxG,EAAE,QAAQ,aAAa,SAAS,uGAAuG,YAAY,KAAK,QAAQ,sBAAsB;AAAA,EACtL,EAAE,QAAQ,aAAa,SAAS,uFAAuF,YAAY,MAAM,QAAQ,kBAAkB;AAAA,EACnK,EAAE,QAAQ,aAAa,SAAS,0DAA0D,YAAY,KAAK,QAAQ,eAAe;AAAA;AAAA,EAGlI,EAAE,QAAQ,OAAO,SAAS,8DAA8D,YAAY,MAAM,QAAQ,eAAe;AAAA,EACjI,EAAE,QAAQ,OAAO,SAAS,gEAAgE,YAAY,MAAM,QAAQ,gBAAgB;AAAA,EACpI,EAAE,QAAQ,OAAO,SAAS,kEAAkE,YAAY,MAAM,QAAQ,sBAAsB;AAAA,EAC5I,EAAE,QAAQ,OAAO,SAAS,sBAAsB,YAAY,KAAK,QAAQ,cAAc;AAAA;AAAA,EAGvF,EAAE,QAAQ,QAAQ,SAAS,wDAAwD,YAAY,KAAK,QAAQ,QAAQ;AAAA,EACpH,EAAE,QAAQ,QAAQ,SAAS,oCAAoC,YAAY,MAAM,QAAQ,WAAW;AAAA,EACpG,EAAE,QAAQ,QAAQ,SAAS,mDAAmD,YAAY,MAAM,QAAQ,oBAAoB;AAAA,EAC5H,EAAE,QAAQ,QAAQ,SAAS,gEAAgE,YAAY,KAAK,QAAQ,iBAAiB;AAAA,EACrI,EAAE,QAAQ,QAAQ,SAAS,0EAA0E,YAAY,MAAM,QAAQ,iBAAiB;AAAA,EAChJ,EAAE,QAAQ,QAAQ,SAAS,oDAAoD,YAAY,KAAK,QAAQ,gBAAgB;AAAA;AAAA,EAGxH,EAAE,QAAQ,aAAa,SAAS,qCAAqC,YAAY,KAAK,QAAQ,YAAY;AAAA,EAC1G,EAAE,QAAQ,aAAa,SAAS,gEAAgE,YAAY,MAAM,QAAQ,eAAe;AAAA,EACzI,EAAE,QAAQ,aAAa,SAAS,0DAA0D,YAAY,MAAM,QAAQ,iBAAiB;AAAA,EACrI,EAAE,QAAQ,aAAa,SAAS,gEAAgE,YAAY,KAAK,QAAQ,mBAAmB;AAAA;AAAA,EAG5I,EAAE,QAAQ,iBAAiB,SAAS,yBAAyB,YAAY,KAAK,QAAQ,eAAe;AAAA,EACrG,EAAE,QAAQ,iBAAiB,SAAS,oEAAoE,YAAY,KAAK,QAAQ,qBAAqB;AAAA,EACtJ,EAAE,QAAQ,iBAAiB,SAAS,yBAAyB,YAAY,KAAK,QAAQ,QAAQ;AAAA,EAC9F,EAAE,QAAQ,iBAAiB,SAAS,YAAY,YAAY,KAAK,QAAQ,MAAM;AAAA,EAC/E,EAAE,QAAQ,iBAAiB,SAAS,uDAAuD,YAAY,KAAK,QAAQ,4BAA4B;AAAA;AAAA,EAGhJ,EAAE,QAAQ,QAAQ,SAAS,iCAAiC,YAAY,MAAM,QAAQ,cAAc;AAAA,EACpG,EAAE,QAAQ,QAAQ,SAAS,uCAAuC,YAAY,KAAK,QAAQ,cAAc;AAAA,EACzG,EAAE,QAAQ,QAAQ,SAAS,kDAAkD,YAAY,MAAM,QAAQ,aAAa;AAAA,EACpH,EAAE,QAAQ,QAAQ,SAAS,yEAAyE,YAAY,KAAK,QAAQ,0BAA0B;AAAA,EACvJ,EAAE,QAAQ,QAAQ,SAAS,mCAAmC,YAAY,MAAM,QAAQ,sBAAsB;AAAA;AAAA,EAG9G,EAAE,QAAQ,WAAW,SAAS,6FAA6F,YAAY,KAAK,QAAQ,wBAAwB;AAAA,EAC5K,EAAE,QAAQ,WAAW,SAAS,0CAA0C,YAAY,KAAK,QAAQ,oBAAoB;AAAA,EACrH,EAAE,QAAQ,WAAW,SAAS,mBAAmB,YAAY,KAAK,QAAQ,gBAAgB;AAAA,EAC1F,EAAE,QAAQ,WAAW,SAAS,8CAA8C,YAAY,KAAK,QAAQ,0BAA0B;AAAA,EAC/H,EAAE,QAAQ,WAAW,SAAS,oEAAoE,YAAY,KAAK,QAAQ,mBAAmB;AAAA,EAC9I,EAAE,QAAQ,WAAW,SAAS,2BAA2B,YAAY,MAAM,QAAQ,kBAAkB;AAAA,EACrG,EAAE,QAAQ,WAAW,SAAS,oBAAoB,YAAY,KAAK,QAAQ,cAAc;AAC3F;AAEA,SAAS,sBAAsB,SAAqD;AAClF,QAAM,QAA4C,CAAC;AACnD,aAAW,QAAQ,gBAAgB;AACjC,QAAI,KAAK,QAAQ,KAAK,OAAO,GAAG;AAC9B,YAAM,KAAK,EAAE,QAAQ,KAAK,QAAQ,YAAY,KAAK,YAAY,QAAQ,KAAK,OAAO,CAAC;AAAA,IACtF;AAAA,EACF;AACA,QAAM,WAAW,oBAAI,IAAoE;AACzF,aAAW,QAAQ,OAAO;AACxB,UAAM,WAAW,SAAS,IAAI,KAAK,MAAM;AACzC,QAAI,CAAC,YAAY,KAAK,aAAa,SAAS,WAAY,UAAS,IAAI,KAAK,QAAQ,IAAI;AAAA,EACxF;AACA,SAAO,MAAM,KAAK,SAAS,OAAO,CAAC,EAAE,KAAK,CAAC,GAAG,MAAM,EAAE,aAAa,EAAE,UAAU;AACjF;AAbS;AAmBF,SAAS,cAAc,SAAoC;AAEhE,QAAM,UAAU,aAAa,OAAO;AACpC,QAAM,YAAY,eAAe,OAAO;AACxC,QAAM,aAAa,aAAa,OAAO;AACvC,QAAM,mBAAmB,kBAAkB,OAAO;AAClD,QAAM,gBAAgB,eAAe,OAAO;AAC5C,QAAM,gBAAgB,sBAAsB,OAAO;AAGnD,MAAI,MAAc;AAClB,QAAM,QAAoC,CAAC;AAG3C,MAAI,UAAU,eAAe;AAC3B,UAAM;AAAA,EACR,WAES,UAAU,YAAY,QAAQ,UAAU;AAC/C,UAAM;AACN,UAAM,WAAW;AACjB,UAAM,UAAU;AAChB,UAAM,WAAW;AACjB,UAAM,WAAW;AACjB,UAAM,cAAc;AACpB,UAAM,YAAY,QAAQ;AAAA,EAC5B,WAES,UAAU,UAAU;AAC3B,UAAM;AACN,UAAM,WAAW;AACjB,UAAM,UAAU;AAChB,UAAM,WAAW;AACjB,UAAM,WAAW;AACjB,UAAM,cAAc;AAAA,EACtB,WAES,QAAQ,UAAU;AACzB,UAAM;AACN,UAAM,YAAY,QAAQ;AAAA,EAE5B,WAES,YAAY;AACnB,UAAM;AACN,UAAM,WAAW;AACjB,UAAM,UAAU;AAChB,UAAM,WAAW;AACjB,UAAM,WAAW;AACjB,UAAM,cAAc;AAAA,EACtB;AAGA,QAAM,gBAAgB,MAAM,aAAa;AACzC,QAAM,kBAAkB,gBAAgB,IAAK,QAAQ,WAAW,KAAK,IAAI,QAAQ,OAAO,CAAC,IAAI;AAC7F,QAAM,oBAAoB,iBAAiB,UAAU,YAAY;AAEjE,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF;AArEgB;AA2ET,SAAS,wBAAwB,KAAgC;AACtE,QAAM,QAAkB,CAAC;AAEzB,MAAI,IAAI,QAAQ,cAAc,IAAI,QAAQ,oBAAoB;AAC5D,UAAM,KAAK,wDAAmD;AAC9D,UAAM,KAAK,uHAAuH;AAClI,UAAM,KAAK,6EAA6E;AAAA,EAC1F;AAEA,MAAI,IAAI,QAAQ,uBAAuB;AACrC,UAAM,KAAK,4GAA4G;AAAA,EACzH;AAEA,MAAI,IAAI,QAAQ,aAAa;AAC3B,UAAM,KAAK,uDAAkD;AAC7D,UAAM,KAAK,0EAA0E;AAAA,EACvF;AAEA,MAAI,IAAI,QAAQ,UAAU;AACxB,UAAM,KAAK,kCAAkC,IAAI,QAAQ,YAAY,iBAAiB,IAAI,QAAQ,SAAS,KAAK,IAAI,IAAI,GAAG;AAC3H,QAAI,IAAI,QAAQ,WAAW;AACzB,YAAM,KAAK,uFAAuF;AAClG,YAAM,KAAK,wFAAwF;AAAA,IACrG;AAAA,EACF;AAEA,MAAI,IAAI,oBAAoB,GAAG;AAC7B,UAAM,KAAK,kCAAkC,IAAI,mBAAmB,kDAA6C;AAAA,EACnH;AAEA,MAAI,IAAI,cAAc,SAAS,KAAK,CAAC,IAAI,MAAM,UAAU;AACvD,UAAM,MAAM,IAAI,cAAc,CAAC;AAC/B,UAAM,KAAK,yBAAyB,IAAI,SAAS,QAAQ,IAAI,aAAa,KAAK,QAAQ,CAAC,IAAI,eAAU,IAAI,MAAM;AAAA,EAClH;AAEA,MAAI,IAAI,iBAAiB,IAAI,QAAQ,uBAAuB;AAC1D,UAAM,KAAK,EAAE;AACb,UAAM,KAAK,8DAA8D;AACzE,UAAM,KAAK,qEAAqE;AAAA,EAClF;AAEA,SAAO,MAAM,SAAS,IAAI,8DAA8D,MAAM,KAAK,IAAI,IAAI;AAC7G;AA1CgB;AAqET,SAAS,gBACd,KACA,WAQkB;AAClB,QAAM,IAAsB,EAAE,iBAAiB,CAAC,EAAE;AAGlD,MAAI,IAAI,QAAQ,cAAc,IAAI,QAAQ,sBAAsB,IAAI,QAAQ,aAAa;AACvF,QAAI,UAAU,aAAa,aAAa;AACtC,QAAE,WAAW;AACb,QAAE,gBAAgB,KAAK,sBAAsB,IAAI,MAAM,2BAA2B,UAAU,WAAW,GAAG;AAAA,IAC5G;AACA,QAAI,UAAU,YAAY,eAAe;AACvC,QAAE,UAAU;AACZ,QAAE,gBAAgB,KAAK,qBAAqB,IAAI,MAAM,oBAAoB;AAAA,IAC5E;AACA,QAAI,CAAC,UAAU,UAAU;AACvB,QAAE,WAAW;AACb,QAAE,gBAAgB,KAAK,sBAAsB,IAAI,MAAM,sBAAsB;AAAA,IAC/E;AACA,QAAI,UAAU,aAAa,cAAc,UAAU,aAAa,QAAQ;AACtE,QAAE,WAAW,IAAI,QAAQ,cAAc,SAAS;AAChD,QAAE,gBAAgB,KAAK,kBAAkB,EAAE,QAAQ;AAAA,IACrD;AACA,QAAI,IAAI,QAAQ,eAAe,UAAU,gBAAgB,YAAY;AACnE,QAAE,cAAc;AAChB,QAAE,gBAAgB,KAAK,0BAA0B;AAAA,IACnD;AAAA,EACF;AAGA,MAAI,IAAI,QAAQ,WAAW;AAGzB,QAAI,IAAI,QAAQ,SAAS,KAAK,UAAU,cAAc,QAAQ;AAC5D,QAAE,YAAY,IAAI,QAAQ;AAC1B,QAAE,gBAAgB,KAAK,qCAAqC,IAAI,QAAQ,QAAQ,oBAAoB;AAAA,IACtG;AAAA,EACF;AAGA,MAAI,IAAI,QAAQ,yBAAyB,UAAU,YAAY,IAAI,QAAQ,QAAQ,GAAG;AACpF,MAAE,WAAW;AACb,MAAE,gBAAgB,KAAK,wEAAwE;AAAA,EACjG;AAGA,MAAI,IAAI,QAAQ,SAAS,MAAM,UAAU,aAAa,SAAS,UAAU,aAAa,aAAa,CAAC,EAAE,UAAU;AAC9G,MAAE,WAAW;AACb,MAAE,gBAAgB,KAAK,0BAA0B,IAAI,QAAQ,QAAQ,OAAO;AAAA,EAC9E;AAGA,MAAI,IAAI,UAAU,YAAY,CAAC,IAAI,UAAU,iBAAiB,CAAC,EAAE,UAAU;AACzE,QAAI,UAAU,aAAa,YAAY;AACrC,QAAE,WAAW;AACb,QAAE,gBAAgB,KAAK,iCAAiC;AAAA,IAC1D;AAAA,EACF;AAGA,MAAI,IAAI,QAAQ,SAAS,KAAK,UAAU,cAAc,QAAQ;AAC5D,MAAE,YAAY,IAAI,QAAQ;AAC1B,MAAE,gBAAgB,KAAK,2BAA2B,IAAI,QAAQ,QAAQ,MAAM,IAAI,QAAQ,SAAS;AAAA,EACnG;AAGA,MAAI,CAAC,EAAE,YAAY,IAAI,cAAc,SAAS,GAAG;AAC/C,UAAM,UAAU,IAAI,cAAc,CAAC;AACnC,QAAI,QAAQ,cAAc,OAAO,QAAQ,WAAW,UAAU,UAAU;AACtE,YAAM,eAAe,UAAU,aAAa,aAAa,UAAU,aAAa;AAChF,UAAI,cAAc;AAChB,UAAE,WAAW,QAAQ;AACrB,UAAE,gBAAgB,KAAK,uBAAuB,QAAQ,SAAS,OAAO,QAAQ,aAAa,KAAK,QAAQ,CAAC,IAAI,eAAe,UAAU,QAAQ;AAAA,MAChJ;AAAA,IACF;AAAA,EACF;AAEA,SAAO;AACT;AAtFgB;;;ACzjBhB,SAAS,kBAAkB,OAAyB,SAA0C;AAC5F,QAAM,eAAuC,CAAC;AAC9C,aAAW,QAAQ,MAAM,OAAO;AAC9B,UAAM,MAAM,gBAAgB,KAAK,MAAM;AACvC,QAAI,OAAO,QAAQ,UAAW,cAAa,GAAG,KAAK,aAAa,GAAG,KAAK,KAAK,KAAK,QAAQ;AAAA,EAC5F;AACA,aAAW,QAAQ,QAAQ,OAAO;AAChC,UAAM,MAAM,gBAAgB,KAAK,MAAM;AACvC,QAAI,OAAO,QAAQ,UAAW,cAAa,GAAG,KAAK,aAAa,GAAG,KAAK,KAAK,KAAK;AAAA,EACpF;AACA,QAAM,UAAU,OAAO,QAAQ,YAAY;AAC3C,MAAI,QAAQ,WAAW,EAAG,QAAO;AACjC,UAAQ,KAAK,CAAC,GAAG,MAAM,EAAE,CAAC,IAAI,EAAE,CAAC,CAAC;AAClC,SAAO,eAAe,QAAQ,CAAC,EAAE,CAAC,CAAC;AACrC;AAdS;AAgBT,SAAS,SAAS,KAAc,MAAW,SAAS,KAAK;AACvD,SAAO,KAAK,KAAK,yBAAyB,IAAI,GAAG,MAAM;AACzD;AAFS;AAMT,SAAS,kBAAkB,SAA+B;AACxD,WAAS,IAAI,QAAQ,SAAS,GAAG,KAAK,GAAG,KAAK;AAC5C,QAAI,QAAQ,CAAC,EAAE,SAAS,YAAa,QAAO,OAAO,QAAQ,CAAC,EAAE,WAAW,EAAE;AAAA,EAC7E;AACA,SAAO;AACT;AALS;AAOT,SAAS,SAAS,GAAmB;AACnC,SAAO,EAAE,YAAY,EAAE,QAAQ,QAAQ,GAAG,EAAE,QAAQ,qBAAqB,EAAE,EAAE,KAAK;AACpF;AAFS;AAKT,SAAS,SAAS,GAAW,GAAmB;AAC9C,QAAM,IAAI,IAAI,IAAI,SAAS,CAAC,EAAE,MAAM,GAAG,EAAE,OAAO,OAAO,CAAC;AACxD,QAAM,IAAI,IAAI,IAAI,SAAS,CAAC,EAAE,MAAM,GAAG,EAAE,OAAO,OAAO,CAAC;AACxD,MAAI,EAAE,SAAS,KAAK,EAAE,SAAS,EAAG,QAAO;AACzC,MAAI,QAAQ;AACZ,aAAW,KAAK,EAAG,KAAI,EAAE,IAAI,CAAC,EAAG;AACjC,SAAO,QAAQ,KAAK,IAAI,EAAE,MAAM,EAAE,IAAI;AACxC;AAPS;AAUT,SAAS,yBAAyB,SAAuB,eAA+B;AACtF,MAAI,QAAQ,WAAW,EAAG,QAAO;AACjC,QAAM,gBAAgB,QAAQ,OAAO,OAAK,EAAE,SAAS,WAAW,EAAE,IAAI,OAAK,OAAO,EAAE,WAAW,EAAE,CAAC;AAClG,QAAM,WAAW,QAAQ,OAAO,OAAK,EAAE,SAAS,MAAM,EAAE,IAAI,OAAK,OAAO,EAAE,WAAW,EAAE,CAAC;AACxF,MAAI,cAAc,WAAW,EAAG,QAAO;AAEvC,QAAM,QAAkB,CAAC;AACzB,QAAM,KAAK,yBAAsB,cAAc,MAAM,qCAAyB;AAC9E,QAAM,KAAK,WAAW,aAAa,GAAG;AAGtC,QAAM,aAAuB,CAAC;AAC9B,aAAW,OAAO,UAAU;AAC1B,UAAM,IAAI,IAAI,YAAY;AAC1B,QAAI,2EAA2E,KAAK,CAAC,EAAG,YAAW,KAAK,cAAc;AACtH,QAAI,qFAAqF,KAAK,CAAC,EAAG,YAAW,KAAK,kBAAkB;AACpI,QAAI,uCAAuC,KAAK,CAAC,KAAK,SAAS,QAAQ,GAAG,IAAI,SAAS,SAAS,EAAG,YAAW,KAAK,cAAc;AAAA,EACnI;AACA,MAAI,WAAW,SAAS,EAAG,OAAM,KAAK,wBAAwB,CAAC,GAAG,IAAI,IAAI,UAAU,CAAC,EAAE,KAAK,IAAI,CAAC,GAAG;AAGpG,QAAM,aAAa,cAAc,cAAc,SAAS,CAAC;AACzD,MAAI,WAAW,SAAS,IAAI;AAC1B,UAAM,KAAK,2CAA+B,WAAW,MAAM,GAAG,GAAG,CAAC,SAAI;AAAA,EACxE;AAEA,QAAM,KAAK,qGAAsF;AACjG,SAAO,mCAA6B,MAAM,KAAK,IAAI;AACrD;AA5BS;AA8BT,IAAM,kBAAkB;AAIxB,eAAe,kBACb,KACA,gBACA,SACA,kBACA,cACA,YAAY,KACZ,MACc;AACd,QAAM,WAAW,iBAAiB,gBAAgB,SAAS,kBAAkB,cAAc,IAAI;AAE/F,MAAI;AACF,UAAM,SAAU,MAAM,IAAI,GAAG,IAAI,YAAmB;AAAA,MAClD;AAAA,MACA,YAAY;AAAA,MACZ,aAAa;AAAA,IACf,CAAC;AAED,QAAI,WAAW,QAAQ,YAAY,IAAI,KAAK;AAC5C,QAAI,CAAC,QAAS,QAAO,CAAC;AAGtB,QAAI,CAAC,QAAQ,WAAW,GAAG,EAAG,WAAU,MAAM;AAG9C,UAAM,YAAY,QAAQ,MAAM,aAAa;AAC7C,QAAI,WAAW;AACb,UAAI;AACF,eAAO,KAAK,MAAM,UAAU,CAAC,CAAC;AAAA,MAChC,QAAQ;AAEN,YAAI;AACF,cAAI,YAAY,UAAU,CAAC;AAC3B,sBAAY,UAAU,QAAQ,gCAAgC,EAAE;AAChE,cAAI,CAAC,UAAU,SAAS,GAAG,EAAG,cAAa;AAC3C,iBAAO,KAAK,MAAM,SAAS;AAAA,QAC7B,QAAQ;AAAA,QAAqB;AAAA,MAC/B;AAAA,IACF;AAGA,UAAM,mBAAmB,QAAQ,MAAM,oCAAoC;AAC3E,QAAI,kBAAkB;AACpB,YAAM,kBAAkB,iBAAiB,CAAC,EAAE,QAAQ,QAAQ,GAAG,EAAE,QAAQ,QAAQ,IAAI;AACrF,YAAM,eAAe,QAAQ,MAAM,2BAA2B;AAC9D,YAAM,YAAY,QAAQ,MAAM,6BAA6B;AAC7D,YAAM,WAAW,QAAQ,MAAM,4BAA4B;AAC3D,YAAM,WAAW,QAAQ,MAAM,+BAA+B;AAC9D,aAAO;AAAA,QACL,SAAS,eAAe,CAAC,KAAK;AAAA,QAC9B,YAAY,YAAY,WAAW,UAAU,CAAC,CAAC,IAAI;AAAA,QACnD,UAAU,WAAW,CAAC,KAAK;AAAA,QAC3B,QAAQ;AAAA,QACR,eAAe;AAAA,QACf,UAAU,WAAW,CAAC,MAAM,UAAU;AAAA,QACtC,UAAU,CAAC;AAAA,QACX,SAAS,CAAC;AAAA,MACZ;AAAA,IACF;AAGA,YAAQ,IAAI,+CAA+C,QAAQ,MAAM,GAAG,GAAG,CAAC;AAChF,UAAM,cAAc,QACjB,QAAQ,YAAY,EAAE,EACtB,QAAQ,YAAY,EAAE,EACtB,KAAK;AACR,QAAI,YAAY,SAAS,IAAI;AAC3B,aAAO;AAAA,QACL,SAAS;AAAA,QACT,YAAY;AAAA,QACZ,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,eAAe;AAAA,QACf,UAAU;AAAA,QACV,UAAU,CAAC;AAAA,QACX,SAAS,CAAC;AAAA,MACZ;AAAA,IACF;AAEA,YAAQ,MAAM,0BAA0B,QAAQ,MAAM,GAAG,GAAG,CAAC;AAC7D,WAAO,CAAC;AAAA,EACV,SAAS,GAAG;AACV,YAAQ,MAAM,aAAa,CAAC;AAC5B,WAAO,CAAC;AAAA,EACV;AACF;AArFe;AA6Ff,SAAS,oBAAoB,MAarB;AACN,QAAM,EAAE,MAAM,SAAS,iBAAiB,iBAAiB,cAAc,OAAO,SAAS,OAAO,IAAI,YAAY,SAAS,SAAS,IAAI;AAGpI,QAAM,cAAc,eAAe,MAAM,YAAY,mBAAmB,SAAS;AACjF,QAAM,aAAa,MAAM,MAAM,WAAW,SAAS;AACnD,QAAM,aACH,CAAC,aAAa,eAAe,SAAS,EAAE,SAAS,UAAU,IACvD,aACD;AACN,QAAM,mBAAmB,QAAQ,OAAO,MAAM,eAAe,WAAW,KAAK,aAAa,GAAG;AAC7F,QAAM,cAAc,MAAM,aAAa;AACvC,QAAM,YAAY,OAAO,MAAM,WAAW,WAAW,KAAK,SAAS;AACnE,QAAM,kBACJ,OAAO,MAAM,kBAAkB,YAAY,KAAK,cAAc,KAAK,IAC/D,KAAK,cAAc,KAAK,IACxB;AAGN,QAAM,qBAAqB,CAAC,OAAO,YAAY,UAAU,UAAU;AACnE,QAAM,gBAAgB,mBAAmB,SAAS,MAAM,WAAW,IAAI,KAAK,cAAc;AAC1F,QAAM,mBAAmB,CAAC,QAAQ,cAAc,UAAU,WAAW;AACrE,QAAM,eAAe,iBAAiB,SAAS,MAAM,SAAS,IAAI,KAAK,YAAY;AACnF,QAAM,mBAAmB,CAAC,OAAO,UAAU,QAAQ,UAAU;AAC7D,QAAM,cAAc,iBAAiB,SAAS,MAAM,QAAQ,IAAI,KAAK,WAAW;AAChF,QAAM,cAAc,CAAC,MAAM,MAAM,UAAU,IAAI,EAAE,SAAS,MAAM,iBAAiB,IAC7E,KAAK,oBACL,eAAe,OAAO;AAG1B,QAAM,gBAAgB,kBAAkB;AAAA,IACtC,eAAe;AAAA,IACf,mBAAmB,KAAK,IAAI,MAAM,UAAU,QAAQ,QAAQ;AAAA,IAC5D;AAAA,IACA,cAAc,UAAU;AAAA,EAC1B,CAAC;AAID,QAAM,UAAU,oBAAoB,OAAO;AAC3C,MAAI,eAAwD,EAAE,iBAAiB,CAAC,EAAE;AAClF,MAAI,YAAY;AACd,mBAAe,gBAAgB,YAAY;AAAA,MACzC,UAAU;AAAA,MACV,SAAS;AAAA,MACT,UAAU;AAAA,MACV,UAAU;AAAA,MACV,WAAW;AAAA,MACX,aAAa;AAAA,IACf,CAAC;AAAA,EACH;AAEA,QAAM,wBAAwB,aAAa,aAAa;AACxD,QAAM,gBAAgB,wBAClB,SACC,aAAa,YAAY,UAAU,eAAe,QAAQ,cAAc,YAAY,iBAAiB;AAC1G,MAAI,eAAwD,aAAa,YAAY,gBAAgB,gBAAgB;AAGrH,MAAI;AACJ,MAAI,cAAc;AAClB,MAAI,eAA8B;AAElC,MAAI,iBAAiB,WAAW;AAC9B,WAAO;AACP,mBAAe,mBAAmB;AAClC,QAAI,CAAC,eAAe,YAAY,SAAS,IAAI;AAC3C,oBAAc;AAAA,IAChB;AAAA,EACF,WAAW,eAAe;AACxB,WAAO;AACP,mBAAe;AACf,QAAI,CAAC,eAAe,YAAY,SAAS,IAAI;AAC3C,oBAAc;AAAA,IAChB;AAAA,EACF,OAAO;AACL,WAAO;AACP,mBAAe;AACf,QAAI,CAAC,eAAe,YAAY,SAAS,IAAI;AAC3C,oBAAc;AACd,aAAO;AACP,qBAAe;AACf,qBAAe;AAAA,IACjB;AAAA,EACF;AAGA,MAAI,SAAS,WAAW,CAAC,eAAe;AACtC,UAAM,UAAU,QAAQ,SAAS,MAC/B,kKAAkK,KAAK,OAAO;AAChL,UAAM,YAAY;AAAA,MAChB,UAAU,UAAU,UAAU,YAAY,UAAU,iBAAiB,UAAU,kBAAkB,UAAU;AAAA,IAC7G;AAEA,UAAM,sBAAsB,QAAQ,OAAO,OAAK,EAAE,SAAS,WAAW,EAAE;AACxE,QAAI,WAAW,CAAC,aAAa,wBAAwB,KAAK,iBAAiB,eAAe;AACxF,aAAO;AACP,qBAAe;AACf,qBAAe,mBAAmB;AAClC,UAAI,CAAC,eAAgB,gBAAgB,SAAS,aAAa,YAAY,IAAI,KAAM;AAC/E,sBAAc;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AAGA,MAAI,SAAS,WAAW,SAAS,WAAW;AAC1C,UAAM,OAAO,kBAAkB,OAAO;AACtC,QAAI,QAAQ,KAAK,SAAS,IAAI;AAC5B,YAAM,MAAM,SAAS,aAAa,IAAI;AACtC,UAAI,OAAO,MAAM;AACf,eAAO;AACP,uBAAe;AAEf,cAAM,MAAM;AACZ,YAAI,QAAQ,YAAY;AACtB,yBAAe;AAAA,QACjB,WAAW,QAAQ,aAAa;AAC9B,yBAAe;AAAA,QACjB,WAAW,QAAQ,UAAU;AAC3B,yBAAe;AAAA,QACjB,WAAW,QAAQ,YAAY;AAC7B,yBAAe;AAAA,QACjB,WAAW,QAAQ,cAAc,QAAQ,WAAW;AAClD,yBAAe;AAAA,QACjB,WAAW,QAAQ,YAAY;AAC7B,yBAAe;AAAA,QACjB,OAAO;AACL,yBAAe;AAAA,QACjB;AACA,sBAAc;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AAGA,MAAI,gBAAgB,KAAK,WAAW,GAAG;AACrC,kBAAc,YACX,MAAM,IAAI,EACV,OAAO,CAAC,MAAc,CAAC,gBAAgB,KAAK,CAAC,CAAC,EAC9C,KAAK,IAAI,EACT,KAAK,KAAK;AAAA,EACf;AAGA,MAAI,YAAY,SAAS,IAAI;AAE3B,UAAM,QAAQ,YAAY,MAAM,KAAK;AACrC,QAAI,cAAc;AAClB,UAAO,UAAS,MAAM,GAAG,OAAO,GAAG,OAAO;AACxC,eAAS,IAAI,GAAG,KAAK,MAAM,SAAS,KAAK,KAAK;AAC5C,cAAM,QAAQ,MAAM,MAAM,GAAG,IAAI,GAAG,EAAE,KAAK,GAAG,EAAE,YAAY;AAC5D,YAAI,QAAQ;AACZ,iBAAS,IAAI,GAAG,KAAK,MAAM,SAAS,KAAK,KAAK;AAC5C,cAAI,MAAM,MAAM,GAAG,IAAI,GAAG,EAAE,KAAK,GAAG,EAAE,YAAY,MAAM,MAAO;AAAA,QACjE;AACA,YAAI,SAAS,GAAG;AAAE,wBAAc;AAAM,gBAAM;AAAA,QAAO;AAAA,MACrD;AAAA,IACF;AAEA,QAAI,CAAC,eAAe,kDAAkD,KAAK,WAAW,GAAG;AACvF,oBAAc;AAAA,IAChB;AAEA,QAAI,CAAC,aAAa;AAChB,YAAM,OAA+B,CAAC;AACtC,iBAAW,KAAK,OAAO;AACrB,cAAM,KAAK,EAAE,YAAY,EAAE,QAAQ,cAAc,EAAE;AACnD,YAAI,GAAG,SAAS,EAAG,MAAK,EAAE,KAAK,KAAK,EAAE,KAAK,KAAK;AAAA,MAClD;AACA,iBAAW,CAAC,EAAE,KAAK,KAAK,OAAO,QAAQ,IAAI,GAAG;AAC5C,YAAI,SAAS,KAAK,QAAQ,MAAM,SAAS,MAAM;AAAE,wBAAc;AAAM;AAAA,QAAO;AAAA,MAC9E;AAAA,IACF;AACA,QAAI,aAAa;AACf,cAAQ,KAAK,+DAA+D;AAC5E,oBAAc;AACd,aAAO;AACP,qBAAe;AACf,qBAAe;AAAA,IACjB;AAAA,EACF;AASA,MAAI;AAEJ,MAAI,aAAa,UAAU;AAEzB,kBAAc,aAAa;AAAA,EAC7B,WAAW,gBAAgB,KAAK,oBAAoB,WAAW;AAE7D,kBAAc;AAAA,EAChB,OAAO;AAEL,UAAM,cAAc,KAAK,IAAI,MAAM,UAAU,QAAQ,QAAQ;AAC7D,UAAM,YAAY,kBAAkB,OAAO,OAAO;AAClD,QAAI,eAAe,QAAQ,aAAa,cAAc,WAAW;AAE/D,UAAI,gBAAgB,aAAa,gBAAgB,aAAa,eAAe,MAAM;AACjF,sBAAc;AAAA,MAChB,OAAO;AAEL,sBAAe,eAAe,KAAK,oBAAoB,cAAe,cAAc;AAAA,MACtF;AAAA,IACF,WAAW,eAAe,KAAK,oBAAoB,WAAW;AAE5D,UAAI,gBAAgB,aAAa,gBAAgB,iBAAiB;AAChE,sBAAc;AAAA,MAChB,OAAO;AAEL,sBAAc;AAAA,MAChB;AAAA,IACF,OAAO;AAEL,oBAAc;AAAA,IAChB;AAGA,QACE,gBAAgB,aAChB,cACA,WAAW,cAAc,SAAS,KAClC,WAAW,cAAc,CAAC,EAAE,cAAc,KAC1C;AACA,oBAAc,WAAW,cAAc,CAAC,EAAE;AAAA,IAC5C;AAGA,QACE,iBAAiB,KACjB,oBAAoB,cACnB,CAAC,cAAc,WAAW,cAAc,WAAW,MACpD,gBAAgB,aAChB,cAAc,MACd;AACA,oBAAc;AAAA,IAChB;AAAA,EACF;AAGA,QAAM,WAAW,eAAe,MAAM,YAAY,CAAC,GAAG,OAAO,SAAS,CAAC;AAGvE,QAAM,gBAAgB,aAAa,aAAa,QAAQ,YAAY,aAAa;AACjF,QAAM,iBAAiB,aAAa,aAAa;AACjD,QAAM,UAAU;AAAA,IACd;AAAA,MACE,YAAY;AAAA,MACZ,iBAAiB;AAAA,MACjB,UAAU;AAAA,MACV,UAAU;AAAA,MACV,UAAU;AAAA,MACV,WAAW;AAAA,MACX,wBAAwB;AAAA,IAC1B;AAAA,IACA,EAAE,QAAQ;AAAA,EACZ;AAEA,QAAM,UAAU,MAAM,QAAQ,MAAM,OAAO,IAAI,KAAK,UAAU,CAAC;AAG/D,MAAI,gBAA2B;AAC/B,MAAI,SAAS,aAAa,cAAc;AACtC,UAAM,KACJ,gBAAgB,aAAa,WAAW;AAC1C,oBAAgB,gBAAgB,OAAO,IAAI,eAAe;AAAA,EAC5D;AAEA,SAAO;AAAA,IACL;AAAA,IACA,UAAU;AAAA,IACV,SAAS;AAAA,IACT,YAAY;AAAA,IACZ,QAAQ;AAAA,IACR,eAAe;AAAA,IACf,UAAU;AAAA,IACV,aAAa,aAAa,eAAe;AAAA,IACzC,WAAW;AAAA,IACX,UAAU;AAAA,IACV,mBAAmB;AAAA,IACnB,oBAAoB,KAAK,IAAI,IAAI;AAAA,IACjC;AAAA,IACA;AAAA,IACA,SAAS;AAAA,IACT,iBAAiB;AAAA,IACjB;AAAA,IACA,OAAO;AAAA,EACT;AACF;AAnTS;AA2TT,eAAe,eAAe,KAAU,SAAiB,SAAuB,UAAkB;AAEhG,QAAM,aAAa,cAAc,OAAO;AAExC,QAAM,YAAY,sBAAsB,SAAS,OAAO;AACxD,MAAI,kBAAkB,gBAAgB,UAAU,MAAM;AACtD,QAAM,eAAe,UAAU;AAI/B,MAAI,oBAAoB,aAAa,WAAW,cAAc,SAAS,GAAG;AACxE,UAAM,UAAU,WAAW,cAAc,CAAC;AAC1C,QAAI,QAAQ,cAAc,KAAK;AAC7B,wBAAkB,QAAQ;AAAA,IAC5B;AAAA,EACF;AAEA,QAAM,eAAe,oBAAoB,YAAY,UAAU,eAAe;AAAA,IAAO;AACrF,QAAM,UAAU,GAAG,YAAY,GAAG,OAAO;AAAA,EAAK,QAAQ,MAAM,EAAE,EAAE,IAAI,CAAC,MAAM,GAAG,EAAE,IAAI,KAAK,EAAE,OAAO,EAAE,EAAE,KAAK,IAAI,CAAC,GAAG,KAAK;AACxH,QAAM,YAAY,GAAG,OAAO;AAAA,EAAK,QAAQ,MAAM,EAAE,EAAE,IAAI,CAAC,MAAM,GAAG,EAAE,IAAI,KAAK,EAAE,OAAO,EAAE,EAAE,KAAK,IAAI,CAAC,GAAG,KAAK;AAE3G,QAAM,CAAC,OAAO,OAAO,IAAI,MAAM,QAAQ,IAAI,CAAC,UAAU,KAAK,OAAO,GAAG,UAAU,KAAK,SAAS,CAAC,CAAC;AAC/F,MAAI,CAAC,SAAS,CAAC,QAAS,QAAO;AAE/B,QAAM,CAAC,OAAO,OAAO,IAAI,MAAM,QAAQ,IAAI;AAAA,IACzC,kBAAkB,KAAK,IAAI,kBAAkB,OAAO,UAAU,iBAAiB,GAAG,UAAU;AAAA,IAC5F,kBAAkB,KAAK,IAAI,WAAW,SAAS,UAAU,iBAAiB,GAAG,KAAK;AAAA,EACpF,CAAC;AAED,MAAI,oBAAoB,aAAa,iBAAiB,GAAG;AACvD,UAAM,WAAW,yBAAyB,OAAO,OAAO;AACxD,QAAI,YAAY,aAAa,UAAW,mBAAkB;AAAA,EAC5D;AAEA,QAAM,WAAW,gBAAgB,OAAO;AACxC,QAAM,YAAsB,CAAC;AAC7B,MAAI,eAAe,EAAG,WAAU,KAAK,uBAAe,eAAe,YAAY,aAAa,QAAQ,CAAC,CAAC,GAAG;AACzG,MAAI,SAAS,OAAQ,WAAU,KAAK,YAAY,SAAS,MAAM,EAAE;AACjE,MAAI,SAAS,SAAU,WAAU,KAAK,aAAa,SAAS,QAAQ,EAAE;AACtE,MAAI,SAAS,cAAe,WAAU,KAAK,YAAY,SAAS,cAAc,MAAM,GAAG,GAAG,CAAC,GAAG;AAC9F,MAAI,SAAS,eAAgB,WAAU,KAAK,aAAa,SAAS,cAAc,EAAE;AAGlF,QAAM,WAAW,wBAAwB,UAAU;AAEnD,QAAM,gBAAgB,UAAU,SAAS,UAAU,KAAK,KAAK,IAAI,MAAM;AAEvE,QAAM,mBAAmB,sBAAsB,iBAAiB,OAAO,OAAO;AAE9E,SAAO,EAAE,iBAAiB,cAAc,OAAO,SAAS,cAAc,kBAAkB,YAAY,SAAS;AAC/G;AAlDe;AAsDf,eAAsB,aAAa,KAAc,KAAU;AACzD,QAAM,SAAS,IAAI,QAAQ,IAAI,mBAAmB;AAClD,MAAI,WAAW,IAAI,wBAAwB;AACzC,WAAO,KAAK,KAAK,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,EACjD;AAEA,QAAM,UAAU,MAAM,aAAa,GAAG;AACtC,MAAI,CAAC,QAAS,QAAO,KAAK,KAAK,EAAE,OAAO,eAAe,GAAG,GAAG;AAE7D,QAAM,OAAO,MAAM,QAAQ,IAAI;AAG/B,MAAI,SAAS,eAAe,MAAM,QAAQ,QAAQ,KAAK,GAAG;AACxD,QAAI,SAAS;AACb,QAAI,WAAW;AAEf,eAAW,QAAQ,QAAQ,OAAO;AAChC,YAAM,MAAM,MAAM,UAAU,KAAK,KAAK,IAAI;AAC1C,UAAI,CAAC,IAAK;AAEV,YAAM,QAAQ,aAAa,KAAK,SAAS,IAAI,KAAK,WAAW;AAC7D,YAAM,IAAI,YAAY,IAAI,OAAO,KAAK,UAAU,IAAI,CAAC;AACrD;AAEA,YAAM,QAAQ,GAAG,KAAK,SAAS,OAAO,KAAK,WAAW;AACtD,YAAM,IAAI,iBAAiB,OAAO;AAAA,QAChC;AAAA,UACE,IAAI;AAAA,UACJ,QAAQ;AAAA,UACR,UAAU;AAAA,YACR,WAAW,KAAK;AAAA,YAChB,MAAM;AAAA,YACN,aAAa,KAAK;AAAA,YAClB,QAAQ,KAAK;AAAA,YACb,QAAQ;AAAA,UACV;AAAA,QACF;AAAA,MACF,CAAC;AACD;AAAA,IACF;AAEA,WAAO,KAAK,KAAK,EAAE,IAAI,MAAM,QAAQ,SAAS,CAAC;AAAA,EACjD;AAGA,MAAI,SAAS,UAAU,MAAM,QAAQ,QAAQ,KAAK,GAAG;AACnD,QAAI,WAAW;AAEf,eAAW,QAAQ,QAAQ,OAAO;AAChC,YAAM,MAAM,MAAM,UAAU,KAAK,KAAK,IAAI;AAC1C,UAAI,CAAC,IAAK;AAEV,YAAM,QAAQ,GAAG,KAAK,SAAS,QAAQ,KAAK,MAAM,IAAI,KAAK,QAAQ;AACnE,YAAM,IAAI,UAAU,OAAO;AAAA,QACzB;AAAA,UACE,IAAI;AAAA,UACJ,QAAQ;AAAA,UACR,UAAU;AAAA,YACR,WAAW,KAAK;AAAA,YAChB,MAAM;AAAA,YACN,QAAQ,KAAK;AAAA,YACb,UAAU,KAAK;AAAA,YACf,QAAQ,KAAK;AAAA,YACb,MAAM,KAAK,KAAK,MAAM,GAAG,GAAG;AAAA,UAC9B;AAAA,QACF;AAAA,MACF,CAAC;AACD;AAAA,IACF;AAEA,WAAO,KAAK,KAAK,EAAE,IAAI,MAAM,SAAS,CAAC;AAAA,EACzC;AAGA,QAAM,WAAW,MAAM,QAAQ,SAAS;AAExC,MAAI,SAAS,YAAY;AACvB,UAAM,OAAO;AACb,UAAM,MAAM,MAAM,UAAU,KAAK,KAAK,IAAI;AAC1C,QAAI,CAAC,IAAK,QAAO,KAAK,KAAK,EAAE,OAAO,mBAAmB,GAAG,GAAG;AAE7D,UAAM,QAAQ,aAAa,QAAQ,IAAI,KAAK,WAAW;AACvD,UAAM,IAAI,YAAY,IAAI,OAAO,KAAK,UAAU,IAAI,CAAC;AAErD,UAAM,QAAQ,GAAG,QAAQ,OAAO,KAAK,WAAW;AAChD,UAAM,IAAI,iBAAiB,OAAO;AAAA,MAChC;AAAA,QACE,IAAI;AAAA,QACJ,QAAQ;AAAA,QACR,UAAU;AAAA,UACR,WAAW;AAAA,UACX,MAAM;AAAA,UACN,aAAa,KAAK;AAAA,UAClB,QAAQ,KAAK;AAAA,UACb,QAAQ;AAAA,QACV;AAAA,MACF;AAAA,IACF,CAAC;AAED,WAAO,KAAK,KAAK,EAAE,IAAI,MAAM,IAAI,OAAO,QAAQ,MAAM,CAAC;AAAA,EACzD;AAEA,MAAI,SAAS,OAAO;AAClB,UAAM,OAAO;AACb,UAAM,MAAM,MAAM,UAAU,KAAK,KAAK,IAAI;AAC1C,QAAI,CAAC,IAAK,QAAO,KAAK,KAAK,EAAE,OAAO,mBAAmB,GAAG,GAAG;AAE7D,UAAM,QAAQ,GAAG,QAAQ,QAAQ,KAAK,MAAM,IAAI,KAAK,QAAQ;AAC7D,UAAM,IAAI,UAAU,OAAO;AAAA,MACzB;AAAA,QACE,IAAI;AAAA,QACJ,QAAQ;AAAA,QACR,UAAU;AAAA,UACR,WAAW;AAAA,UACX,MAAM;AAAA,UACN,QAAQ,KAAK;AAAA,UACb,UAAU,KAAK;AAAA,UACf,QAAQ,KAAK;AAAA,UACb,MAAM,KAAK,KAAK,MAAM,GAAG,GAAG;AAAA,QAC9B;AAAA,MACF;AAAA,IACF,CAAC;AAED,WAAO,KAAK,KAAK,EAAE,IAAI,MAAM,IAAI,MAAM,CAAC;AAAA,EAC1C;AAEA,SAAO,KAAK,KAAK,EAAE,OAAO,eAAe,GAAG,GAAG;AACjD;AA/HsB;AAmItB,eAAsB,WAAW,KAAc,KAAU,QAAQ,OAAO;AACtE,QAAM,UAAU,MAAM,aAAa,GAAG;AACtC,MAAI,CAAC,QAAS,QAAO,SAAS,KAAK,EAAE,OAAO,eAAe,GAAG,GAAG;AAEjE,QAAM,KAAK,KAAK,IAAI;AACpB,QAAM,WAAW,MAAM,QAAQ,aAAa,YAAY;AACxD,QAAM,SAAS,WAAW,OAAO,YAAY,WAAa,QAAgB,QAAsB,SAAS;AACzG,QAAM,kBAAkB,MAAM,QAAQ,WAAW,EAAE,EAAE,KAAK;AAC1D,MAAI,UAAU;AACd,QAAM,iBAAiB,uBAAuB,SAAS,KAAK;AAC5D,YAAU,eAAe;AACzB,QAAM,UAAwB,MAAM,QAAQ,QAAQ,OAAO,IAAI,QAAQ,UAAU,CAAC;AAClF,MAAI,CAAC,SAAS;AACZ,WAAO,SAAS,KAAK,EAAE,OAAO,gBAAgB,GAAG,GAAG;AAAA,EACtD;AAGA,MAAI,eAAe,OAAO,GAAG;AAC3B,WAAO,SAAS,KAAK;AAAA,MACnB,MAAM;AAAA,MAAS,SAAS;AAAA,MAAa,UAAU;AAAA,MAC/C,aAAa;AAAA,MAAY,WAAW;AAAA,MAAQ,UAAU;AAAA,MACtD,mBAAmB,eAAe,OAAO;AAAA,MAAG,YAAY;AAAA,MACxD,QAAQ;AAAA,MACR,eAAe;AAAA,MAAM,UAAU;AAAA,MAAO,UAAU,CAAC;AAAA,MACjD,SAAS,EAAE,YAAY,GAAG,UAAU,OAAO,UAAU,WAAW,WAAW,QAAQ,wBAAwB,MAAM;AAAA,MACjH,oBAAoB,KAAK,IAAI,IAAI;AAAA,IACnC,CAAC;AAAA,EACH;AAEA,MAAI,aAAa,OAAO,GAAG;AACzB,WAAO,SAAS,KAAK;AAAA,MACnB,MAAM;AAAA,MAAS,SAAS;AAAA,MAAa,UAAU;AAAA,MAC/C,aAAa;AAAA,MAAY,WAAW;AAAA,MAAa,UAAU;AAAA,MAC3D,mBAAmB,eAAe,OAAO;AAAA,MAAG,YAAY;AAAA,MACxD,QAAQ;AAAA,MACR,eAAe;AAAA,MAAM,UAAU;AAAA,MAAO,UAAU,CAAC;AAAA,MACjD,SAAS,EAAE,YAAY,GAAG,UAAU,OAAO,UAAU,WAAW,WAAW,aAAa,wBAAwB,MAAM;AAAA,MACtH,oBAAoB,KAAK,IAAI,IAAI;AAAA,IACnC,CAAC;AAAA,EACH;AAGA,QAAM,MAAM,MAAM,eAAe,KAAK,SAAS,SAAS,QAAQ;AAChE,MAAI,CAAC,IAAK,QAAO,SAAS,KAAK,EAAE,OAAO,mBAAmB,GAAG,GAAG;AAEjE,QAAM,EAAE,iBAAiB,cAAc,OAAO,SAAS,cAAc,kBAAkB,kBAAkB,YAAY,SAAS,IAAI;AAGlI,QAAM,eAAe,yBAAyB,SAAS,eAAe;AACtE,QAAM,eAAe,mBAAmB;AAGxC,MAAI,OAAO;AACT,WAAO,KAAK,KAAK;AAAA,MACf,OAAO;AAAA,MAAM;AAAA,MAAU;AAAA,MAAiB;AAAA,MACxC,YAAY;AAAA,QACV,iBAAiB,WAAW;AAAA,QAC5B,eAAe,WAAW;AAAA,QAC1B,SAAS,WAAW;AAAA,QACpB,WAAW,WAAW;AAAA,QACtB,eAAe,WAAW;AAAA,MAC5B;AAAA,MACA,WAAW;AAAA,QACT,OAAO,MAAM,MAAM;AAAA,QACnB,UAAU,MAAM,SAAS,QAAQ,CAAC;AAAA,QAClC,UAAU,MAAM,SAAS,QAAQ,CAAC;AAAA,QAClC,OAAO,MAAM,MAAM,IAAI,CAAC,OAAO,EAAE,IAAI,EAAE,IAAI,OAAO,EAAE,MAAM,QAAQ,CAAC,GAAG,QAAQ,EAAE,OAAO,EAAE;AAAA,MAC3F;AAAA,MACA,MAAM;AAAA,QACJ,OAAO,QAAQ,MAAM;AAAA,QACrB,UAAU,QAAQ,SAAS,QAAQ,CAAC;AAAA,QACpC,UAAU,QAAQ,SAAS,QAAQ,CAAC;AAAA,QACpC,OAAO,QAAQ,QAAQ,MAAM,GAAG,CAAC,EAAE,IAAI,CAAC,OAAY;AAAA,UAClD,IAAI,EAAE;AAAA,UACN,QAAQ,EAAE,QAAQ,KAAK,QAAQ,CAAC,IAAI;AAAA,UACpC,QAAQ,EAAE,UAAU;AAAA,QACtB,EAAE;AAAA,MACJ;AAAA,IACF,CAAC;AAAA,EACH;AAGA,QAAM,YAAY,QAAQ,OAAO,CAAC,MAAM,EAAE,SAAS,MAAM,EAAE;AAE3D,QAAM,gBAAgB,WAAW,QAAQ,SAAS,IAAI,WAAW,QAAQ,YAAY;AAGrF,QAAM,OAAO,MAAM,kBAAkB,KAAK,SAAS,SAAS,kBAAkB,cAAc,KAAK;AAAA,IAC/F;AAAA,IACA,WAAW;AAAA,EACb,CAAC;AAGD,QAAM,SAAS,oBAAoB;AAAA,IACjC;AAAA,IAAM;AAAA,IAAS;AAAA,IAAiB;AAAA,IAAiB;AAAA,IACjD;AAAA,IAAO;AAAA,IAAS;AAAA,IAAO;AAAA,IAAI;AAAA,IAAY;AAAA,IAAS;AAAA,EAClD,CAAC;AAED,SAAO,SAAS,KAAK,MAAM;AAC7B;AAnGsB;AAuGtB,eAAsB,iBAAiB,KAAc,KAAU;AAC7D,QAAM,UAAU,MAAM,aAAa,GAAG;AACtC,MAAI,CAAC,SAAS;AACZ,WAAO,IAAI,SAAS,sCAAsC;AAAA,MACxD,QAAQ;AAAA,MACR,SAAS,EAAE,gBAAgB,qBAAqB,GAAG,YAAY,GAAG,EAAE;AAAA,IACtE,CAAC;AAAA,EACH;AAEA,QAAM,KAAK,KAAK,IAAI;AACpB,QAAM,WAAW,MAAM,QAAQ,aAAa,YAAY;AACxD,QAAM,SAAS,WAAW,OAAO,YAAY,WAAa,QAAgB,QAAsB,SAAS;AACzG,QAAM,kBAAkB,MAAM,QAAQ,WAAW,EAAE,EAAE,KAAK;AAC1D,MAAI,UAAU;AACd,QAAM,iBAAiB,uBAAuB,SAAS,KAAK;AAC5D,YAAU,eAAe;AACzB,QAAM,UAAwB,MAAM,QAAQ,QAAQ,OAAO,IAAI,QAAQ,UAAU,CAAC;AAElF,MAAI,CAAC,SAAS;AACZ,WAAO,IAAI,SAAS,uCAAuC;AAAA,MACzD,QAAQ;AAAA,MACR,SAAS,EAAE,gBAAgB,qBAAqB,GAAG,YAAY,GAAG,EAAE;AAAA,IACtE,CAAC;AAAA,EACH;AAGA,MAAI,eAAe,OAAO,KAAK,aAAa,OAAO,GAAG;AACpD,UAAM,OAAO,eAAe,OAAO,IAC/B,yBAAyB;AAAA,MACvB,MAAM;AAAA,MAAS,SAAS;AAAA,MAAa,UAAU;AAAA,MAC/C,aAAa;AAAA,MAAY,WAAW;AAAA,MAAQ,UAAU;AAAA,MACtD,mBAAmB,eAAe,OAAO;AAAA,MAAG,YAAY;AAAA,MACxD,QAAQ;AAAA,MACR,UAAU;AAAA,MAAO,UAAU,CAAC;AAAA,MAAG,oBAAoB,KAAK,IAAI,IAAI;AAAA,IAClE,CAAC,IACD,yBAAyB;AAAA,MACvB,MAAM;AAAA,MAAS,SAAS;AAAA,MAAa,UAAU;AAAA,MAC/C,aAAa;AAAA,MAAY,WAAW;AAAA,MAAa,UAAU;AAAA,MAC3D,mBAAmB,eAAe,OAAO;AAAA,MAAG,YAAY;AAAA,MACxD,QAAQ;AAAA,MACR,UAAU;AAAA,MAAO,UAAU,CAAC;AAAA,MAAG,oBAAoB,KAAK,IAAI,IAAI;AAAA,IAClE,CAAC;AACL,UAAM,OAAO;AAAA,QAAsB,KAAK,UAAU,IAAI,CAAC;AAAA;AAAA;AACvD,WAAO,IAAI,SAAS,MAAM;AAAA,MACxB,SAAS,EAAE,gBAAgB,qBAAqB,iBAAiB,YAAY,GAAG,YAAY,GAAG,EAAE;AAAA,IACnG,CAAC;AAAA,EACH;AAGA,QAAM,MAAM,MAAM,eAAe,KAAK,SAAS,SAAS,QAAQ;AAChE,MAAI,CAAC,KAAK;AACR,WAAO,IAAI,SAAS,uDAAuD;AAAA,MACzE,QAAQ;AAAA,MACR,SAAS,EAAE,gBAAgB,qBAAqB,GAAG,YAAY,GAAG,EAAE;AAAA,IACtE,CAAC;AAAA,EACH;AAEA,QAAM,EAAE,iBAAiB,cAAc,OAAO,SAAS,cAAc,iBAAiB,kBAAkB,YAAY,SAAS,IAAI;AAGjI,QAAM,qBAAqB,yBAAyB,SAAS,eAAe;AAC5E,QAAM,eAAe,kBAAkB;AAGvC,QAAM,YAAY,QAAQ,OAAO,CAAC,MAAM,EAAE,SAAS,MAAM,EAAE;AAC3D,QAAM,kBAAkB,WAAW,QAAQ,SAAS,IAAI,WAAW,QAAQ,YAAY;AAGvF,QAAM,WAAW,iBAAiB,SAAS,SAAS,kBAAkB,cAAc,EAAE,WAAW,WAAW,gBAAgB,CAAC;AAG7H,QAAM,UAAU,IAAI,YAAY;AAChC,QAAM,EAAE,UAAU,SAAS,IAAI,IAAI,gBAAgB;AACnD,QAAM,SAAS,SAAS,UAAU;AAGlC,GAAC,YAAY;AACX,QAAI,cAAc;AAClB,QAAI;AACF,YAAM,SAAU,MAAM,IAAI,GAAG,IAAI,YAAmB;AAAA,QAClD;AAAA,QACA,YAAY;AAAA,QACZ,aAAa;AAAA,QACb,QAAQ;AAAA,MACV,CAAC;AAED,YAAM,SAAS,OAAO,UAAU;AAChC,YAAM,UAAU,IAAI,YAAY;AAEhC,aAAO,MAAM;AACX,cAAM,EAAE,MAAM,MAAM,IAAI,MAAM,OAAO,KAAK;AAC1C,YAAI,KAAM;AACV,cAAM,QAAQ,OAAO,UAAU,WAAW,QAAQ,QAAQ,OAAO,OAAO,EAAE,QAAQ,KAAK,CAAC;AAExF,cAAM,QAAQ,MAAM,MAAM,IAAI;AAC9B,mBAAW,QAAQ,OAAO;AACxB,cAAI,CAAC,KAAK,WAAW,QAAQ,EAAG;AAChC,gBAAM,aAAa,KAAK,MAAM,CAAC,EAAE,KAAK;AACtC,cAAI,eAAe,SAAU;AAC7B,cAAI;AACF,kBAAM,SAAS,KAAK,MAAM,UAAU;AACpC,kBAAM,QAAQ,OAAO,YAAY;AACjC,gBAAI,OAAO;AACT,6BAAe;AACf,oBAAM,OAAO,MAAM,QAAQ,OAAO;AAAA,QAAuB,KAAK,UAAU,EAAE,GAAG,MAAM,CAAC,CAAC;AAAA;AAAA,CAAM,CAAC;AAAA,YAC9F;AAAA,UACF,QAAQ;AAAA,UAER;AAAA,QACF;AAAA,MACF;AAAA,IACF,SAAS,GAAQ;AACf,cAAQ,MAAM,iBAAiB,CAAC;AAAA,IAClC;AAGA,QAAI,CAAC,YAAY,WAAW,GAAG,EAAG,eAAc,MAAM;AACtD,QAAI,OAAY,CAAC;AACjB,QAAI;AACF,YAAM,YAAY,YAAY,MAAM,aAAa;AACjD,UAAI,UAAW,QAAO,KAAK,MAAM,UAAU,CAAC,CAAC;AAAA,IAC/C,QAAQ;AACN,UAAI;AACF,YAAI,YAAY,YAAY,QAAQ,gCAAgC,EAAE;AACtE,YAAI,CAAC,UAAU,SAAS,GAAG,EAAG,cAAa;AAC3C,eAAO,KAAK,MAAM,SAAS;AAAA,MAC7B,QAAQ;AACN,cAAM,cAAc,YAAY,MAAM,oCAAoC;AAC1E,YAAI,aAAa;AACf,iBAAO,EAAE,QAAQ,YAAY,CAAC,EAAE,QAAQ,QAAQ,GAAG,EAAE,QAAQ,QAAQ,IAAI,GAAG,SAAS,YAAY;AAAA,QACnG;AAAA,MACF;AAAA,IACF;AAGA,UAAM,SAAS,oBAAoB;AAAA,MACjC;AAAA,MAAM;AAAA,MAAS;AAAA,MAAiB;AAAA,MAAiB;AAAA,MACjD;AAAA,MAAO;AAAA,MAAS;AAAA,MAAO;AAAA,MAAI;AAAA,MAAY;AAAA,MAAS;AAAA,IAClD,CAAC;AAED,UAAM,cAAc,yBAAyB,MAAM;AACnD,UAAM,OAAO,MAAM,QAAQ,OAAO;AAAA,QAAsB,KAAK,UAAU,WAAW,CAAC;AAAA;AAAA,CAAM,CAAC;AAC1F,UAAM,OAAO,MAAM;AAAA,EACrB,GAAG;AAEH,SAAO,IAAI,SAAS,UAAU;AAAA,IAC5B,SAAS;AAAA,MACP,gBAAgB;AAAA,MAChB,iBAAiB;AAAA,MACjB,cAAc;AAAA,MACd,GAAG,YAAY,GAAG;AAAA,IACpB;AAAA,EACF,CAAC;AACH;AAzJsB;;;ACnwBtB,IAAM,uBAAuB;AAC7B,IAAM,iBAAiB;AAEvB,IAAM,YAAY,oBAAI,IAAgD;AAEtE,SAAS,eAAe,IAAqD;AAC3E,QAAM,MAAM,KAAK,IAAI;AACrB,MAAI,SAAS,UAAU,IAAI,EAAE;AAE7B,MAAI,CAAC,UAAU,OAAO,OAAO,SAAS;AACpC,aAAS,EAAE,OAAO,GAAG,SAAS,MAAM,qBAAqB;AACzD,cAAU,IAAI,IAAI,MAAM;AAAA,EAC1B;AAEA,SAAO;AAGP,MAAI,UAAU,OAAO,KAAK;AACxB,eAAW,CAAC,KAAK,CAAC,KAAK,WAAW;AAChC,UAAI,OAAO,EAAE,QAAS,WAAU,OAAO,GAAG;AAAA,IAC5C;AAAA,EACF;AAEA,SAAO;AAAA,IACL,SAAS,OAAO,SAAS;AAAA,IACzB,WAAW,KAAK,IAAI,GAAG,iBAAiB,OAAO,KAAK;AAAA,EACtD;AACF;AAtBS;AA0BT,IAAO,gBAAQ;AAAA,EACb,MAAM,MAAM,KAAc,KAAU;AAClC,UAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAI,IAAI,WAAW,UAAW,QAAO,UAAU,GAAG;AAGlD,QAAI,IAAI,aAAa,WAAW;AAC9B,aAAO,KAAK,KAAK;AAAA,QACf,IAAI;AAAA,QACJ,SAAS;AAAA,QACT,QAAQ,EAAE,MAAM,YAAY,OAAO,YAAY;AAAA,QAC/C,UAAU;AAAA,UACR,IAAI,CAAC,CAAC,IAAI;AAAA,UACV,SAAS,CAAC,CAAC,IAAI;AAAA,UACf,WAAW,CAAC,CAAC,IAAI;AAAA,UACjB,IAAI,CAAC,CAAC,IAAI;AAAA,QACZ;AAAA,MACF,CAAC;AAAA,IACH;AAGA,QAAI,IAAI,aAAa,mBAAmB,IAAI,WAAW,QAAQ;AAC7D,UAAI;AACF,eAAO,MAAM,aAAa,KAAK,GAAG;AAAA,MACpC,SAAS,GAAQ;AACf,eAAO,KAAK,KAAK,EAAE,OAAO,oBAAoB,SAAS,MAAM,GAAG,WAAW,CAAC,EAAE,GAAG,GAAG;AAAA,MACtF;AAAA,IACF;AAGA,QAAI,IAAI,aAAa,WAAW,IAAI,aAAa,gBAAgB;AAE/D,YAAM,WAAW,IAAI,QAAQ,IAAI,kBAAkB,KAAK,IAAI,QAAQ,IAAI,iBAAiB,KAAK;AAC9F,YAAM,YAAY,eAAe,QAAQ;AACzC,UAAI,CAAC,UAAU,SAAS;AACtB,eAAO,KAAK,KAAK;AAAA,UACf,OAAO;AAAA,UACP,SAAS;AAAA,UACT,qBAAqB;AAAA,QACvB,GAAG,GAAG;AAAA,MACR;AAAA,IACF;AAGA,QAAI,IAAI,aAAa,SAAS;AAC5B,YAAM,QAAQ,IAAI,aAAa,IAAI,OAAO,MAAM;AAChD,UAAI;AACF,eAAO,MAAM,WAAW,KAAK,KAAK,KAAK;AAAA,MACzC,SAAS,GAAQ;AACf,gBAAQ,MAAM,mBAAmB,GAAG,WAAW,CAAC;AAChD,eAAO,KAAK,KAAK,EAAE,OAAO,kBAAkB,SAAS,MAAM,GAAG,WAAW,CAAC,EAAE,GAAG,GAAG;AAAA,MACpF;AAAA,IACF;AAGA,QAAI,IAAI,aAAa,gBAAgB;AACnC,UAAI;AACF,eAAO,MAAM,iBAAiB,KAAK,GAAG;AAAA,MACxC,SAAS,GAAQ;AACf,gBAAQ,MAAM,qBAAqB,GAAG,WAAW,CAAC;AAClD,eAAO,IAAI;AAAA,UACT;AAAA,QAAsB,KAAK,UAAU,EAAE,OAAO,oBAAoB,SAAS,MAAM,GAAG,WAAW,CAAC,EAAE,CAAC,CAAC;AAAA;AAAA;AAAA,UACpG,EAAE,QAAQ,KAAK,SAAS,EAAE,gBAAgB,qBAAqB,GAAG,YAAY,GAAG,EAAE,EAAE;AAAA,QACvF;AAAA,MACF;AAAA,IACF;AAEA,WAAO,KAAK,KAAK,aAAa,GAAG;AAAA,EACnC;AACF;",
  "names": ["text"]
}
