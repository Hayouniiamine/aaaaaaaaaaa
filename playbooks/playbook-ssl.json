{
  "id": "playbook-ssl",
  "scope": "settings",
  "title": "SSL ‚Äî HTTPS / certificat / erreurs s√©curit√©",
  "triggers": [
    "525",
    "526",
    "cadenas",
    "certificat",
    "certificate",
    "err_ssl",
    "https",
    "https ne marche pas",
    "invalid certificate",
    "mixed content",
    "net::err_cert",
    "not secure",
    "site s√©curis√©",
    "ssl"
  ],
  "steps": [
    {
      "kind": "ask",
      "question": "Quel est le domaine exact et l'erreur pr√©cise (ex: NET::ERR_CERT..., ERR_SSL_PROTOCOL_ERROR, 525/526, 'Non s√©curis√©') ? Cloudflare activ√© (oui/non) ?",
      "step_id": "ASK_01_QUEL_EST_LE_DOMAIN_2E6D27",
      "field": "domain_or_url"
    },
    {
      "kind": "solve",
      "response": "SSL avec TikTak PRO - Fonctionnement :\n‚Ä¢ Domaines achet√©s chez TikTak : SSL automatique inclus (pas de config)\n‚Ä¢ Domaines li√©s externes : SSL √©mis automatiquement APR√àS propagation DNS compl√®te\n‚Ä¢ D√©lai normal : 24-48h apr√®s DNS correctement configur√©s\n‚Ä¢ G√©r√© par TikTak (pas d'acc√®s serveur pour clients)\n\n‚úÖ Pr√©requis SSL :\n1. DNS correctement configur√©s (@ et www ‚Üí 102.211.211.10)\n2. Pas d'enregistrement AAAA actif\n3. Propagation compl√®te (visible sur WhatsMyDNS)\n4. Liaison activ√©e dans TikTak si domaine externe\n\nDepuis combien de temps le domaine est-il configur√©/achet√© ? (<24h ou >24h)",
      "actions": [
        "verify_ssl_prerequisites"
      ],
      "success_indicator": "Cadenas affich√© dans la barre navigateur, https:// fonctionne",
      "time_estimate": "√âmission SSL : automatique dans les 24-48h apr√®s DNS OK",
      "step_id": "SOLVE_02_SSL_AVEC_TIKTAK_PR_5AC379"
    },
    {
      "kind": "solve",
      "response": "Erreur 525/526 avec Cloudflare :\n‚ö†Ô∏è Ces erreurs indiquent un probl√®me SSL entre Cloudflare et le serveur TikTak\n\nüîß SOLUTION IMM√âDIATE :\n\n1Ô∏è‚É£ D√©sactivez TEMPORAIREMENT le proxy Cloudflare :\n   ‚Ä¢ Dans Cloudflare DNS ‚Üí cliquez nuage orange pour le rendre GRIS (DNS only)\n   ‚Ä¢ Faites-le pour @ ET www\n\n2Ô∏è‚É£ V√©rifiez DNS Cloudflare :\n   @ : A ‚Üí 102.211.211.10\n   www : A ‚Üí 102.211.211.10 (ou CNAME ‚Üí @)\n   AAAA : AUCUN\n\n3Ô∏è‚É£ Testez le site en DNS only (gris) :\n   ‚Ä¢ Si √ßa fonctionne ‚Üí attendez 24-48h que le SSL TikTak soit √©mis\n   ‚Ä¢ Puis r√©activez le proxy orange\n\n4Ô∏è‚É£ Configuration SSL Cloudflare (une fois proxy r√©activ√©) :\n   ‚Ä¢ SSL/TLS ‚Üí Overview ‚Üí SSL mode\n   ‚Ä¢ Choisissez 'Flexible' ou 'Full' (PAS 'Full Strict')\n   ‚Ä¢ 'Full Strict' n√©cessite un certificat valid√© c√¥t√© serveur\n\n5Ô∏è‚É£ Si erreur persiste en gris (DNS only) :\n   ‚Ä¢ V√©rifiez que DNS sont exacts\n   ‚Ä¢ Escaladez le cas\n\nLe proxy est-il actuellement orange ou gris ? Le site fonctionne-t-il en gris ?",
      "actions": [
        "cloudflare_ssl_check",
        "disable_cloudflare_proxy",
        "configure_ssl_mode"
      ],
      "success_indicator": "Site fonctionne en DNS only, puis avec proxy orange apr√®s config SSL correcte",
      "condition": "cloudflare_525_526_error",
      "step_id": "SOLVE_03_ERREUR_525_526_AVE_C7DB7C"
    },
    {
      "kind": "solve",
      "response": "Certificat invalide / NET::ERR_CERT_... :\n\nüîç DIAGNOSTIC :\n\n1Ô∏è‚É£ V√©rifiez l'URL exacte :\n   ‚Ä¢ HTTPS:// pr√©sent ?\n   ‚Ä¢ Domaine exact (sans faute de frappe) ?\n   ‚Ä¢ Test sur @ (domaine.com) ET www (www.domaine.com)\n\n2Ô∏è‚É£ V√©rifiez DNS (pr√©requis SSL) :\n   ‚Ä¢ @ : A ‚Üí 102.211.211.10\n   ‚Ä¢ www : A ‚Üí 102.211.211.10 (ou CNAME ‚Üí @)\n   ‚Ä¢ AAAA : AUCUN\n   ‚Ä¢ Test propagation : https://www.whatsmydns.net\n\n3Ô∏è‚É£ Videz les caches SSL :\n   CHROME :\n   ‚Ä¢ chrome://net-internals/#sockets ‚Üí Flush socket pools\n   ‚Ä¢ chrome://net-internals/#hsts ‚Üí Delete domain security policies (entrez domaine)\n   ‚Ä¢ Param√®tres ‚Üí Confidentialit√© ‚Üí Effacer donn√©es navigation ‚Üí Cochez tout\n   \n   FIREFOX :\n   ‚Ä¢ Options ‚Üí Vie priv√©e ‚Üí Effacer historique ‚Üí Tout\n   \n   SYST√àME :\n   ‚Ä¢ Windows : ipconfig /flushdns dans CMD\n   ‚Ä¢ Mac : sudo dscacheutil -flushcache dans Terminal\n\n4Ô∏è‚É£ Test navigation priv√©e + autre appareil/r√©seau\n\n5Ô∏è‚É£ V√©rifiez que la page TikTak s'affiche :\n   ‚Ä¢ Page TikTak visible = DNS OK, SSL en cours d'√©mission\n   ‚Ä¢ Rien = DNS incorrect\n\nQuel navigateur ? Le domaine affiche-t-il la page TikTak (logo) ? Quel code ERR exact ?",
      "actions": [
        "verify_dns_for_ssl",
        "clear_ssl_cache",
        "test_ssl_different_device"
      ],
      "success_indicator": "Certificat reconnu valide, cadenas vert affich√©",
      "common_errors": [
        "NET::ERR_CERT_AUTHORITY_INVALID ‚Üí certificat en cours d'√©mission ou DNS incorrect",
        "NET::ERR_CERT_COMMON_NAME_INVALID ‚Üí domaine ne correspond pas au certificat (typo URL ?)",
        "NET::ERR_CERT_DATE_INVALID ‚Üí date syst√®me incorrecte ou certificat expir√©/pas encore valide"
      ],
      "step_id": "SOLVE_04_CERTIFICAT_INVALID_F1EE06"
    },
    {
      "kind": "solve",
      "response": "Mixed Content (contenu mixte HTTP/HTTPS) :\n‚ö†Ô∏è Erreur : page HTTPS charge des ressources HTTP (images, scripts, CSS)\n\nüîß SOLUTIONS :\n\n1Ô∏è‚É£ Dans l'√©diteur de contenu TikTak :\n   ‚Ä¢ V√©rifiez toutes les URLs d'images/ressources\n   ‚Ä¢ Remplacez http:// par https://\n   ‚Ä¢ Ou utilisez URLs relatives (//exemple.com/image.jpg)\n\n2Ô∏è‚É£ Console navigateur (F12) :\n   ‚Ä¢ Onglet Console ‚Üí cherchez warnings 'Mixed Content'\n   ‚Ä¢ Notez les URLs HTTP √† corriger\n\n3Ô∏è‚É£ Templates/Widgets :\n   ‚Ä¢ Si le template charge des ressources externes\n   ‚Ä¢ V√©rifiez qu'elles sont en HTTPS\n   ‚Ä¢ Contactez support si template par d√©faut\n\n4Ô∏è‚É£ Force HTTPS :\n   ‚Ä¢ Dans param√®tres (si option disponible)\n   ‚Ä¢ Ou via Cloudflare : SSL/TLS ‚Üí Edge Certificates ‚Üí Always Use HTTPS\n\nVoyez-vous un cadenas barr√© ou message 'Non s√©curis√©' ? Pouvez-vous copier les erreurs de la console (F12) ?",
      "actions": [
        "fix_mixed_content",
        "check_browser_console",
        "force_https"
      ],
      "success_indicator": "Cadenas plein (pas barr√©), aucun warning mixed content",
      "step_id": "SOLVE_05_MIXED_CONTENT_CONT_4E2A36"
    },
    {
      "kind": "solve",
      "response": "SSL fonctionne sur @ mais pas sur www (ou inverse) :\n\nüîç CAUSE : Enregistrement DNS manquant ou certificat incomplet\n\n‚úÖ SOLUTIONS :\n\n1Ô∏è‚É£ V√©rifiez DNS pour les DEUX :\n   @ : A ‚Üí 102.211.211.10\n   www : A ‚Üí 102.211.211.10 (ou CNAME ‚Üí @)\n\n2Ô∏è‚É£ Test s√©par√© :\n   ‚Ä¢ https://domaine.com\n   ‚Ä¢ https://www.domaine.com\n   ‚Ä¢ Notez lequel fonctionne\n\n3Ô∏è‚É£ Ajoutez l'enregistrement manquant puis attendez propagation (2-24h)\n\n4Ô∏è‚É£ Le SSL TikTak couvrira automatiquement @ ET www une fois DNS complets\n\nLequel fonctionne (@ ou www) ? L'autre affiche quelle erreur exactement ?",
      "actions": [
        "verify_both_apex_www",
        "add_missing_dns_record"
      ],
      "success_indicator": "SSL actif sur @ ET www",
      "time_estimate": "24-48h apr√®s ajout DNS manquant",
      "step_id": "SOLVE_06_SSL_FONCTIONNE_SUR_3CB34D"
    },
    {
      "kind": "escalate",
      "reason": "SSL non √©mis apr√®s 48h avec DNS corrects et propag√©s, OU erreur SSL persistante apr√®s toutes v√©rifications, OU Cloudflare 525/526 persistant en DNS only",
      "required_info": [
        "Domaine exact",
        "Capture √©cran erreur SSL compl√®te (avec code ERR)",
        "Captures DNS (@, www, AAAA, NS) depuis registraire",
        "R√©sultat WhatsMyDNS (capture ou lien)",
        "Cloudflare oui/non, si oui : proxy orange/gris, mode SSL",
        "Navigateur + version",
        "Date de configuration DNS / achat domaine",
        "Ce qui s'affiche exactement sur chaque version (http://, https://, @, www)"
      ],
      "step_id": "ESCALATE_07_ESCALATE_C1F230",
      "when": [
        "needs_human_review"
      ],
      "handoff_template": {
        "summary": "SSL non √©mis apr√®s 48h avec DNS corrects et propag√©s, OU erreur SSL persistante apr√®s toutes v√©rifications, OU Cloudflare 525/526 persistant en DNS only",
        "repro_steps": [],
        "evidence": [
          "Domaine exact",
          "Capture √©cran erreur SSL compl√®te (avec code ERR)",
          "Captures DNS (@, www, AAAA, NS) depuis registraire",
          "R√©sultat WhatsMyDNS (capture ou lien)",
          "Cloudflare oui/non, si oui : proxy orange/gris, mode SSL",
          "Navigateur + version",
          "Date de configuration DNS / achat domaine",
          "Ce qui s'affiche exactement sur chaque version (http://, https://, @, www)"
        ],
        "suspected_component": "settings",
        "priority": "P2"
      }
    },
    {
      "kind": "verify",
      "question": "Apr√®s ces √©tapes, est-ce que √ßa a march√© ? Si non, envoyez une capture + le message exact.",
      "step_id": "VERIFY_08_APR_S_CES_TAPES_ES_02B92D"
    },
    {
      "kind": "escalate",
      "question": "Pour escalader : domaine + capture erreur SSL + captures DNS + r√©sultat WhatsMyDNS + Cloudflare (oui/non, orange/gris, mode SSL) + navigateur + date config + ce qui s'affiche.",
      "escalation_payload_keys": [
        "module",
        "summary",
        "steps_tried",
        "evidence",
        "impact"
      ],
      "step_id": "ESCALATE_09_POUR_ESCALADER_DOM_70B8D4",
      "when": [
        "needs_human_review"
      ],
      "handoff_template": {
        "summary": "Escalade requise pour SSL ‚Äî HTTPS / certificat / erreurs s√©curit√©",
        "repro_steps": [],
        "evidence": [
          "domain_or_url",
          "error_message",
          "dns_change_time",
          "screenshot"
        ],
        "suspected_component": "settings",
        "priority": "P2"
      }
    }
  ],
  "related_docs": [
    "Certificat SSL g√©r√© par TikTak pour domaines li√©s/achet√©s",
    "√âmission automatique apr√®s DNS propag√©s",
    "Pas d'acc√®s serveur c√¥t√© client (SaaS h√©berg√©)"
  ],
  "ssl_checklist": {
    "prerequisites": [
      "DNS @ ‚Üí 102.211.211.10",
      "DNS www ‚Üí 102.211.211.10",
      "Aucun AAAA actif",
      "Propagation compl√®te (v√©rifier WhatsMyDNS)",
      "Liaison activ√©e dans TikTak (domaines externes)"
    ],
    "verification_steps": [
      "Test https://domaine.com ‚Üí fonctionne ?",
      "Test https://www.domaine.com ‚Üí fonctionne ?",
      "Cadenas affich√© dans navigateur ?",
      "Console (F12) ‚Üí aucune erreur mixed content ?",
      "Navigation priv√©e ‚Üí m√™me r√©sultat ?"
    ],
    "troubleshooting_tools": [
      "https://www.ssllabs.com/ssltest/ - test certificat",
      "https://www.whatsmydns.net - propagation DNS",
      "Console navigateur (F12) - erreurs SSL et mixed content"
    ]
  },
  "common_errors_details": [
    {
      "error": "525 (SSL Handshake Failed)",
      "meaning": "Cloudflare ne peut pas √©tablir connexion SSL avec serveur origine",
      "solution": "Proxy gris (DNS only) temporairement, attendre SSL TikTak actif, puis orange avec mode Flexible/Full"
    },
    {
      "error": "526 (Invalid SSL Certificate)",
      "meaning": "Certificat serveur origine invalide selon Cloudflare",
      "solution": "Proxy gris, mode SSL 'Flexible' ou 'Full' (pas Full Strict)"
    },
    {
      "error": "NET::ERR_CERT_AUTHORITY_INVALID",
      "meaning": "Certificat non reconnu par navigateur",
      "solution": "Attendre √©mission compl√®te (24-48h), v√©rifier DNS, vider cache SSL"
    },
    {
      "error": "NET::ERR_CERT_COMMON_NAME_INVALID",
      "meaning": "Domaine URL ne correspond pas au certificat",
      "solution": "V√©rifier URL exacte (typo ?), attendre couverture @ et www"
    }
  ],
  "time_expectations": {
    "ssl_issuance": "24-48h apr√®s DNS propag√©s",
    "cache_ssl_clearing": "Imm√©diat apr√®s flush",
    "cloudflare_propagation": "Quelques minutes apr√®s changement proxy/mode SSL"
  },
  "cloudflare_ssl_modes": {
    "off": "Pas de SSL (non recommand√©)",
    "flexible": "Cloudflare ‚Üî Client : HTTPS, Cloudflare ‚Üî Serveur : HTTP (OK pour TikTak en attente SSL)",
    "full": "HTTPS partout mais certificat serveur non valid√© (OK pour TikTak)",
    "full_strict": "HTTPS partout + certificat serveur valid√© (NE PAS UTILISER avant SSL TikTak actif)",
    "recommended": "Flexible ou Full pendant √©mission SSL, puis Full apr√®s"
  },
  "canonical_scope": "domains",
  "required_fields": [
    {
      "key": "domain_or_url",
      "question": "Quel est le domaine ou l‚ÄôURL exact ?"
    },
    {
      "key": "error_message",
      "question": "Quel est le message d‚Äôerreur exact (ou code) ?"
    },
    {
      "key": "dns_change_time",
      "question": "Quand avez-vous chang√© les DNS / nameservers (date/heure) ?"
    }
  ],
  "schema_version": "v2_deterministic_steps"
}